/**
 * Copyright 2021 The AMP HTML Authors. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS-IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { devAssert } from "./core/assert";
import { Deferred } from "./core/data-structures/promise";

/** @const {string} */
export var UPGRADE_TO_CUSTOMELEMENT_PROMISE = '__AMP_UPG_PRM';

/** @const {string} */
export var UPGRADE_TO_CUSTOMELEMENT_RESOLVER = '__AMP_UPG_RES';

/**
 * Determines if this element is an AMP element
 * @param {!Element} element
 * @return {boolean}
 */
export function isAmpElement(element) {
  var tag = element.tagName;
  // Use prefix to recognize AMP element. This is necessary because stub
  // may not be attached yet.
  return tag.startsWith('AMP-') && // Some "amp-*" elements are not really AMP elements. :smh:
  !(tag == 'AMP-STICKY-AD-TOP-PADDING' || tag == 'AMP-BODY');
}

/**
 * Return a promise that resolve when an AMP element upgrade from HTMLElement
 * to CustomElement
 * @param {!HTMLElement} element
 * @return {!Promise<!AmpElement>}
 */
export function whenUpgradedToCustomElement(element) {
  devAssert(isAmpElement(element), 'element is not AmpElement');

  if (element.createdCallback) {
    // Element already is CustomElement;
    return Promise.resolve(
    /**@type {!AmpElement} */
    element);
  }

  // If Element is still HTMLElement, wait for it to upgrade to customElement
  // Note: use pure string to avoid obfuscation between versions.
  if (!element[UPGRADE_TO_CUSTOMELEMENT_PROMISE]) {
    var deferred = new Deferred();
    element[UPGRADE_TO_CUSTOMELEMENT_PROMISE] = deferred.promise;
    element[UPGRADE_TO_CUSTOMELEMENT_RESOLVER] = deferred.resolve;
  }

  return element[UPGRADE_TO_CUSTOMELEMENT_PROMISE];
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFtcC1lbGVtZW50LWhlbHBlcnMuanMiXSwibmFtZXMiOlsiZGV2QXNzZXJ0IiwiRGVmZXJyZWQiLCJVUEdSQURFX1RPX0NVU1RPTUVMRU1FTlRfUFJPTUlTRSIsIlVQR1JBREVfVE9fQ1VTVE9NRUxFTUVOVF9SRVNPTFZFUiIsImlzQW1wRWxlbWVudCIsImVsZW1lbnQiLCJ0YWciLCJ0YWdOYW1lIiwic3RhcnRzV2l0aCIsIndoZW5VcGdyYWRlZFRvQ3VzdG9tRWxlbWVudCIsImNyZWF0ZWRDYWxsYmFjayIsIlByb21pc2UiLCJyZXNvbHZlIiwiZGVmZXJyZWQiLCJwcm9taXNlIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFRQSxTQUFSO0FBQ0EsU0FBUUMsUUFBUjs7QUFFQTtBQUNBLE9BQU8sSUFBTUMsZ0NBQWdDLEdBQUcsZUFBekM7O0FBRVA7QUFDQSxPQUFPLElBQU1DLGlDQUFpQyxHQUFHLGVBQTFDOztBQUVQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPLFNBQVNDLFlBQVQsQ0FBc0JDLE9BQXRCLEVBQStCO0FBQ3BDLE1BQU1DLEdBQUcsR0FBR0QsT0FBTyxDQUFDRSxPQUFwQjtBQUNBO0FBQ0E7QUFDQSxTQUNFRCxHQUFHLENBQUNFLFVBQUosQ0FBZSxNQUFmLEtBQ0E7QUFDQSxJQUFFRixHQUFHLElBQUksMkJBQVAsSUFBc0NBLEdBQUcsSUFBSSxVQUEvQyxDQUhGO0FBS0Q7O0FBRUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTyxTQUFTRywyQkFBVCxDQUFxQ0osT0FBckMsRUFBOEM7QUFDbkRMLEVBQUFBLFNBQVMsQ0FBQ0ksWUFBWSxDQUFDQyxPQUFELENBQWIsRUFBd0IsMkJBQXhCLENBQVQ7O0FBQ0EsTUFBSUEsT0FBTyxDQUFDSyxlQUFaLEVBQTZCO0FBQzNCO0FBQ0EsV0FBT0MsT0FBTyxDQUFDQyxPQUFSO0FBQWdCO0FBQTJCUCxJQUFBQSxPQUEzQyxDQUFQO0FBQ0Q7O0FBQ0Q7QUFDQTtBQUNBLE1BQUksQ0FBQ0EsT0FBTyxDQUFDSCxnQ0FBRCxDQUFaLEVBQWdEO0FBQzlDLFFBQU1XLFFBQVEsR0FBRyxJQUFJWixRQUFKLEVBQWpCO0FBQ0FJLElBQUFBLE9BQU8sQ0FBQ0gsZ0NBQUQsQ0FBUCxHQUE0Q1csUUFBUSxDQUFDQyxPQUFyRDtBQUNBVCxJQUFBQSxPQUFPLENBQUNGLGlDQUFELENBQVAsR0FBNkNVLFFBQVEsQ0FBQ0QsT0FBdEQ7QUFDRDs7QUFFRCxTQUFPUCxPQUFPLENBQUNILGdDQUFELENBQWQ7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IDIwMjEgVGhlIEFNUCBIVE1MIEF1dGhvcnMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUy1JU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuaW1wb3J0IHtkZXZBc3NlcnR9IGZyb20gJy4vY29yZS9hc3NlcnQnO1xuaW1wb3J0IHtEZWZlcnJlZH0gZnJvbSAnLi9jb3JlL2RhdGEtc3RydWN0dXJlcy9wcm9taXNlJztcblxuLyoqIEBjb25zdCB7c3RyaW5nfSAqL1xuZXhwb3J0IGNvbnN0IFVQR1JBREVfVE9fQ1VTVE9NRUxFTUVOVF9QUk9NSVNFID0gJ19fQU1QX1VQR19QUk0nO1xuXG4vKiogQGNvbnN0IHtzdHJpbmd9ICovXG5leHBvcnQgY29uc3QgVVBHUkFERV9UT19DVVNUT01FTEVNRU5UX1JFU09MVkVSID0gJ19fQU1QX1VQR19SRVMnO1xuXG4vKipcbiAqIERldGVybWluZXMgaWYgdGhpcyBlbGVtZW50IGlzIGFuIEFNUCBlbGVtZW50XG4gKiBAcGFyYW0geyFFbGVtZW50fSBlbGVtZW50XG4gKiBAcmV0dXJuIHtib29sZWFufVxuICovXG5leHBvcnQgZnVuY3Rpb24gaXNBbXBFbGVtZW50KGVsZW1lbnQpIHtcbiAgY29uc3QgdGFnID0gZWxlbWVudC50YWdOYW1lO1xuICAvLyBVc2UgcHJlZml4IHRvIHJlY29nbml6ZSBBTVAgZWxlbWVudC4gVGhpcyBpcyBuZWNlc3NhcnkgYmVjYXVzZSBzdHViXG4gIC8vIG1heSBub3QgYmUgYXR0YWNoZWQgeWV0LlxuICByZXR1cm4gKFxuICAgIHRhZy5zdGFydHNXaXRoKCdBTVAtJykgJiZcbiAgICAvLyBTb21lIFwiYW1wLSpcIiBlbGVtZW50cyBhcmUgbm90IHJlYWxseSBBTVAgZWxlbWVudHMuIDpzbWg6XG4gICAgISh0YWcgPT0gJ0FNUC1TVElDS1ktQUQtVE9QLVBBRERJTkcnIHx8IHRhZyA9PSAnQU1QLUJPRFknKVxuICApO1xufVxuXG4vKipcbiAqIFJldHVybiBhIHByb21pc2UgdGhhdCByZXNvbHZlIHdoZW4gYW4gQU1QIGVsZW1lbnQgdXBncmFkZSBmcm9tIEhUTUxFbGVtZW50XG4gKiB0byBDdXN0b21FbGVtZW50XG4gKiBAcGFyYW0geyFIVE1MRWxlbWVudH0gZWxlbWVudFxuICogQHJldHVybiB7IVByb21pc2U8IUFtcEVsZW1lbnQ+fVxuICovXG5leHBvcnQgZnVuY3Rpb24gd2hlblVwZ3JhZGVkVG9DdXN0b21FbGVtZW50KGVsZW1lbnQpIHtcbiAgZGV2QXNzZXJ0KGlzQW1wRWxlbWVudChlbGVtZW50KSwgJ2VsZW1lbnQgaXMgbm90IEFtcEVsZW1lbnQnKTtcbiAgaWYgKGVsZW1lbnQuY3JlYXRlZENhbGxiYWNrKSB7XG4gICAgLy8gRWxlbWVudCBhbHJlYWR5IGlzIEN1c3RvbUVsZW1lbnQ7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgvKipAdHlwZSB7IUFtcEVsZW1lbnR9ICovIChlbGVtZW50KSk7XG4gIH1cbiAgLy8gSWYgRWxlbWVudCBpcyBzdGlsbCBIVE1MRWxlbWVudCwgd2FpdCBmb3IgaXQgdG8gdXBncmFkZSB0byBjdXN0b21FbGVtZW50XG4gIC8vIE5vdGU6IHVzZSBwdXJlIHN0cmluZyB0byBhdm9pZCBvYmZ1c2NhdGlvbiBiZXR3ZWVuIHZlcnNpb25zLlxuICBpZiAoIWVsZW1lbnRbVVBHUkFERV9UT19DVVNUT01FTEVNRU5UX1BST01JU0VdKSB7XG4gICAgY29uc3QgZGVmZXJyZWQgPSBuZXcgRGVmZXJyZWQoKTtcbiAgICBlbGVtZW50W1VQR1JBREVfVE9fQ1VTVE9NRUxFTUVOVF9QUk9NSVNFXSA9IGRlZmVycmVkLnByb21pc2U7XG4gICAgZWxlbWVudFtVUEdSQURFX1RPX0NVU1RPTUVMRU1FTlRfUkVTT0xWRVJdID0gZGVmZXJyZWQucmVzb2x2ZTtcbiAgfVxuXG4gIHJldHVybiBlbGVtZW50W1VQR1JBREVfVE9fQ1VTVE9NRUxFTUVOVF9QUk9NSVNFXTtcbn1cbiJdfQ==
// /Users/mszylkowski/src/amphtml/src/amp-element-helpers.js