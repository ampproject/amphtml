/**
 * Copyright 2016 The AMP HTML Authors. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS-IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { ActionTrust } from "./core/constants/action-constants";
import { dev, user, userAssert } from "./log";
import { Services } from "./service";
import { SOURCE_ORIGIN_PARAM, assertHttpsUrl, checkCorsUrl, isProxyOrigin } from "./url";

/**
 * @param {!./service/ampdoc-impl.AmpDoc} ampdoc
 * @return {!Promise}
 */
export function installGlobalSubmitListenerForDoc(ampdoc) {
  // Register global submit event listener only if the amp-form
  // extension is used. Allowing the usage of native forms, otherwise.
  return ampdoc.whenExtensionsKnown().then(function () {
    if (ampdoc.declaresExtension('amp-form')) {
      ampdoc.getRootNode().addEventListener('submit', onDocumentFormSubmit_, true);
    }
  });
}

/**
 * Intercept any submit on the current document and prevent invalid submits from
 * going through.
 *
 * @param {!Event} e
 */
export function onDocumentFormSubmit_(e) {
  if (e.defaultPrevented) {
    return;
  }

  var form = dev().assertElement(e.target);

  if (!form || form.tagName != 'FORM') {
    return;
  }

  // amp-form extension will add novalidate to all forms to manually trigger
  // validation. In that case `novalidate` doesn't have the same meaning.
  var isAmpFormMarked = form.classList.contains('i-amphtml-form');
  var shouldValidate;

  if (isAmpFormMarked) {
    shouldValidate = !form.hasAttribute('amp-novalidate');
  } else {
    shouldValidate = !form.hasAttribute('novalidate');
  }

  // Safari does not trigger validation check on submission, hence we
  // trigger it manually. In other browsers this would never execute since
  // the submit event wouldn't be fired if the form is invalid.
  if (shouldValidate && form.checkValidity && !form.checkValidity()) {
    e.preventDefault();
  }

  var inputs = form.elements;

  for (var i = 0; i < inputs.length; i++) {
    userAssert(!inputs[i].name || inputs[i].name != SOURCE_ORIGIN_PARAM, 'Illegal input name, %s found: %s', SOURCE_ORIGIN_PARAM, inputs[i]);
  }

  var action = form.getAttribute('action');
  var actionXhr = form.getAttribute('action-xhr');
  var method = (form.getAttribute('method') || 'GET').toUpperCase();

  if (actionXhr) {
    assertHttpsUrl(actionXhr, form, 'action-xhr');
    userAssert(!isProxyOrigin(actionXhr), 'form action-xhr should not be on AMP CDN: %s', form);
    checkCorsUrl(actionXhr);
  }

  if (action) {
    assertHttpsUrl(action, form, 'action');
    userAssert(!isProxyOrigin(action), 'form action should not be on AMP CDN: %s', form);
    checkCorsUrl(action);
  }

  if (method == 'GET') {
    userAssert(actionXhr || action, 'form action-xhr or action attribute is required for method=GET: %s', form);
  } else if (method == 'POST') {
    if (action) {
      var TAG = 'form';
      user().error(TAG, 'action attribute is invalid for method=POST: %s', form);
    }

    if (!actionXhr) {
      e.preventDefault();
      userAssert(false, 'Only XHR based (via action-xhr attribute) submissions are support ' + 'for POST requests. %s', form);
    }
  }

  var target = form.getAttribute('target');

  if (target) {
    userAssert(target == '_blank' || target == '_top', 'form target=%s is invalid can only be _blank or _top: %s', target, form);
  } else {
    form.setAttribute('target', '_top');
  }

  // For xhr submissions relay the submission event through action service to
  // allow us to wait for amp-form (and possibly its dependencies) to execute
  // the actual submission. For non-XHR GET we let the submission go through
  // to allow _blank target to work.
  if (actionXhr) {
    e.preventDefault();
    // It's important to stop propagation of the submission to avoid double
    // handling of the event in cases were we are delegating to action service
    // to deliver the submission event.
    e.stopImmediatePropagation();
    var actions = Services.actionServiceForDoc(form);
    actions.execute(form, 'submit',
    /*args*/
    null,
    /*source*/
    form,
    /*caller*/
    form, e, ActionTrust.HIGH);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRvY3VtZW50LXN1Ym1pdC5qcyJdLCJuYW1lcyI6WyJBY3Rpb25UcnVzdCIsImRldiIsInVzZXIiLCJ1c2VyQXNzZXJ0IiwiU2VydmljZXMiLCJTT1VSQ0VfT1JJR0lOX1BBUkFNIiwiYXNzZXJ0SHR0cHNVcmwiLCJjaGVja0NvcnNVcmwiLCJpc1Byb3h5T3JpZ2luIiwiaW5zdGFsbEdsb2JhbFN1Ym1pdExpc3RlbmVyRm9yRG9jIiwiYW1wZG9jIiwid2hlbkV4dGVuc2lvbnNLbm93biIsInRoZW4iLCJkZWNsYXJlc0V4dGVuc2lvbiIsImdldFJvb3ROb2RlIiwiYWRkRXZlbnRMaXN0ZW5lciIsIm9uRG9jdW1lbnRGb3JtU3VibWl0XyIsImUiLCJkZWZhdWx0UHJldmVudGVkIiwiZm9ybSIsImFzc2VydEVsZW1lbnQiLCJ0YXJnZXQiLCJ0YWdOYW1lIiwiaXNBbXBGb3JtTWFya2VkIiwiY2xhc3NMaXN0IiwiY29udGFpbnMiLCJzaG91bGRWYWxpZGF0ZSIsImhhc0F0dHJpYnV0ZSIsImNoZWNrVmFsaWRpdHkiLCJwcmV2ZW50RGVmYXVsdCIsImlucHV0cyIsImVsZW1lbnRzIiwiaSIsImxlbmd0aCIsIm5hbWUiLCJhY3Rpb24iLCJnZXRBdHRyaWJ1dGUiLCJhY3Rpb25YaHIiLCJtZXRob2QiLCJ0b1VwcGVyQ2FzZSIsIlRBRyIsImVycm9yIiwic2V0QXR0cmlidXRlIiwic3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uIiwiYWN0aW9ucyIsImFjdGlvblNlcnZpY2VGb3JEb2MiLCJleGVjdXRlIiwiSElHSCJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBRUEsU0FBUUEsV0FBUjtBQUNBLFNBQVFDLEdBQVIsRUFBYUMsSUFBYixFQUFtQkMsVUFBbkI7QUFDQSxTQUFRQyxRQUFSO0FBQ0EsU0FDRUMsbUJBREYsRUFFRUMsY0FGRixFQUdFQyxZQUhG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RSxPQUFSLENBQ0UzQixJQURGLEVBRUUsUUFGRjtBQUdFO0FBQVMsUUFIWDtBQUlFO0FBQVdBLElBQUFBLElBSmI7QUFLRTtBQUFXQSxJQUFBQSxJQUxiLEVBTUVGLENBTkYsRUFPRWpCLFdBQVcsQ0FBQytDLElBUGQ7QUFTRDtBQUNGIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgMjAxNiBUaGUgQU1QIEhUTUwgQXV0aG9ycy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTLUlTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7QWN0aW9uVHJ1c3R9IGZyb20gJy4vY29yZS9jb25zdGFudHMvYWN0aW9uLWNvbnN0YW50cyc7XG5pbXBvcnQge2RldiwgdXNlciwgdXNlckFzc2VydH0gZnJvbSAnLi9sb2cnO1xuaW1wb3J0IHtTZXJ2aWNlc30gZnJvbSAnLi9zZXJ2aWNlJztcbmltcG9ydCB7XG4gIFNPVVJDRV9PUklHSU5fUEFSQU0sXG4gIGFzc2VydEh0dHBzVXJsLFxuICBjaGVja0NvcnNVcmwsXG4gIGlzUHJveHlPcmlnaW4sXG59IGZyb20gJy4vdXJsJztcblxuLyoqXG4gKiBAcGFyYW0geyEuL3NlcnZpY2UvYW1wZG9jLWltcGwuQW1wRG9jfSBhbXBkb2NcbiAqIEByZXR1cm4geyFQcm9taXNlfVxuICovXG5leHBvcnQgZnVuY3Rpb24gaW5zdGFsbEdsb2JhbFN1Ym1pdExpc3RlbmVyRm9yRG9jKGFtcGRvYykge1xuICAvLyBSZWdpc3RlciBnbG9iYWwgc3VibWl0IGV2ZW50IGxpc3RlbmVyIG9ubHkgaWYgdGhlIGFtcC1mb3JtXG4gIC8vIGV4dGVuc2lvbiBpcyB1c2VkLiBBbGxvd2luZyB0aGUgdXNhZ2Ugb2YgbmF0aXZlIGZvcm1zLCBvdGhlcndpc2UuXG4gIHJldHVybiBhbXBkb2Mud2hlbkV4dGVuc2lvbnNLbm93bigpLnRoZW4oKCkgPT4ge1xuICAgIGlmIChhbXBkb2MuZGVjbGFyZXNFeHRlbnNpb24oJ2FtcC1mb3JtJykpIHtcbiAgICAgIGFtcGRvY1xuICAgICAgICAuZ2V0Um9vdE5vZGUoKVxuICAgICAgICAuYWRkRXZlbnRMaXN0ZW5lcignc3VibWl0Jywgb25Eb2N1bWVudEZvcm1TdWJtaXRfLCB0cnVlKTtcbiAgICB9XG4gIH0pO1xufVxuXG4vKipcbiAqIEludGVyY2VwdCBhbnkgc3VibWl0IG9uIHRoZSBjdXJyZW50IGRvY3VtZW50IGFuZCBwcmV2ZW50IGludmFsaWQgc3VibWl0cyBmcm9tXG4gKiBnb2luZyB0aHJvdWdoLlxuICpcbiAqIEBwYXJhbSB7IUV2ZW50fSBlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBvbkRvY3VtZW50Rm9ybVN1Ym1pdF8oZSkge1xuICBpZiAoZS5kZWZhdWx0UHJldmVudGVkKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgZm9ybSA9IGRldigpLmFzc2VydEVsZW1lbnQoZS50YXJnZXQpO1xuICBpZiAoIWZvcm0gfHwgZm9ybS50YWdOYW1lICE9ICdGT1JNJykge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIC8vIGFtcC1mb3JtIGV4dGVuc2lvbiB3aWxsIGFkZCBub3ZhbGlkYXRlIHRvIGFsbCBmb3JtcyB0byBtYW51YWxseSB0cmlnZ2VyXG4gIC8vIHZhbGlkYXRpb24uIEluIHRoYXQgY2FzZSBgbm92YWxpZGF0ZWAgZG9lc24ndCBoYXZlIHRoZSBzYW1lIG1lYW5pbmcuXG4gIGNvbnN0IGlzQW1wRm9ybU1hcmtlZCA9IGZvcm0uY2xhc3NMaXN0LmNvbnRhaW5zKCdpLWFtcGh0bWwtZm9ybScpO1xuICBsZXQgc2hvdWxkVmFsaWRhdGU7XG4gIGlmIChpc0FtcEZvcm1NYXJrZWQpIHtcbiAgICBzaG91bGRWYWxpZGF0ZSA9ICFmb3JtLmhhc0F0dHJpYnV0ZSgnYW1wLW5vdmFsaWRhdGUnKTtcbiAgfSBlbHNlIHtcbiAgICBzaG91bGRWYWxpZGF0ZSA9ICFmb3JtLmhhc0F0dHJpYnV0ZSgnbm92YWxpZGF0ZScpO1xuICB9XG5cbiAgLy8gU2FmYXJpIGRvZXMgbm90IHRyaWdnZXIgdmFsaWRhdGlvbiBjaGVjayBvbiBzdWJtaXNzaW9uLCBoZW5jZSB3ZVxuICAvLyB0cmlnZ2VyIGl0IG1hbnVhbGx5LiBJbiBvdGhlciBicm93c2VycyB0aGlzIHdvdWxkIG5ldmVyIGV4ZWN1dGUgc2luY2VcbiAgLy8gdGhlIHN1Ym1pdCBldmVudCB3b3VsZG4ndCBiZSBmaXJlZCBpZiB0aGUgZm9ybSBpcyBpbnZhbGlkLlxuICBpZiAoc2hvdWxkVmFsaWRhdGUgJiYgZm9ybS5jaGVja1ZhbGlkaXR5ICYmICFmb3JtLmNoZWNrVmFsaWRpdHkoKSkge1xuICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgfVxuXG4gIGNvbnN0IGlucHV0cyA9IGZvcm0uZWxlbWVudHM7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgaW5wdXRzLmxlbmd0aDsgaSsrKSB7XG4gICAgdXNlckFzc2VydChcbiAgICAgICFpbnB1dHNbaV0ubmFtZSB8fCBpbnB1dHNbaV0ubmFtZSAhPSBTT1VSQ0VfT1JJR0lOX1BBUkFNLFxuICAgICAgJ0lsbGVnYWwgaW5wdXQgbmFtZSwgJXMgZm91bmQ6ICVzJyxcbiAgICAgIFNPVVJDRV9PUklHSU5fUEFSQU0sXG4gICAgICBpbnB1dHNbaV1cbiAgICApO1xuICB9XG5cbiAgY29uc3QgYWN0aW9uID0gZm9ybS5nZXRBdHRyaWJ1dGUoJ2FjdGlvbicpO1xuICBjb25zdCBhY3Rpb25YaHIgPSBmb3JtLmdldEF0dHJpYnV0ZSgnYWN0aW9uLXhocicpO1xuICBjb25zdCBtZXRob2QgPSAoZm9ybS5nZXRBdHRyaWJ1dGUoJ21ldGhvZCcpIHx8ICdHRVQnKS50b1VwcGVyQ2FzZSgpO1xuXG4gIGlmIChhY3Rpb25YaHIpIHtcbiAgICBhc3NlcnRIdHRwc1VybChhY3Rpb25YaHIsIGZvcm0sICdhY3Rpb24teGhyJyk7XG4gICAgdXNlckFzc2VydChcbiAgICAgICFpc1Byb3h5T3JpZ2luKGFjdGlvblhociksXG4gICAgICAnZm9ybSBhY3Rpb24teGhyIHNob3VsZCBub3QgYmUgb24gQU1QIENETjogJXMnLFxuICAgICAgZm9ybVxuICAgICk7XG4gICAgY2hlY2tDb3JzVXJsKGFjdGlvblhocik7XG4gIH1cbiAgaWYgKGFjdGlvbikge1xuICAgIGFzc2VydEh0dHBzVXJsKGFjdGlvbiwgZm9ybSwgJ2FjdGlvbicpO1xuICAgIHVzZXJBc3NlcnQoXG4gICAgICAhaXNQcm94eU9yaWdpbihhY3Rpb24pLFxuICAgICAgJ2Zvcm0gYWN0aW9uIHNob3VsZCBub3QgYmUgb24gQU1QIENETjogJXMnLFxuICAgICAgZm9ybVxuICAgICk7XG4gICAgY2hlY2tDb3JzVXJsKGFjdGlvbik7XG4gIH1cblxuICBpZiAobWV0aG9kID09ICdHRVQnKSB7XG4gICAgdXNlckFzc2VydChcbiAgICAgIGFjdGlvblhociB8fCBhY3Rpb24sXG4gICAgICAnZm9ybSBhY3Rpb24teGhyIG9yIGFjdGlvbiBhdHRyaWJ1dGUgaXMgcmVxdWlyZWQgZm9yIG1ldGhvZD1HRVQ6ICVzJyxcbiAgICAgIGZvcm1cbiAgICApO1xuICB9IGVsc2UgaWYgKG1ldGhvZCA9PSAnUE9TVCcpIHtcbiAgICBpZiAoYWN0aW9uKSB7XG4gICAgICBjb25zdCBUQUcgPSAnZm9ybSc7XG4gICAgICB1c2VyKCkuZXJyb3IoXG4gICAgICAgIFRBRyxcbiAgICAgICAgJ2FjdGlvbiBhdHRyaWJ1dGUgaXMgaW52YWxpZCBmb3IgbWV0aG9kPVBPU1Q6ICVzJyxcbiAgICAgICAgZm9ybVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoIWFjdGlvblhocikge1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgdXNlckFzc2VydChcbiAgICAgICAgZmFsc2UsXG4gICAgICAgICdPbmx5IFhIUiBiYXNlZCAodmlhIGFjdGlvbi14aHIgYXR0cmlidXRlKSBzdWJtaXNzaW9ucyBhcmUgc3VwcG9ydCAnICtcbiAgICAgICAgICAnZm9yIFBPU1QgcmVxdWVzdHMuICVzJyxcbiAgICAgICAgZm9ybVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBjb25zdCB0YXJnZXQgPSBmb3JtLmdldEF0dHJpYnV0ZSgndGFyZ2V0Jyk7XG4gIGlmICh0YXJnZXQpIHtcbiAgICB1c2VyQXNzZXJ0KFxuICAgICAgdGFyZ2V0ID09ICdfYmxhbmsnIHx8IHRhcmdldCA9PSAnX3RvcCcsXG4gICAgICAnZm9ybSB0YXJnZXQ9JXMgaXMgaW52YWxpZCBjYW4gb25seSBiZSBfYmxhbmsgb3IgX3RvcDogJXMnLFxuICAgICAgdGFyZ2V0LFxuICAgICAgZm9ybVxuICAgICk7XG4gIH0gZWxzZSB7XG4gICAgZm9ybS5zZXRBdHRyaWJ1dGUoJ3RhcmdldCcsICdfdG9wJyk7XG4gIH1cblxuICAvLyBGb3IgeGhyIHN1Ym1pc3Npb25zIHJlbGF5IHRoZSBzdWJtaXNzaW9uIGV2ZW50IHRocm91Z2ggYWN0aW9uIHNlcnZpY2UgdG9cbiAgLy8gYWxsb3cgdXMgdG8gd2FpdCBmb3IgYW1wLWZvcm0gKGFuZCBwb3NzaWJseSBpdHMgZGVwZW5kZW5jaWVzKSB0byBleGVjdXRlXG4gIC8vIHRoZSBhY3R1YWwgc3VibWlzc2lvbi4gRm9yIG5vbi1YSFIgR0VUIHdlIGxldCB0aGUgc3VibWlzc2lvbiBnbyB0aHJvdWdoXG4gIC8vIHRvIGFsbG93IF9ibGFuayB0YXJnZXQgdG8gd29yay5cbiAgaWYgKGFjdGlvblhocikge1xuICAgIGUucHJldmVudERlZmF1bHQoKTtcblxuICAgIC8vIEl0J3MgaW1wb3J0YW50IHRvIHN0b3AgcHJvcGFnYXRpb24gb2YgdGhlIHN1Ym1pc3Npb24gdG8gYXZvaWQgZG91YmxlXG4gICAgLy8gaGFuZGxpbmcgb2YgdGhlIGV2ZW50IGluIGNhc2VzIHdlcmUgd2UgYXJlIGRlbGVnYXRpbmcgdG8gYWN0aW9uIHNlcnZpY2VcbiAgICAvLyB0byBkZWxpdmVyIHRoZSBzdWJtaXNzaW9uIGV2ZW50LlxuICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7XG5cbiAgICBjb25zdCBhY3Rpb25zID0gU2VydmljZXMuYWN0aW9uU2VydmljZUZvckRvYyhmb3JtKTtcbiAgICBhY3Rpb25zLmV4ZWN1dGUoXG4gICAgICBmb3JtLFxuICAgICAgJ3N1Ym1pdCcsXG4gICAgICAvKmFyZ3MqLyBudWxsLFxuICAgICAgLypzb3VyY2UqLyBmb3JtLFxuICAgICAgLypjYWxsZXIqLyBmb3JtLFxuICAgICAgZSxcbiAgICAgIEFjdGlvblRydXN0LkhJR0hcbiAgICApO1xuICB9XG59XG4iXX0=
// /Users/mszylkowski/src/amphtml/src/document-submit.js