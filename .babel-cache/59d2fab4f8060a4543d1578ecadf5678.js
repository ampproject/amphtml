/**
 * Copyright 2016 The AMP HTML Authors. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS-IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { ShadowCSS } from "../third_party/webcomponentsjs/ShadowCSS";
import { iterateCursor } from "./core/dom";
import { escapeCssSelectorIdent } from "./core/dom/css-selectors";
import { setInitialDisplay, setStyle } from "./core/dom/style";
import { ShadowDomVersion, getShadowDomSupportedVersion, isShadowCssSupported } from "./core/dom/web-components";
import { toArray } from "./core/types/array";
import { toWin } from "./core/window";
import { dev, devAssert } from "./log";
import { Services } from "./service";
import { installCssTransformer } from "./style-installer";
import { DomWriterBulk, DomWriterStreamer } from "./utils/dom-writer";

/** @const {!RegExp} */
var CSS_SELECTOR_BEG_REGEX = /[^\.\-\_0-9a-zA-Z]/;

/** @const {!RegExp} */
var CSS_SELECTOR_END_REGEX = /[^\-\_0-9a-zA-Z]/;
var SHADOW_CSS_CACHE = '__AMP_SHADOW_CSS';

/**
 * @type {boolean|undefined}
 */
var shadowDomStreamingSupported;

/**
 * Creates a shadow root for the specified host and returns it. Polyfills
 * shadow root creation if necessary.
 * @param {!Element} hostElement
 * @return {!ShadowRoot}
 */
export function createShadowRoot(hostElement) {
  var win = toWin(hostElement.ownerDocument.defaultView);
  var existingRoot = hostElement.shadowRoot || hostElement.__AMP_SHADOW_ROOT;

  if (existingRoot) {
    existingRoot.
    /*OK*/
    innerHTML = '';
    return existingRoot;
  }

  var shadowRoot;
  var shadowDomSupported = getShadowDomSupportedVersion();

  if (shadowDomSupported == ShadowDomVersion.V1) {
    shadowRoot = hostElement.attachShadow({
      mode: 'open'
    });

    if (!shadowRoot.styleSheets) {
      Object.defineProperty(shadowRoot, 'styleSheets', {
        get: function get() {
          var items = [];
          iterateCursor(shadowRoot.childNodes, function (child) {
            if (child.tagName === 'STYLE') {
              items.push(child.sheet);
            }
          });
          return items;
        }
      });
    }
  } else if (shadowDomSupported == ShadowDomVersion.V0) {
    shadowRoot = hostElement.createShadowRoot();
  } else {
    shadowRoot = createShadowRootPolyfill(hostElement);
  }

  if (!isShadowCssSupported()) {
    var rootId = "i-amphtml-sd-" + win.Math.floor(win.Math.random() * 10000);
    shadowRoot['id'] = rootId;
    shadowRoot.host.classList.add(rootId);
    // CSS isolation.
    installCssTransformer(shadowRoot, function (css) {
      return transformShadowCss(shadowRoot, css);
    });
  }

  return shadowRoot;
}

/**
 * Shadow root polyfill.
 * @param {!Element} hostElement
 * @return {!ShadowRoot}
 */
function createShadowRootPolyfill(hostElement) {
  var doc = hostElement.ownerDocument;
  // Host CSS polyfill.
  hostElement.classList.add('i-amphtml-shadow-host-polyfill');
  var hostStyle = doc.createElement('style');
  hostStyle.textContent = '.i-amphtml-shadow-host-polyfill>:not(i-amphtml-shadow-root)' + '{display:none!important}';
  hostElement.appendChild(hostStyle);
  // Shadow root.
  var shadowRoot
  /** @type {!ShadowRoot} */
  = // Cast to ShadowRoot even though it is an Element
  // TODO(@dvoytenko) Consider to switch to a type union instead.

  /** @type {?}  */
  doc.createElement('i-amphtml-shadow-root');
  hostElement.appendChild(shadowRoot);
  hostElement.__AMP_SHADOW_ROOT = shadowRoot;
  Object.defineProperty(hostElement, 'shadowRoot', {
    enumerable: true,
    configurable: true,
    value: shadowRoot
  });
  // API: https://www.w3.org/TR/shadow-dom/#the-shadowroot-interface
  shadowRoot.host = hostElement;

  // `getElementById` is resolved via `querySelector('#id')`.
  shadowRoot.getElementById = function (id) {
    var escapedId = escapeCssSelectorIdent(id);
    return (
      /** @type {?HTMLElement} */
      shadowRoot.
      /*OK*/
      querySelector("#" + escapedId)
    );
  };

  // The styleSheets property should have a list of local styles.
  Object.defineProperty(shadowRoot, 'styleSheets', {
    get: function get() {
      if (!doc.styleSheets) {
        return [];
      }

      return toArray(doc.styleSheets).filter(function (styleSheet) {
        return shadowRoot.contains(styleSheet.ownerNode);
      });
    }
  });
  return shadowRoot;
}

/**
 * Imports a body into a shadow root with the workaround for a polyfill case.
 * @param {!ShadowRoot} shadowRoot
 * @param {!Element} body
 * @param {boolean} deep
 * @return {!Element}
 */
export function importShadowBody(shadowRoot, body, deep) {
  var doc = shadowRoot.ownerDocument;
  var resultBody;

  if (isShadowCssSupported()) {
    resultBody = dev().assertElement(doc.importNode(body, deep));
  } else {
    resultBody = doc.createElement('amp-body');
    setInitialDisplay(resultBody, 'block');

    for (var i = 0; i < body.attributes.length; i++) {
      resultBody.setAttribute(body.attributes[0].name, body.attributes[0].value);
    }

    if (deep) {
      for (var n = body.firstChild; !!n; n = n.nextSibling) {
        resultBody.appendChild(doc.importNode(n, true));
      }
    }
  }

  setStyle(resultBody, 'position', 'relative');
  var oldBody = shadowRoot['body'];

  if (oldBody) {
    shadowRoot.removeChild(oldBody);
  }

  shadowRoot.appendChild(resultBody);
  Object.defineProperty(shadowRoot, 'body', {
    configurable: true,
    value: resultBody
  });
  return resultBody;
}

/**
 * If necessary, transforms CSS to isolate AMP CSS within the shaodw root and
 * reduce the possibility of high-level conflicts.
 * @param {!ShadowRoot} shadowRoot
 * @param {string} css
 * @return {string}
 */
export function transformShadowCss(shadowRoot, css) {
  return scopeShadowCss(shadowRoot, css);
}

/**
 * Transforms CSS to isolate AMP CSS within the shadow root and reduce the
 * possibility of high-level conflicts. There are two types of transformations:
 * 1. Root transformation: `body` -> `amp-body`, etc.
 * 2. Scoping: `a {}` -> `.i-amphtml-sd-123 a {}`.
 *
 * @param {!ShadowRoot} shadowRoot
 * @param {string} css
 * @return {string}
 * @visibleForTesting
 */
export function scopeShadowCss(shadowRoot, css) {
  var id = devAssert(shadowRoot['id']);
  var doc = shadowRoot.ownerDocument;
  var rules = null;

  // Try to use a separate document.
  try {
    rules = getStylesheetRules(doc.implementation.createHTMLDocument(''), css);
  } catch (e) {// Ignore.
  }

  // Try to use the current document.
  if (!rules) {
    try {
      rules = getStylesheetRules(doc, css);
    } catch (e) {// Ignore.
    }
  }

  // No rules could be parsed - return css as is.
  if (!rules) {
    return css;
  }

  // Patch selectors.
  // Invoke `ShadowCSS.scopeRules` via `call` because the way it uses `this`
  // internally conflicts with Closure compiler's advanced optimizations.
  var scopeRules = ShadowCSS.scopeRules;
  return scopeRules.call(ShadowCSS, rules, "." + id, transformRootSelectors);
}

/**
 * Replaces top-level selectors such as `html` and `body` with their polyfill
 * counterparts: `amp-html` and `amp-body`.
 * @param {string} selector
 * @return {string}
 */
function transformRootSelectors(selector) {
  return selector.replace(/(html|body)/g, rootSelectorPrefixer);
}

/**
 * See `transformRootSelectors`.
 * @param {string} match
 * @param {string} name
 * @param {number} pos
 * @param {string} selector
 * @return {string}
 * @private
 */
function rootSelectorPrefixer(match, name, pos, selector) {
  var prev = selector.charAt(pos - 1);
  var next = selector.charAt(pos + match.length);

  if ((!prev || CSS_SELECTOR_BEG_REGEX.test(prev)) && (!next || CSS_SELECTOR_END_REGEX.test(next))) {
    return 'amp-' + match;
  }

  return match;
}

/**
 * @param {!Document} doc
 * @param {string} css
 * @return {?CSSRuleList}
 */
function getStylesheetRules(doc, css) {
  var style =
  /** @type {!HTMLStyleElement} */
  doc.createElement('style');
  style.
  /*OK*/
  textContent = css;

  try {
    (doc.head || doc.documentElement).appendChild(style);

    if (style.sheet) {
      return (
        /** @type {!CSSStyleSheet} */
        style.sheet.cssRules
      );
    }

    return null;
  } finally {
    if (style.parentNode) {
      style.parentNode.removeChild(style);
    }
  }
}

/**
 * @param {!ShadowRoot} shadowRoot
 * @param {string} name
 * @param {string} cssText
 */
export function installShadowStyle(shadowRoot, name, cssText) {
  var doc = shadowRoot.ownerDocument;
  var win = toWin(doc.defaultView);

  if (shadowRoot.adoptedStyleSheets !== undefined && win.CSSStyleSheet.prototype.replaceSync !== undefined) {
    var cache = win[SHADOW_CSS_CACHE] || (win[SHADOW_CSS_CACHE] = {});
    var styleSheet = cache[name];

    if (!styleSheet) {
      styleSheet = new win.CSSStyleSheet();
      styleSheet.replaceSync(cssText);
      cache[name] = styleSheet;
    }

    shadowRoot.adoptedStyleSheets = shadowRoot.adoptedStyleSheets.concat(styleSheet);
  } else {
    var styleEl = doc.createElement('style');
    styleEl.setAttribute('data-name', name);
    styleEl.textContent = cssText;
    shadowRoot.appendChild(styleEl);
  }
}

/**
 * @param {!Window} win
 * @visibleForTesting
 */
export function resetShadowStyleCacheForTesting(win) {
  win[SHADOW_CSS_CACHE] = null;
}

/**
 * @param {boolean|undefined} val
 * @visibleForTesting
 */
export function setShadowDomStreamingSupportedForTesting(val) {
  shadowDomStreamingSupported = val;
}

/**
 * Returns `true` if the Shadow DOM streaming is supported.
 * @param {!Window} win
 * @return {boolean}
 */
export function isShadowDomStreamingSupported(win) {
  if (shadowDomStreamingSupported === undefined) {
    shadowDomStreamingSupported = calcShadowDomStreamingSupported(win);
  }

  return shadowDomStreamingSupported;
}

/**
 * @param {!Window} win
 * @return {boolean}
 */
function calcShadowDomStreamingSupported(win) {
  // API must be supported.
  if (!win.document.implementation || typeof win.document.implementation.createHTMLDocument != 'function') {
    return false;
  }

  // Firefox does not support DOM streaming.
  // See: https://bugzilla.mozilla.org/show_bug.cgi?id=867102
  if (Services.platformFor(win).isFirefox()) {
    return false;
  }

  // Assume full streaming support.
  return true;
}

/**
 * Creates the Shadow DOM writer available on this platform.
 * @param {!Window} win
 * @return {!./utils/dom-writer.DomWriter}
 */
export function createShadowDomWriter(win) {
  if (isShadowDomStreamingSupported(win)) {
    return new DomWriterStreamer(win);
  }

  return new DomWriterBulk(win);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNoYWRvdy1lbWJlZC5qcyJdLCJuYW1lcyI6WyJTaGFkb3dDU1MiLCJpdGVyYXRlQ3Vyc29yIiwiZXNjYXBlQ3NzU2VsZWN0b3JJZGVudCIsInNldEluaXRpYWxEaXNwbGF5Iiwic2V0U3R5bGUiLCJTaGFkb3dEb21WZXJzaW9uIiwiZ2V0U2hhZG93RG9tU3VwcG9ydGVkVmVyc2lvbiIsImlzU2hhZG93Q3NzU3VwcG9ydGVkIiwidG9BcnJheSIsInRvV2luIiwiZGV2IiwiZGV2QXNzZXJ0IiwiU2VydmljZXMiLCJpbnN0YWxsQ3NzVHJhbnNmb3JtZXIiLCJEb21Xcml0ZXJCdWxrIiwiRG9tV3JpdGVyU3RyZWFtZXIiLCJDU1NfU0VMRUNUT1JfQkVHX1JFR0VYIiwiQ1NTX1NFTEVDVE9SX0VORF9SRUdFWCIsIlNIQURPV19DU1NfQ0FDSEUiLCJzaGFkb3dEb21TdHJlYW1pbmdTdXBwb3J0ZWQiLCJjcmVhdGVTaGFkb3dSb290IiwiaG9zdEVsZW1lbnQiLCJ3aW4iLCJvd25lckRvY3VtZW50IiwiZGVmYXVsdFZpZXciLCJleGlzdGluZ1Jvb3QiLCJzaGFkb3dSb290IiwiX19BTVBfU0hBRE9XX1JPT1QiLCJpbm5lckhUTUwiLCJzaGFkb3dEb21TdXBwb3J0ZWQiLCJWMSIsImF0dGFjaFNoYWRvdyIsIm1vZGUiLCJzdHlsZVNoZWV0cyIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZ2V0IiwiaXRlbXMiLCJjaGlsZE5vZGVzIiwiY2hpbGQiLCJ0YWdOYW1lIiwicHVzaCIsInNoZWV0IiwiVjAiLCJjcmVhdGVTaGFkb3dSb290UG9seWZpbGwiLCJyb290SWQiLCJNYXRoIiwiZmxvb3IiLCJyYW5kb20iLCJob3N0IiwiY2xhc3NMaXN0IiwiYWRkIiwiY3NzIiwidHJhbnNmb3JtU2hhZG93Q3NzIiwiZG9jIiwiaG9zdFN0eWxlIiwiY3JlYXRlRWxlbWVudCIsInRleHRDb250ZW50IiwiYXBwZW5kQ2hpbGQiLCJlbnVtZXJhYmxlIiwiY29uZmlndXJhYmxlIiwidmFsdWUiLCJnZXRFbGVtZW50QnlJZCIsImlkIiwiZXNjYXBlZElkIiwicXVlcnlTZWxlY3RvciIsImZpbHRlciIsInN0eWxlU2hlZXQiLCJjb250YWlucyIsIm93bmVyTm9kZSIsImltcG9ydFNoYWRvd0JvZHkiLCJib2R5IiwiZGVlcCIsInJlc3VsdEJvZHkiLCJhc3NlcnRFbGVtZW50IiwiaW1wb3J0Tm9kZSIsImkiLCJhdHRyaWJ1dGVzIiwibGVuZ3RoIiwic2V0QXR0cmlidXRlIiwibmFtZSIsIm4iLCJmaXJzdENoaWxkIiwibmV4dFNpYmxpbmciLCJvbGRCb2R5IiwicmVtb3ZlQ2hpbGQiLCJzY29wZVNoYWRvd0NzcyIsInJ1bGVzIiwiZ2V0U3R5bGVzaGVldFJ1bGVzIiwiaW1wbGVtZW50YXRpb24iLCJjcmVhdGVIVE1MRG9jdW1lbnQiLCJlIiwic2NvcGVSdWxlcyIsImNhbGwiLCJ0cmFuc2Zvcm1Sb290U2VsZWN0b3JzIiwic2VsZWN0b3IiLCJyZXBsYWNlIiwicm9vdFNlbGVjdG9yUHJlZml4ZXIiLCJtYXRjaCIsInBvcyIsInByZXYiLCJjaGFyQXQiLCJuZXh0IiwidGVzdCIsInN0eWxlIiwiaGVhZCIsImRvY3VtZW50RWxlbWVudCIsImNzc1J1bGVzIiwicGFyZW50Tm9kZSIsImluc3RhbGxTaGFkb3dTdHlsZSIsImNzc1RleHQiLCJhZG9wdGVkU3R5bGVTaGVldHMiLCJ1bmRlZmluZWQiLCJDU1NTdHlsZVNoZWV0IiwicHJvdG90eXBlIiwicmVwbGFjZVN5bmMiLCJjYWNoZSIsImNvbmNhdCIsInN0eWxlRWwiLCJyZXNldFNoYWRvd1N0eWxlQ2FjaGVGb3JUZXN0aW5nIiwic2V0U2hhZG93RG9tU3RyZWFtaW5nU3VwcG9ydGVkRm9yVGVzdGluZyIsInZhbCIsImlzU2hhZG93RG9tU3RyZWFtaW5nU3VwcG9ydGVkIiwiY2FsY1NoYWRvd0RvbVN0cmVhbWluZ1N1cHBvcnRlZCIsImRvY3VtZW50IiwicGxhdGZvcm1Gb3IiLCJpc0ZpcmVmb3giLCJjcmVhdGVTaGFkb3dEb21Xcml0ZXIi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O0FBQ0EsT0FBTyxTQUFTQyxxQkFBVCxDQUErQnpHLEdBQS9CLEVBQW9DO0FBQ3pDLE1BQUlvRyw2QkFBNkIsQ0FBQ3BHLEdBQUQsQ0FBakMsRUFBd0M7QUFDdEMsV0FBTyxJQUFJUCxpQkFBSixDQUFzQk8sR0FBdEIsQ0FBUDtBQUNEOztBQUNELFNBQU8sSUFBSVIsYUFBSixDQUFrQlEsR0FBbEIsQ0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgMjAxNiBUaGUgQU1QIEhUTUwgQXV0aG9ycy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTLUlTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7U2hhZG93Q1NTfSBmcm9tICcjdGhpcmRfcGFydHkvd2ViY29tcG9uZW50c2pzL1NoYWRvd0NTUyc7XG5cbmltcG9ydCB7aXRlcmF0ZUN1cnNvcn0gZnJvbSAnLi9jb3JlL2RvbSc7XG5pbXBvcnQge2VzY2FwZUNzc1NlbGVjdG9ySWRlbnR9IGZyb20gJy4vY29yZS9kb20vY3NzLXNlbGVjdG9ycyc7XG5pbXBvcnQge3NldEluaXRpYWxEaXNwbGF5LCBzZXRTdHlsZX0gZnJvbSAnLi9jb3JlL2RvbS9zdHlsZSc7XG5pbXBvcnQge1xuICBTaGFkb3dEb21WZXJzaW9uLFxuICBnZXRTaGFkb3dEb21TdXBwb3J0ZWRWZXJzaW9uLFxuICBpc1NoYWRvd0Nzc1N1cHBvcnRlZCxcbn0gZnJvbSAnLi9jb3JlL2RvbS93ZWItY29tcG9uZW50cyc7XG5pbXBvcnQge3RvQXJyYXl9IGZyb20gJy4vY29yZS90eXBlcy9hcnJheSc7XG5pbXBvcnQge3RvV2lufSBmcm9tICcuL2NvcmUvd2luZG93JztcbmltcG9ydCB7ZGV2LCBkZXZBc3NlcnR9IGZyb20gJy4vbG9nJztcbmltcG9ydCB7U2VydmljZXN9IGZyb20gJy4vc2VydmljZSc7XG5pbXBvcnQge2luc3RhbGxDc3NUcmFuc2Zvcm1lcn0gZnJvbSAnLi9zdHlsZS1pbnN0YWxsZXInO1xuaW1wb3J0IHtEb21Xcml0ZXJCdWxrLCBEb21Xcml0ZXJTdHJlYW1lcn0gZnJvbSAnLi91dGlscy9kb20td3JpdGVyJztcblxuLyoqIEBjb25zdCB7IVJlZ0V4cH0gKi9cbmNvbnN0IENTU19TRUxFQ1RPUl9CRUdfUkVHRVggPSAvW15cXC5cXC1cXF8wLTlhLXpBLVpdLztcblxuLyoqIEBjb25zdCB7IVJlZ0V4cH0gKi9cbmNvbnN0IENTU19TRUxFQ1RPUl9FTkRfUkVHRVggPSAvW15cXC1cXF8wLTlhLXpBLVpdLztcblxuY29uc3QgU0hBRE9XX0NTU19DQUNIRSA9ICdfX0FNUF9TSEFET1dfQ1NTJztcblxuLyoqXG4gKiBAdHlwZSB7Ym9vbGVhbnx1bmRlZmluZWR9XG4gKi9cbmxldCBzaGFkb3dEb21TdHJlYW1pbmdTdXBwb3J0ZWQ7XG5cbi8qKlxuICogQ3JlYXRlcyBhIHNoYWRvdyByb290IGZvciB0aGUgc3BlY2lmaWVkIGhvc3QgYW5kIHJldHVybnMgaXQuIFBvbHlmaWxsc1xuICogc2hhZG93IHJvb3QgY3JlYXRpb24gaWYgbmVjZXNzYXJ5LlxuICogQHBhcmFtIHshRWxlbWVudH0gaG9zdEVsZW1lbnRcbiAqIEByZXR1cm4geyFTaGFkb3dSb290fVxuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlU2hhZG93Um9vdChob3N0RWxlbWVudCkge1xuICBjb25zdCB3aW4gPSB0b1dpbihob3N0RWxlbWVudC5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3KTtcblxuICBjb25zdCBleGlzdGluZ1Jvb3QgPSBob3N0RWxlbWVudC5zaGFkb3dSb290IHx8IGhvc3RFbGVtZW50Ll9fQU1QX1NIQURPV19ST09UO1xuICBpZiAoZXhpc3RpbmdSb290KSB7XG4gICAgZXhpc3RpbmdSb290Li8qT0sqLyBpbm5lckhUTUwgPSAnJztcbiAgICByZXR1cm4gZXhpc3RpbmdSb290O1xuICB9XG5cbiAgbGV0IHNoYWRvd1Jvb3Q7XG4gIGNvbnN0IHNoYWRvd0RvbVN1cHBvcnRlZCA9IGdldFNoYWRvd0RvbVN1cHBvcnRlZFZlcnNpb24oKTtcbiAgaWYgKHNoYWRvd0RvbVN1cHBvcnRlZCA9PSBTaGFkb3dEb21WZXJzaW9uLlYxKSB7XG4gICAgc2hhZG93Um9vdCA9IGhvc3RFbGVtZW50LmF0dGFjaFNoYWRvdyh7bW9kZTogJ29wZW4nfSk7XG4gICAgaWYgKCFzaGFkb3dSb290LnN0eWxlU2hlZXRzKSB7XG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoc2hhZG93Um9vdCwgJ3N0eWxlU2hlZXRzJywge1xuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBjb25zdCBpdGVtcyA9IFtdO1xuICAgICAgICAgIGl0ZXJhdGVDdXJzb3Ioc2hhZG93Um9vdC5jaGlsZE5vZGVzLCAoY2hpbGQpID0+IHtcbiAgICAgICAgICAgIGlmIChjaGlsZC50YWdOYW1lID09PSAnU1RZTEUnKSB7XG4gICAgICAgICAgICAgIGl0ZW1zLnB1c2goY2hpbGQuc2hlZXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHJldHVybiBpdGVtcztcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSBlbHNlIGlmIChzaGFkb3dEb21TdXBwb3J0ZWQgPT0gU2hhZG93RG9tVmVyc2lvbi5WMCkge1xuICAgIHNoYWRvd1Jvb3QgPSBob3N0RWxlbWVudC5jcmVhdGVTaGFkb3dSb290KCk7XG4gIH0gZWxzZSB7XG4gICAgc2hhZG93Um9vdCA9IGNyZWF0ZVNoYWRvd1Jvb3RQb2x5ZmlsbChob3N0RWxlbWVudCk7XG4gIH1cblxuICBpZiAoIWlzU2hhZG93Q3NzU3VwcG9ydGVkKCkpIHtcbiAgICBjb25zdCByb290SWQgPSBgaS1hbXBodG1sLXNkLSR7d2luLk1hdGguZmxvb3Iod2luLk1hdGgucmFuZG9tKCkgKiAxMDAwMCl9YDtcbiAgICBzaGFkb3dSb290WydpZCddID0gcm9vdElkO1xuICAgIHNoYWRvd1Jvb3QuaG9zdC5jbGFzc0xpc3QuYWRkKHJvb3RJZCk7XG5cbiAgICAvLyBDU1MgaXNvbGF0aW9uLlxuICAgIGluc3RhbGxDc3NUcmFuc2Zvcm1lcihzaGFkb3dSb290LCAoY3NzKSA9PiB7XG4gICAgICByZXR1cm4gdHJhbnNmb3JtU2hhZG93Q3NzKHNoYWRvd1Jvb3QsIGNzcyk7XG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gc2hhZG93Um9vdDtcbn1cblxuLyoqXG4gKiBTaGFkb3cgcm9vdCBwb2x5ZmlsbC5cbiAqIEBwYXJhbSB7IUVsZW1lbnR9IGhvc3RFbGVtZW50XG4gKiBAcmV0dXJuIHshU2hhZG93Um9vdH1cbiAqL1xuZnVuY3Rpb24gY3JlYXRlU2hhZG93Um9vdFBvbHlmaWxsKGhvc3RFbGVtZW50KSB7XG4gIGNvbnN0IGRvYyA9IGhvc3RFbGVtZW50Lm93bmVyRG9jdW1lbnQ7XG5cbiAgLy8gSG9zdCBDU1MgcG9seWZpbGwuXG4gIGhvc3RFbGVtZW50LmNsYXNzTGlzdC5hZGQoJ2ktYW1waHRtbC1zaGFkb3ctaG9zdC1wb2x5ZmlsbCcpO1xuICBjb25zdCBob3N0U3R5bGUgPSBkb2MuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTtcbiAgaG9zdFN0eWxlLnRleHRDb250ZW50ID1cbiAgICAnLmktYW1waHRtbC1zaGFkb3ctaG9zdC1wb2x5ZmlsbD46bm90KGktYW1waHRtbC1zaGFkb3ctcm9vdCknICtcbiAgICAne2Rpc3BsYXk6bm9uZSFpbXBvcnRhbnR9JztcbiAgaG9zdEVsZW1lbnQuYXBwZW5kQ2hpbGQoaG9zdFN0eWxlKTtcblxuICAvLyBTaGFkb3cgcm9vdC5cbiAgY29uc3Qgc2hhZG93Um9vdCAvKiogQHR5cGUgeyFTaGFkb3dSb290fSAqLyA9XG4gICAgLy8gQ2FzdCB0byBTaGFkb3dSb290IGV2ZW4gdGhvdWdoIGl0IGlzIGFuIEVsZW1lbnRcbiAgICAvLyBUT0RPKEBkdm95dGVua28pIENvbnNpZGVyIHRvIHN3aXRjaCB0byBhIHR5cGUgdW5pb24gaW5zdGVhZC5cbiAgICAvKiogQHR5cGUgez99ICAqLyAoZG9jLmNyZWF0ZUVsZW1lbnQoJ2ktYW1waHRtbC1zaGFkb3ctcm9vdCcpKTtcbiAgaG9zdEVsZW1lbnQuYXBwZW5kQ2hpbGQoc2hhZG93Um9vdCk7XG4gIGhvc3RFbGVtZW50Ll9fQU1QX1NIQURPV19ST09UID0gc2hhZG93Um9vdDtcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGhvc3RFbGVtZW50LCAnc2hhZG93Um9vdCcsIHtcbiAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICB2YWx1ZTogc2hhZG93Um9vdCxcbiAgfSk7XG5cbiAgLy8gQVBJOiBodHRwczovL3d3dy53My5vcmcvVFIvc2hhZG93LWRvbS8jdGhlLXNoYWRvd3Jvb3QtaW50ZXJmYWNlXG5cbiAgc2hhZG93Um9vdC5ob3N0ID0gaG9zdEVsZW1lbnQ7XG5cbiAgLy8gYGdldEVsZW1lbnRCeUlkYCBpcyByZXNvbHZlZCB2aWEgYHF1ZXJ5U2VsZWN0b3IoJyNpZCcpYC5cbiAgc2hhZG93Um9vdC5nZXRFbGVtZW50QnlJZCA9IGZ1bmN0aW9uIChpZCkge1xuICAgIGNvbnN0IGVzY2FwZWRJZCA9IGVzY2FwZUNzc1NlbGVjdG9ySWRlbnQoaWQpO1xuICAgIHJldHVybiAvKiogQHR5cGUgez9IVE1MRWxlbWVudH0gKi8gKFxuICAgICAgc2hhZG93Um9vdC4vKk9LKi8gcXVlcnlTZWxlY3RvcihgIyR7ZXNjYXBlZElkfWApXG4gICAgKTtcbiAgfTtcblxuICAvLyBUaGUgc3R5bGVTaGVldHMgcHJvcGVydHkgc2hvdWxkIGhhdmUgYSBsaXN0IG9mIGxvY2FsIHN0eWxlcy5cbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHNoYWRvd1Jvb3QsICdzdHlsZVNoZWV0cycsIHtcbiAgICBnZXQ6ICgpID0+IHtcbiAgICAgIGlmICghZG9jLnN0eWxlU2hlZXRzKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0b0FycmF5KGRvYy5zdHlsZVNoZWV0cykuZmlsdGVyKChzdHlsZVNoZWV0KSA9PlxuICAgICAgICBzaGFkb3dSb290LmNvbnRhaW5zKHN0eWxlU2hlZXQub3duZXJOb2RlKVxuICAgICAgKTtcbiAgICB9LFxuICB9KTtcblxuICByZXR1cm4gc2hhZG93Um9vdDtcbn1cblxuLyoqXG4gKiBJbXBvcnRzIGEgYm9keSBpbnRvIGEgc2hhZG93IHJvb3Qgd2l0aCB0aGUgd29ya2Fyb3VuZCBmb3IgYSBwb2x5ZmlsbCBjYXNlLlxuICogQHBhcmFtIHshU2hhZG93Um9vdH0gc2hhZG93Um9vdFxuICogQHBhcmFtIHshRWxlbWVudH0gYm9keVxuICogQHBhcmFtIHtib29sZWFufSBkZWVwXG4gKiBAcmV0dXJuIHshRWxlbWVudH1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGltcG9ydFNoYWRvd0JvZHkoc2hhZG93Um9vdCwgYm9keSwgZGVlcCkge1xuICBjb25zdCBkb2MgPSBzaGFkb3dSb290Lm93bmVyRG9jdW1lbnQ7XG4gIGxldCByZXN1bHRCb2R5O1xuICBpZiAoaXNTaGFkb3dDc3NTdXBwb3J0ZWQoKSkge1xuICAgIHJlc3VsdEJvZHkgPSBkZXYoKS5hc3NlcnRFbGVtZW50KGRvYy5pbXBvcnROb2RlKGJvZHksIGRlZXApKTtcbiAgfSBlbHNlIHtcbiAgICByZXN1bHRCb2R5ID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2FtcC1ib2R5Jyk7XG4gICAgc2V0SW5pdGlhbERpc3BsYXkocmVzdWx0Qm9keSwgJ2Jsb2NrJyk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBib2R5LmF0dHJpYnV0ZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIHJlc3VsdEJvZHkuc2V0QXR0cmlidXRlKFxuICAgICAgICBib2R5LmF0dHJpYnV0ZXNbMF0ubmFtZSxcbiAgICAgICAgYm9keS5hdHRyaWJ1dGVzWzBdLnZhbHVlXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAoZGVlcCkge1xuICAgICAgZm9yIChsZXQgbiA9IGJvZHkuZmlyc3RDaGlsZDsgISFuOyBuID0gbi5uZXh0U2libGluZykge1xuICAgICAgICByZXN1bHRCb2R5LmFwcGVuZENoaWxkKGRvYy5pbXBvcnROb2RlKG4sIHRydWUpKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgc2V0U3R5bGUocmVzdWx0Qm9keSwgJ3Bvc2l0aW9uJywgJ3JlbGF0aXZlJyk7XG4gIGNvbnN0IG9sZEJvZHkgPSBzaGFkb3dSb290Wydib2R5J107XG4gIGlmIChvbGRCb2R5KSB7XG4gICAgc2hhZG93Um9vdC5yZW1vdmVDaGlsZChvbGRCb2R5KTtcbiAgfVxuICBzaGFkb3dSb290LmFwcGVuZENoaWxkKHJlc3VsdEJvZHkpO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoc2hhZG93Um9vdCwgJ2JvZHknLCB7XG4gICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgIHZhbHVlOiByZXN1bHRCb2R5LFxuICB9KTtcbiAgcmV0dXJuIHJlc3VsdEJvZHk7XG59XG5cbi8qKlxuICogSWYgbmVjZXNzYXJ5LCB0cmFuc2Zvcm1zIENTUyB0byBpc29sYXRlIEFNUCBDU1Mgd2l0aGluIHRoZSBzaGFvZHcgcm9vdCBhbmRcbiAqIHJlZHVjZSB0aGUgcG9zc2liaWxpdHkgb2YgaGlnaC1sZXZlbCBjb25mbGljdHMuXG4gKiBAcGFyYW0geyFTaGFkb3dSb290fSBzaGFkb3dSb290XG4gKiBAcGFyYW0ge3N0cmluZ30gY3NzXG4gKiBAcmV0dXJuIHtzdHJpbmd9XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB0cmFuc2Zvcm1TaGFkb3dDc3Moc2hhZG93Um9vdCwgY3NzKSB7XG4gIHJldHVybiBzY29wZVNoYWRvd0NzcyhzaGFkb3dSb290LCBjc3MpO1xufVxuXG4vKipcbiAqIFRyYW5zZm9ybXMgQ1NTIHRvIGlzb2xhdGUgQU1QIENTUyB3aXRoaW4gdGhlIHNoYWRvdyByb290IGFuZCByZWR1Y2UgdGhlXG4gKiBwb3NzaWJpbGl0eSBvZiBoaWdoLWxldmVsIGNvbmZsaWN0cy4gVGhlcmUgYXJlIHR3byB0eXBlcyBvZiB0cmFuc2Zvcm1hdGlvbnM6XG4gKiAxLiBSb290IHRyYW5zZm9ybWF0aW9uOiBgYm9keWAgLT4gYGFtcC1ib2R5YCwgZXRjLlxuICogMi4gU2NvcGluZzogYGEge31gIC0+IGAuaS1hbXBodG1sLXNkLTEyMyBhIHt9YC5cbiAqXG4gKiBAcGFyYW0geyFTaGFkb3dSb290fSBzaGFkb3dSb290XG4gKiBAcGFyYW0ge3N0cmluZ30gY3NzXG4gKiBAcmV0dXJuIHtzdHJpbmd9XG4gKiBAdmlzaWJsZUZvclRlc3RpbmdcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNjb3BlU2hhZG93Q3NzKHNoYWRvd1Jvb3QsIGNzcykge1xuICBjb25zdCBpZCA9IGRldkFzc2VydChzaGFkb3dSb290WydpZCddKTtcbiAgY29uc3QgZG9jID0gc2hhZG93Um9vdC5vd25lckRvY3VtZW50O1xuICBsZXQgcnVsZXMgPSBudWxsO1xuICAvLyBUcnkgdG8gdXNlIGEgc2VwYXJhdGUgZG9jdW1lbnQuXG4gIHRyeSB7XG4gICAgcnVsZXMgPSBnZXRTdHlsZXNoZWV0UnVsZXMoZG9jLmltcGxlbWVudGF0aW9uLmNyZWF0ZUhUTUxEb2N1bWVudCgnJyksIGNzcyk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICAvLyBJZ25vcmUuXG4gIH1cbiAgLy8gVHJ5IHRvIHVzZSB0aGUgY3VycmVudCBkb2N1bWVudC5cbiAgaWYgKCFydWxlcykge1xuICAgIHRyeSB7XG4gICAgICBydWxlcyA9IGdldFN0eWxlc2hlZXRSdWxlcyhkb2MsIGNzcyk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgLy8gSWdub3JlLlxuICAgIH1cbiAgfVxuXG4gIC8vIE5vIHJ1bGVzIGNvdWxkIGJlIHBhcnNlZCAtIHJldHVybiBjc3MgYXMgaXMuXG4gIGlmICghcnVsZXMpIHtcbiAgICByZXR1cm4gY3NzO1xuICB9XG5cbiAgLy8gUGF0Y2ggc2VsZWN0b3JzLlxuICAvLyBJbnZva2UgYFNoYWRvd0NTUy5zY29wZVJ1bGVzYCB2aWEgYGNhbGxgIGJlY2F1c2UgdGhlIHdheSBpdCB1c2VzIGB0aGlzYFxuICAvLyBpbnRlcm5hbGx5IGNvbmZsaWN0cyB3aXRoIENsb3N1cmUgY29tcGlsZXIncyBhZHZhbmNlZCBvcHRpbWl6YXRpb25zLlxuICBjb25zdCB7c2NvcGVSdWxlc30gPSBTaGFkb3dDU1M7XG4gIHJldHVybiBzY29wZVJ1bGVzLmNhbGwoU2hhZG93Q1NTLCBydWxlcywgYC4ke2lkfWAsIHRyYW5zZm9ybVJvb3RTZWxlY3RvcnMpO1xufVxuXG4vKipcbiAqIFJlcGxhY2VzIHRvcC1sZXZlbCBzZWxlY3RvcnMgc3VjaCBhcyBgaHRtbGAgYW5kIGBib2R5YCB3aXRoIHRoZWlyIHBvbHlmaWxsXG4gKiBjb3VudGVycGFydHM6IGBhbXAtaHRtbGAgYW5kIGBhbXAtYm9keWAuXG4gKiBAcGFyYW0ge3N0cmluZ30gc2VsZWN0b3JcbiAqIEByZXR1cm4ge3N0cmluZ31cbiAqL1xuZnVuY3Rpb24gdHJhbnNmb3JtUm9vdFNlbGVjdG9ycyhzZWxlY3Rvcikge1xuICByZXR1cm4gc2VsZWN0b3IucmVwbGFjZSgvKGh0bWx8Ym9keSkvZywgcm9vdFNlbGVjdG9yUHJlZml4ZXIpO1xufVxuXG4vKipcbiAqIFNlZSBgdHJhbnNmb3JtUm9vdFNlbGVjdG9yc2AuXG4gKiBAcGFyYW0ge3N0cmluZ30gbWF0Y2hcbiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gKiBAcGFyYW0ge251bWJlcn0gcG9zXG4gKiBAcGFyYW0ge3N0cmluZ30gc2VsZWN0b3JcbiAqIEByZXR1cm4ge3N0cmluZ31cbiAqIEBwcml2YXRlXG4gKi9cbmZ1bmN0aW9uIHJvb3RTZWxlY3RvclByZWZpeGVyKG1hdGNoLCBuYW1lLCBwb3MsIHNlbGVjdG9yKSB7XG4gIGNvbnN0IHByZXYgPSBzZWxlY3Rvci5jaGFyQXQocG9zIC0gMSk7XG4gIGNvbnN0IG5leHQgPSBzZWxlY3Rvci5jaGFyQXQocG9zICsgbWF0Y2gubGVuZ3RoKTtcbiAgaWYgKFxuICAgICghcHJldiB8fCBDU1NfU0VMRUNUT1JfQkVHX1JFR0VYLnRlc3QocHJldikpICYmXG4gICAgKCFuZXh0IHx8IENTU19TRUxFQ1RPUl9FTkRfUkVHRVgudGVzdChuZXh0KSlcbiAgKSB7XG4gICAgcmV0dXJuICdhbXAtJyArIG1hdGNoO1xuICB9XG4gIHJldHVybiBtYXRjaDtcbn1cblxuLyoqXG4gKiBAcGFyYW0geyFEb2N1bWVudH0gZG9jXG4gKiBAcGFyYW0ge3N0cmluZ30gY3NzXG4gKiBAcmV0dXJuIHs/Q1NTUnVsZUxpc3R9XG4gKi9cbmZ1bmN0aW9uIGdldFN0eWxlc2hlZXRSdWxlcyhkb2MsIGNzcykge1xuICBjb25zdCBzdHlsZSA9IC8qKiBAdHlwZSB7IUhUTUxTdHlsZUVsZW1lbnR9ICovIChkb2MuY3JlYXRlRWxlbWVudCgnc3R5bGUnKSk7XG4gIHN0eWxlLi8qT0sqLyB0ZXh0Q29udGVudCA9IGNzcztcbiAgdHJ5IHtcbiAgICAoZG9jLmhlYWQgfHwgZG9jLmRvY3VtZW50RWxlbWVudCkuYXBwZW5kQ2hpbGQoc3R5bGUpO1xuICAgIGlmIChzdHlsZS5zaGVldCkge1xuICAgICAgcmV0dXJuIC8qKiBAdHlwZSB7IUNTU1N0eWxlU2hlZXR9ICovIChzdHlsZS5zaGVldCkuY3NzUnVsZXM7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9IGZpbmFsbHkge1xuICAgIGlmIChzdHlsZS5wYXJlbnROb2RlKSB7XG4gICAgICBzdHlsZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHN0eWxlKTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBAcGFyYW0geyFTaGFkb3dSb290fSBzaGFkb3dSb290XG4gKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICogQHBhcmFtIHtzdHJpbmd9IGNzc1RleHRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGluc3RhbGxTaGFkb3dTdHlsZShzaGFkb3dSb290LCBuYW1lLCBjc3NUZXh0KSB7XG4gIGNvbnN0IGRvYyA9IHNoYWRvd1Jvb3Qub3duZXJEb2N1bWVudDtcbiAgY29uc3Qgd2luID0gdG9XaW4oZG9jLmRlZmF1bHRWaWV3KTtcbiAgaWYgKFxuICAgIHNoYWRvd1Jvb3QuYWRvcHRlZFN0eWxlU2hlZXRzICE9PSB1bmRlZmluZWQgJiZcbiAgICB3aW4uQ1NTU3R5bGVTaGVldC5wcm90b3R5cGUucmVwbGFjZVN5bmMgIT09IHVuZGVmaW5lZFxuICApIHtcbiAgICBjb25zdCBjYWNoZSA9IHdpbltTSEFET1dfQ1NTX0NBQ0hFXSB8fCAod2luW1NIQURPV19DU1NfQ0FDSEVdID0ge30pO1xuICAgIGxldCBzdHlsZVNoZWV0ID0gY2FjaGVbbmFtZV07XG4gICAgaWYgKCFzdHlsZVNoZWV0KSB7XG4gICAgICBzdHlsZVNoZWV0ID0gbmV3IHdpbi5DU1NTdHlsZVNoZWV0KCk7XG4gICAgICBzdHlsZVNoZWV0LnJlcGxhY2VTeW5jKGNzc1RleHQpO1xuICAgICAgY2FjaGVbbmFtZV0gPSBzdHlsZVNoZWV0O1xuICAgIH1cbiAgICBzaGFkb3dSb290LmFkb3B0ZWRTdHlsZVNoZWV0cyA9XG4gICAgICBzaGFkb3dSb290LmFkb3B0ZWRTdHlsZVNoZWV0cy5jb25jYXQoc3R5bGVTaGVldCk7XG4gIH0gZWxzZSB7XG4gICAgY29uc3Qgc3R5bGVFbCA9IGRvYy5jcmVhdGVFbGVtZW50KCdzdHlsZScpO1xuICAgIHN0eWxlRWwuc2V0QXR0cmlidXRlKCdkYXRhLW5hbWUnLCBuYW1lKTtcbiAgICBzdHlsZUVsLnRleHRDb250ZW50ID0gY3NzVGV4dDtcbiAgICBzaGFkb3dSb290LmFwcGVuZENoaWxkKHN0eWxlRWwpO1xuICB9XG59XG5cbi8qKlxuICogQHBhcmFtIHshV2luZG93fSB3aW5cbiAqIEB2aXNpYmxlRm9yVGVzdGluZ1xuICovXG5leHBvcnQgZnVuY3Rpb24gcmVzZXRTaGFkb3dTdHlsZUNhY2hlRm9yVGVzdGluZyh3aW4pIHtcbiAgd2luW1NIQURPV19DU1NfQ0FDSEVdID0gbnVsbDtcbn1cblxuLyoqXG4gKiBAcGFyYW0ge2Jvb2xlYW58dW5kZWZpbmVkfSB2YWxcbiAqIEB2aXNpYmxlRm9yVGVzdGluZ1xuICovXG5leHBvcnQgZnVuY3Rpb24gc2V0U2hhZG93RG9tU3RyZWFtaW5nU3VwcG9ydGVkRm9yVGVzdGluZyh2YWwpIHtcbiAgc2hhZG93RG9tU3RyZWFtaW5nU3VwcG9ydGVkID0gdmFsO1xufVxuXG4vKipcbiAqIFJldHVybnMgYHRydWVgIGlmIHRoZSBTaGFkb3cgRE9NIHN0cmVhbWluZyBpcyBzdXBwb3J0ZWQuXG4gKiBAcGFyYW0geyFXaW5kb3d9IHdpblxuICogQHJldHVybiB7Ym9vbGVhbn1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGlzU2hhZG93RG9tU3RyZWFtaW5nU3VwcG9ydGVkKHdpbikge1xuICBpZiAoc2hhZG93RG9tU3RyZWFtaW5nU3VwcG9ydGVkID09PSB1bmRlZmluZWQpIHtcbiAgICBzaGFkb3dEb21TdHJlYW1pbmdTdXBwb3J0ZWQgPSBjYWxjU2hhZG93RG9tU3RyZWFtaW5nU3VwcG9ydGVkKHdpbik7XG4gIH1cbiAgcmV0dXJuIHNoYWRvd0RvbVN0cmVhbWluZ1N1cHBvcnRlZDtcbn1cblxuLyoqXG4gKiBAcGFyYW0geyFXaW5kb3d9IHdpblxuICogQHJldHVybiB7Ym9vbGVhbn1cbiAqL1xuZnVuY3Rpb24gY2FsY1NoYWRvd0RvbVN0cmVhbWluZ1N1cHBvcnRlZCh3aW4pIHtcbiAgLy8gQVBJIG11c3QgYmUgc3VwcG9ydGVkLlxuICBpZiAoXG4gICAgIXdpbi5kb2N1bWVudC5pbXBsZW1lbnRhdGlvbiB8fFxuICAgIHR5cGVvZiB3aW4uZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlSFRNTERvY3VtZW50ICE9ICdmdW5jdGlvbidcbiAgKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIC8vIEZpcmVmb3ggZG9lcyBub3Qgc3VwcG9ydCBET00gc3RyZWFtaW5nLlxuICAvLyBTZWU6IGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTg2NzEwMlxuICBpZiAoU2VydmljZXMucGxhdGZvcm1Gb3Iod2luKS5pc0ZpcmVmb3goKSkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuICAvLyBBc3N1bWUgZnVsbCBzdHJlYW1pbmcgc3VwcG9ydC5cbiAgcmV0dXJuIHRydWU7XG59XG5cbi8qKlxuICogQ3JlYXRlcyB0aGUgU2hhZG93IERPTSB3cml0ZXIgYXZhaWxhYmxlIG9uIHRoaXMgcGxhdGZvcm0uXG4gKiBAcGFyYW0geyFXaW5kb3d9IHdpblxuICogQHJldHVybiB7IS4vdXRpbHMvZG9tLXdyaXRlci5Eb21Xcml0ZXJ9XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVTaGFkb3dEb21Xcml0ZXIod2luKSB7XG4gIGlmIChpc1NoYWRvd0RvbVN0cmVhbWluZ1N1cHBvcnRlZCh3aW4pKSB7XG4gICAgcmV0dXJuIG5ldyBEb21Xcml0ZXJTdHJlYW1lcih3aW4pO1xuICB9XG4gIHJldHVybiBuZXcgRG9tV3JpdGVyQnVsayh3aW4pO1xufVxuIl19
// /Users/mszylkowski/src/amphtml/src/shadow-embed.js