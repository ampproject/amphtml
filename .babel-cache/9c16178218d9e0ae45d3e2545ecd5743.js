/**
 * Copyright 2015 The AMP HTML Authors. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS-IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import * as mode from "./core/mode";
import { urls } from "./config";
import { DomFingerprint } from "./core/dom/fingerprint";
import { getLengthNumeral } from "./core/dom/layout";
import { getPageLayoutBoxBlocking } from "./core/dom/layout/page-layout-box";
import { dict } from "./core/types/object";
import { experimentToggles, isCanary } from "./experiments";
import { getModeObject } from "./mode-object";
import { Services } from "./service";

/**
 * Produces the attributes for the ad template.
 * @param {!Window} parentWindow
 * @param {!AmpElement} element
 * @param {string} sentinel
 * @param {!JsonObject=} attributes
 * @return {!JsonObject}
 */
export function getContextMetadata(parentWindow, element, sentinel, attributes) {
  var startTime = Date.now();
  var width = element.getAttribute('width');
  var height = element.getAttribute('height');
  attributes = attributes ? attributes : dict();
  attributes['width'] = getLengthNumeral(width);
  attributes['height'] = getLengthNumeral(height);

  if (element.getAttribute('title')) {
    attributes['title'] = element.getAttribute('title');
  }

  var locationHref = parentWindow.location.href;

  // This is really only needed for tests, but whatever. Children
  // see us as the logical origin, so telling them we are about:srcdoc
  // will fail ancestor checks.
  if (locationHref == 'about:srcdoc') {
    locationHref = parentWindow.parent.location.href;
  }

  var ampdoc = Services.ampdoc(element);
  var docInfo = Services.documentInfoForDoc(element);
  var viewer = Services.viewerForDoc(element);
  var referrer = viewer.getUnconfirmedReferrerUrl();
  var layoutRect = getPageLayoutBoxBlocking(element);
  // Use JsonObject to preserve field names so that ampContext can access
  // values with name
  // ampcontext.js and this file are compiled in different compilation unit
  // Note: Field names can by perserved by using JsonObject, or by adding
  // perserved name to extern. We are doing both right now.
  // Please also add new introduced variable
  // name to the extern list.
  attributes['_context'] = dict({
    'ampcontextVersion': mode.version(),
    'ampcontextFilepath': urls.thirdParty + "/" + mode.version() + "/ampcontext-v0.js",
    'sourceUrl': docInfo.sourceUrl,
    'referrer': referrer,
    'canonicalUrl': docInfo.canonicalUrl,
    'pageViewId': docInfo.pageViewId,
    'location': {
      'href': locationHref
    },
    'startTime': startTime,
    'tagName': element.tagName,
    'mode': getModeObject(),
    'canary': isCanary(parentWindow),
    'hidden': !ampdoc.isVisible(),
    'initialLayoutRect': layoutRect ? {
      'left': layoutRect.left,
      'top': layoutRect.top,
      'width': layoutRect.width,
      'height': layoutRect.height
    } : null,
    'domFingerprint': DomFingerprint.generate(element),
    'experimentToggles': experimentToggles(parentWindow),
    'sentinel': sentinel
  });
  var adSrc = element.getAttribute('src');

  if (adSrc) {
    attributes['src'] = adSrc;
  }

  return attributes;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImlmcmFtZS1hdHRyaWJ1dGVzLmpzIl0sIm5hbWVzIjpbIm1vZGUiLCJ1cmxzIiwiRG9tRmluZ2VycHJpbnQiLCJnZXRMZW5ndGhOdW1lcmFsIiwiZ2V0UGFnZUxheW91dEJveEJsb2NraW5nIiwiZGljdCIsImV4cGVyaW1lbnRUb2dnbGVzIiwiaXNDYW5hcnkiLCJnZXRNb2RlT2JqZWN0IiwiU2VydmljZXMiLCJnZXRDb250ZXh0TWV0YWRhdGEiLCJwYXJlbnRXaW5kb3ciLCJlbGVtZW50Iiwic2VudGluZWwiLCJhdHRyaWJ1dGVzIiwic3RhcnRUaW1lIiwiRGF0ZSIsIm5vdyIsIndpZHRoIiwiZ2V0QXR0cmlidXRlIiwiaGVpZ2h0IiwibG9jYXRpb25IcmVmIiwibG9jYXRpb24iLCJocmVmIiwicGFyZW50IiwiYW1wZG9jIiwiZG9jSW5mbyIsImRvY3VtZW50SW5mb0ZvckRvYyIsInZpZXdlciIsInZpZXdlckZvckRvYyIsInJlZmVycmVyIiwiZ2V0VW5jb25maXJtZWRSZWZlcnJlclVybCIsImxheW91dFJlY3QiLCJ2ZXJzaW9uIiwidGhpcmRQYXJ0eSIsInNvdXJjZVVybCIsImNhbm9uaWNhbFVybCIsInBhZ2VWaWV3SWQiLCJ0YWdOYW1lIiwiaXNWaXNpYmxlIiwibGVmdCIsInRvcCIsImdlbmVyYXRlIiwiYWRTcmMiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU8sS0FBS0EsSUFBWjtBQUVBLFNBQVFDLElBQVI7QUFDQSxTQUFRQyxjQUFSO0FBQ0EsU0FBUUMsZ0JBQVI7QUFDQSxTQUFRQyx3QkFBUjtBQUNBLFNBQVFDLElBQVI7QUFDQSxTQUFRQyxpQkFBUixFQUEyQkMsUUFBM0I7QUFDQSxTQUFRQyxhQUFSO0FBQ0EsU0FBUUMsUUFBUjs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Es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SXdCLEtBQUosRUFBVztBQUNUN0IsSUFBQUEsVUFBVSxDQUFDLEtBQUQsQ0FBVixHQUFvQjZCLEtBQXBCO0FBQ0Q7O0FBQ0QsU0FBTzdCLFVBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IDIwMTUgVGhlIEFNUCBIVE1MIEF1dGhvcnMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUy1JU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuaW1wb3J0ICogYXMgbW9kZSBmcm9tICcjY29yZS9tb2RlJztcblxuaW1wb3J0IHt1cmxzfSBmcm9tICcuL2NvbmZpZyc7XG5pbXBvcnQge0RvbUZpbmdlcnByaW50fSBmcm9tICcuL2NvcmUvZG9tL2ZpbmdlcnByaW50JztcbmltcG9ydCB7Z2V0TGVuZ3RoTnVtZXJhbH0gZnJvbSAnLi9jb3JlL2RvbS9sYXlvdXQnO1xuaW1wb3J0IHtnZXRQYWdlTGF5b3V0Qm94QmxvY2tpbmd9IGZyb20gJy4vY29yZS9kb20vbGF5b3V0L3BhZ2UtbGF5b3V0LWJveCc7XG5pbXBvcnQge2RpY3R9IGZyb20gJy4vY29yZS90eXBlcy9vYmplY3QnO1xuaW1wb3J0IHtleHBlcmltZW50VG9nZ2xlcywgaXNDYW5hcnl9IGZyb20gJy4vZXhwZXJpbWVudHMnO1xuaW1wb3J0IHtnZXRNb2RlT2JqZWN0fSBmcm9tICcuL21vZGUtb2JqZWN0JztcbmltcG9ydCB7U2VydmljZXN9IGZyb20gJy4vc2VydmljZSc7XG5cbi8qKlxuICogUHJvZHVjZXMgdGhlIGF0dHJpYnV0ZXMgZm9yIHRoZSBhZCB0ZW1wbGF0ZS5cbiAqIEBwYXJhbSB7IVdpbmRvd30gcGFyZW50V2luZG93XG4gKiBAcGFyYW0geyFBbXBFbGVtZW50fSBlbGVtZW50XG4gKiBAcGFyYW0ge3N0cmluZ30gc2VudGluZWxcbiAqIEBwYXJhbSB7IUpzb25PYmplY3Q9fSBhdHRyaWJ1dGVzXG4gKiBAcmV0dXJuIHshSnNvbk9iamVjdH1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldENvbnRleHRNZXRhZGF0YShcbiAgcGFyZW50V2luZG93LFxuICBlbGVtZW50LFxuICBzZW50aW5lbCxcbiAgYXR0cmlidXRlc1xuKSB7XG4gIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gIGNvbnN0IHdpZHRoID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3dpZHRoJyk7XG4gIGNvbnN0IGhlaWdodCA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdoZWlnaHQnKTtcbiAgYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXMgPyBhdHRyaWJ1dGVzIDogZGljdCgpO1xuICBhdHRyaWJ1dGVzWyd3aWR0aCddID0gZ2V0TGVuZ3RoTnVtZXJhbCh3aWR0aCk7XG4gIGF0dHJpYnV0ZXNbJ2hlaWdodCddID0gZ2V0TGVuZ3RoTnVtZXJhbChoZWlnaHQpO1xuICBpZiAoZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3RpdGxlJykpIHtcbiAgICBhdHRyaWJ1dGVzWyd0aXRsZSddID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3RpdGxlJyk7XG4gIH1cbiAgbGV0IGxvY2F0aW9uSHJlZiA9IHBhcmVudFdpbmRvdy5sb2NhdGlvbi5ocmVmO1xuICAvLyBUaGlzIGlzIHJlYWxseSBvbmx5IG5lZWRlZCBmb3IgdGVzdHMsIGJ1dCB3aGF0ZXZlci4gQ2hpbGRyZW5cbiAgLy8gc2VlIHVzIGFzIHRoZSBsb2dpY2FsIG9yaWdpbiwgc28gdGVsbGluZyB0aGVtIHdlIGFyZSBhYm91dDpzcmNkb2NcbiAgLy8gd2lsbCBmYWlsIGFuY2VzdG9yIGNoZWNrcy5cbiAgaWYgKGxvY2F0aW9uSHJlZiA9PSAnYWJvdXQ6c3JjZG9jJykge1xuICAgIGxvY2F0aW9uSHJlZiA9IHBhcmVudFdpbmRvdy5wYXJlbnQubG9jYXRpb24uaHJlZjtcbiAgfVxuXG4gIGNvbnN0IGFtcGRvYyA9IFNlcnZpY2VzLmFtcGRvYyhlbGVtZW50KTtcbiAgY29uc3QgZG9jSW5mbyA9IFNlcnZpY2VzLmRvY3VtZW50SW5mb0ZvckRvYyhlbGVtZW50KTtcbiAgY29uc3Qgdmlld2VyID0gU2VydmljZXMudmlld2VyRm9yRG9jKGVsZW1lbnQpO1xuICBjb25zdCByZWZlcnJlciA9IHZpZXdlci5nZXRVbmNvbmZpcm1lZFJlZmVycmVyVXJsKCk7XG5cbiAgY29uc3QgbGF5b3V0UmVjdCA9IGdldFBhZ2VMYXlvdXRCb3hCbG9ja2luZyhlbGVtZW50KTtcblxuICAvLyBVc2UgSnNvbk9iamVjdCB0byBwcmVzZXJ2ZSBmaWVsZCBuYW1lcyBzbyB0aGF0IGFtcENvbnRleHQgY2FuIGFjY2Vzc1xuICAvLyB2YWx1ZXMgd2l0aCBuYW1lXG4gIC8vIGFtcGNvbnRleHQuanMgYW5kIHRoaXMgZmlsZSBhcmUgY29tcGlsZWQgaW4gZGlmZmVyZW50IGNvbXBpbGF0aW9uIHVuaXRcblxuICAvLyBOb3RlOiBGaWVsZCBuYW1lcyBjYW4gYnkgcGVyc2VydmVkIGJ5IHVzaW5nIEpzb25PYmplY3QsIG9yIGJ5IGFkZGluZ1xuICAvLyBwZXJzZXJ2ZWQgbmFtZSB0byBleHRlcm4uIFdlIGFyZSBkb2luZyBib3RoIHJpZ2h0IG5vdy5cbiAgLy8gUGxlYXNlIGFsc28gYWRkIG5ldyBpbnRyb2R1Y2VkIHZhcmlhYmxlXG4gIC8vIG5hbWUgdG8gdGhlIGV4dGVybiBsaXN0LlxuICBhdHRyaWJ1dGVzWydfY29udGV4dCddID0gZGljdCh7XG4gICAgJ2FtcGNvbnRleHRWZXJzaW9uJzogbW9kZS52ZXJzaW9uKCksXG4gICAgJ2FtcGNvbnRleHRGaWxlcGF0aCc6IGAke1xuICAgICAgdXJscy50aGlyZFBhcnR5XG4gICAgfS8ke21vZGUudmVyc2lvbigpfS9hbXBjb250ZXh0LXYwLmpzYCxcbiAgICAnc291cmNlVXJsJzogZG9jSW5mby5zb3VyY2VVcmwsXG4gICAgJ3JlZmVycmVyJzogcmVmZXJyZXIsXG4gICAgJ2Nhbm9uaWNhbFVybCc6IGRvY0luZm8uY2Fub25pY2FsVXJsLFxuICAgICdwYWdlVmlld0lkJzogZG9jSW5mby5wYWdlVmlld0lkLFxuICAgICdsb2NhdGlvbic6IHtcbiAgICAgICdocmVmJzogbG9jYXRpb25IcmVmLFxuICAgIH0sXG4gICAgJ3N0YXJ0VGltZSc6IHN0YXJ0VGltZSxcbiAgICAndGFnTmFtZSc6IGVsZW1lbnQudGFnTmFtZSxcbiAgICAnbW9kZSc6IGdldE1vZGVPYmplY3QoKSxcbiAgICAnY2FuYXJ5JzogaXNDYW5hcnkocGFyZW50V2luZG93KSxcbiAgICAnaGlkZGVuJzogIWFtcGRvYy5pc1Zpc2libGUoKSxcbiAgICAnaW5pdGlhbExheW91dFJlY3QnOiBsYXlvdXRSZWN0XG4gICAgICA/IHtcbiAgICAgICAgICAnbGVmdCc6IGxheW91dFJlY3QubGVmdCxcbiAgICAgICAgICAndG9wJzogbGF5b3V0UmVjdC50b3AsXG4gICAgICAgICAgJ3dpZHRoJzogbGF5b3V0UmVjdC53aWR0aCxcbiAgICAgICAgICAnaGVpZ2h0JzogbGF5b3V0UmVjdC5oZWlnaHQsXG4gICAgICAgIH1cbiAgICAgIDogbnVsbCxcbiAgICAnZG9tRmluZ2VycHJpbnQnOiBEb21GaW5nZXJwcmludC5nZW5lcmF0ZShlbGVtZW50KSxcbiAgICAnZXhwZXJpbWVudFRvZ2dsZXMnOiBleHBlcmltZW50VG9nZ2xlcyhwYXJlbnRXaW5kb3cpLFxuICAgICdzZW50aW5lbCc6IHNlbnRpbmVsLFxuICB9KTtcbiAgY29uc3QgYWRTcmMgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgnc3JjJyk7XG4gIGlmIChhZFNyYykge1xuICAgIGF0dHJpYnV0ZXNbJ3NyYyddID0gYWRTcmM7XG4gIH1cbiAgcmV0dXJuIGF0dHJpYnV0ZXM7XG59XG4iXX0=
// /Users/mszylkowski/src/amphtml/src/iframe-attributes.js