/**
 * Copyright 2020 The AMP HTML Authors. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS-IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { assertHttpsUrl } from "../../../src/url";
import { CSS as attributionCSS } from "../../../build/amp-story-auto-ads-attribution-0.1.css";
import { createElementWithAttributes, iterateCursor } from "../../../src/core/dom";
import { createShadowRootWithStyle } from "../../amp-story/1.0/utils";
import { CSS as ctaButtonCSS } from "../../../build/amp-story-auto-ads-cta-button-0.1.css";
import { dev, user } from "../../../src/log";
import { dict, map } from "../../../src/core/types/object";
import { openWindowDialog } from "../../../src/open-window-dialog";

/**
 * @typedef {{
 *  cta-type: ?string,
 *  cta-url: ?string,
 *  cta-landing-page-type: ?string,
 *  attribution-icon: ?string,
 *  attribution-url: ?string,
 * }}
 */
export var StoryAdUIMetadata;

/** @const {string} */
var TAG = 'amp-story-auto-ads:ui';

/** @const {string} */
var CTA_META_PREFIX = 'amp-cta-';

/** @const {string} */
var A4A_VARS_META_PREFIX = 'amp4ads-vars-';
export var START_CTA_ANIMATION_ATTR = 'cta-active';

/** @enum {string} */
export var A4AVarNames = {
  ATTRIBUTION_ICON: 'attribution-icon',
  ATTRIBUTION_URL: 'attribution-url',
  CTA_TYPE: 'cta-type',
  CTA_URL: 'cta-url'
};

/** @enum {string} */
var DataAttrs = {
  CTA_TYPE: 'data-vars-ctatype',
  CTA_URL: 'data-vars-ctaurl'
};

/**
 * Finds all meta tags starting with `amp4ads-vars-` or `amp-cta`.
 * @param {Document} doc
 * @return {!IArrayLike}
 */
export function getStoryAdMetaTags(doc) {
  var selector = 'meta[name^=amp4ads-vars-],meta[name^=amp-cta-]';
  return doc.querySelectorAll(selector);
}

/**
 * Creates object containing information extracted from the creative
 * that is needed to render story ad ui e.g. cta, attribution, etc.
 * @param {!Document} doc
 * @return {StoryAdUIMetadata}
 */
export function getStoryAdMetadataFromDoc(doc) {
  var storyMetaTags = getStoryAdMetaTags(doc);
  var vars = map();
  iterateCursor(storyMetaTags, function (tag) {
    var content = tag.content,
        name = tag.name;

    if (name.startsWith(CTA_META_PREFIX)) {
      var key = name.split('amp-')[1];
      vars[key] = content;
    } else if (name.startsWith(A4A_VARS_META_PREFIX)) {
      var _key = name.split(A4A_VARS_META_PREFIX)[1];
      vars[_key] = content;
    }
  });
  return vars;
}

/**
 * Gets story ad UI metadata from the <amp-ad> element.
 * @param {!Element} adElement
 * @return {!Object}
 */
export function getStoryAdMetadataFromElement(adElement) {
  var _ref;

  var ctaUrl = adElement.getAttribute(DataAttrs.CTA_URL);
  var ctaType = adElement.getAttribute(DataAttrs.CTA_TYPE);
  return _ref = {}, _ref[A4AVarNames.CTA_TYPE] = ctaType, _ref[A4AVarNames.CTA_URL] = ctaUrl, _ref;
}

/**
 * Returns a boolean indicating if there is sufficent metadata to render CTA.
 * @param {!StoryAdUIMetadata} metadata
 * @param {boolean=} opt_inabox
 * @return {boolean}
 */
export function validateCtaMetadata(metadata, opt_inabox) {
  // If making a CTA layer we need a button name & outlink url.
  if (!metadata[A4AVarNames.CTA_TYPE] || !metadata[A4AVarNames.CTA_URL]) {
    // Don't polute inabox logs, as we don't know when this is intended to
    // be a story ad.
    !opt_inabox && user().error(TAG, 'Both CTA Type & CTA Url are required in ad response.');
    return false;
  }

  return true;
}

/**
 * Creates ad attribution UI if sufficent metadata. Returns element if
 * successfully created.
 * @param {!Window} win
 * @param {!StoryAdUIMetadata} metadata
 * @param {!Element} container
 * @return {?Element}
 */
export function maybeCreateAttribution(win, metadata, container) {
  var doc = win.document;

  try {
    var href = metadata[A4AVarNames.ATTRIBUTION_URL];
    var src = metadata[A4AVarNames.ATTRIBUTION_ICON];

    // Ad attribution is optional, but need both to render.
    if (!href || !src) {
      return null;
    }

    assertHttpsUrl(href, dev().assertElement(container), 'amp-story-auto-ads attribution url');
    assertHttpsUrl(src, dev().assertElement(container), 'amp-story-auto-ads attribution icon');
    var root = createElementWithAttributes(doc, 'div', dict({
      'role': 'button',
      'class': 'i-amphtml-attribution-host'
    }));
    var adChoicesIcon = createElementWithAttributes(doc, 'img', dict({
      'class': 'i-amphtml-story-ad-attribution',
      'src': src
    }));
    adChoicesIcon.addEventListener('click', function (unusedEvent) {
      return handleAttributionClick(win, href);
    });
    createShadowRootWithStyle(root, adChoicesIcon, attributionCSS);
    container.appendChild(root);
    return adChoicesIcon;
  } catch (e) {
    // If something goes wrong creating the attribution, we still want to
    // show the ad.
    return null;
  }
}

/**
 * Opens attribution click in new window.
 * @param {!Window} win
 * @param {string} href
 */
export function handleAttributionClick(win, href) {
  openWindowDialog(win, href, '_blank');
}

/**
 * @param {!Document} doc
 * @param {!./story-ad-button-text-fitter.ButtonTextFitter} buttonFitter
 * @param {!Element} container
 * @param {!StoryAdUIMetadata} uiMetadata
 * @return {!Promise<?Element>} If anchor was successfully created.
 */
export function createCta(doc, buttonFitter, container, uiMetadata) {
  var ctaUrl = uiMetadata[A4AVarNames.CTA_URL];
  var ctaText = uiMetadata[A4AVarNames.CTA_TYPE];
  var a = createElementWithAttributes(doc, 'a', dict({
    'class': 'i-amphtml-story-ad-link',
    'target': '_blank',
    'href': ctaUrl
  }));
  var fitPromise = buttonFitter.fit(dev().assertElement(container), a, // Container
  ctaText // Content
  );
  return fitPromise.then(function (success) {
    if (!success) {
      user().warn(TAG, 'CTA button text is too long. Ad was discarded.');
      return null;
    }

    a.href = ctaUrl;
    a.textContent = ctaText;

    if (a.protocol !== 'https:' && a.protocol !== 'http:') {
      user().warn(TAG, 'CTA url is not valid. Ad was discarded');
      return null;
    }

    var ctaLayer = doc.createElement('amp-story-cta-layer');
    ctaLayer.className = 'i-amphtml-cta-container';
    var linkRoot = createElementWithAttributes(doc, 'div', dict({
      'class': 'i-amphtml-story-ad-link-root',
      'role': 'button'
    }));
    createShadowRootWithStyle(linkRoot, a, ctaButtonCSS);
    ctaLayer.appendChild(linkRoot);
    container.appendChild(ctaLayer);
    return a;
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInN0b3J5LWFkLXVpLmpzIl0sIm5hbWVzIjpbImFzc2VydEh0dHBzVXJsIiwiQ1NTIiwiYXR0cmlidXRpb25DU1MiLCJjcmVhdGVFbGVtZW50V2l0aEF0dHJpYnV0ZXMiLCJpdGVyYXRlQ3Vyc29yIiwiY3JlYXRlU2hhZG93Um9vdFdpdGhTdHlsZSIsImN0YUJ1dHRvbkNTUyIsImRldiIsInVzZXIiLCJkaWN0IiwibWFwIiwib3BlbldpbmRvd0RpYWxvZyIsIlN0b3J5QWRVSU1ldGFkYXRhIiwiVEFHIiwiQ1RBX01FVEFfUFJFRklYIiwiQTRBX1ZBUlNfTUVUQV9QUkVGSVgiLCJTVEFSVF9DVEFfQU5JTUFUSU9OX0FUVFIiLCJBNEFWYXJOYW1lcyIsIkFUVFJJQlVUSU9OX0lDT04iLCJBVFRSSUJVVElPTl9VUkwiLCJDVEFfVFlQRSIsIkNUQV9VUkwiLCJEYXRhQXR0cnMiLCJnZXRTdG9yeUFkTWV0YVRhZ3MiLCJkb2MiLCJzZWxlY3RvciIsInF1ZXJ5U2VsZWN0b3JBbGwiLCJnZXRTdG9yeUFkTWV0YWRhdGFGcm9tRG9jIiwic3RvcnlNZXRhVGFncyIsInZhcnMiLCJ0YWciLCJjb250ZW50IiwibmFtZSIsInN0YXJ0c1dpdGgiLCJrZXkiLCJzcGxpdCIsImdldFN0b3J5QWRNZXRhZGF0YUZyb21FbGVtZW50IiwiYWRFbGVtZW50IiwiY3RhVXJsIiwiZ2V0QXR0cmlidXRlIiwiY3RhVHlwZSIsInZhbGlkYXRlQ3RhTWV0YWRhdGEiLCJtZXRhZGF0YSIsIm9wdF9pbmFib3giLCJlcnJvciIsIm1heWJlQ3JlYXRlQXR0cmlidXRpb24iLCJ3aW4iLCJjb250YWluZXIiLCJkb2N1bWVudCIsImhyZWYiLCJzcmMiLCJhc3NlcnRFbGVtZW50Iiwicm9vdCIsImFkQ2hvaWNlc0ljb24iLCJhZGRFdmVudExpc3RlbmVyIiwidW51c2VkRXZlbnQiLCJoYW5kbGVBdHRyaWJ1dGlvbkNsaWNrIiwiYXBwZW5kQ2hpbGQiLCJlIiwiY3JlYXRlQ3RhIiwiYnV0dG9uRml0dGVyIiwidWlNZXRhZGF0YSIsImN0YVRleHQiLCJhIiwiZml0UHJvbWlzZSIsImZpdCIsInRoZW4iLCJzdWNjZXNzIiwid2FybiIsInRleHRDb250ZW50IiwicHJvdG9jb2wiLCJjdGFMYXllciIsImNyZWF0ZUVsZW1lbnQiLCJjbGFzc05hbWUiLCJsaW5rUm9vdCJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBRUEsU0FBUUEsY0FBUjtBQUNBLFNBQVFDLEdBQUcsSUFBSUMsY0FBZjtBQUNBLFNBQVFDLDJCQUFSLEVBQXFDQyxhQUFyQztBQUNBLFNBQVFDLHlCQUFSO0FBQ0EsU0FBUUosR0FBRyxJQUFJSyxZQUFmO0FBQ0EsU0FBUUMsR0FBUixFQUFhQyxJQUFiO0FBQ0EsU0FBUUMsSUFBUixFQUFjQyxHQUFkO0FBQ0EsU0FBUUMsZ0JBQVI7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTyxJQUFJQyxpQkFBSjs7QUFFUDtBQUNBLElBQU1DLEdBQUcsR0FBRyx1QkFBWjs7QUFFQTtBQUNBLElBQU1DLGVBQWUsR0FBRyxVQUF4Qjs7QUFFQTtBQUNBLElBQU1DLG9CQUFvQixHQUFHLGVBQTdCO0FBRUEsT0FBTyxJQUFNQyx3QkFBd0IsR0FBRyxZQUFqQzs7QUFFUDtBQUNBLE9BQU8sSUFBTUMsV0FBVyxHQUFHO0FBQ3pCQyxFQUFBQSxnQkFBZ0IsRUFBRSxrQkFETztBQUV6QkMsRUFBQUEsZUFBZSxFQUFFLGlCQUZRO0FBR3pCQyxFQUFBQSxRQUFRLEVBQUUsVUFIZTtBQUl6QkMsRUFBQUEsT0FBTyxFQUFFO0FBSmdCLENBQXBCOztBQU9QO0FBQ0EsSUFBTUMsU0FBUyxHQUFHO0FBQ2hCRixFQUFBQSxRQUFRLEVBQUUsbUJBRE07QUFFaEJDLEVBQUFBLE9BQU8sRUFBRTtBQUZPLENBQWxCOztBQUtBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFD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QUFULEdBQXFCLHlCQUFyQjtBQUVBLFFBQU1DLFFBQVEsR0FBR3ZFLDJCQUEyQixDQUMxQ3FCLEdBRDBDLEVBRTFDLEtBRjBDLEVBRzFDZixJQUFJLENBQUM7QUFDSCxlQUFTLDhCQUROO0FBRUgsY0FBUTtBQUZMLEtBQUQsQ0FIc0MsQ0FBNUM7QUFTQUosSUFBQUEseUJBQXlCLENBQUNxRSxRQUFELEVBQVdYLENBQVgsRUFBY3pELFlBQWQsQ0FBekI7QUFFQWlFLElBQUFBLFFBQVEsQ0FBQ2QsV0FBVCxDQUFxQmlCLFFBQXJCO0FBQ0EzQixJQUFBQSxTQUFTLENBQUNVLFdBQVYsQ0FBc0JjLFFBQXRCO0FBQ0EsV0FBT1IsQ0FBUDtBQUNELEdBL0JNLENBQVA7QUFnQ0QiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAyMDIwIFRoZSBBTVAgSFRNTCBBdXRob3JzLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMtSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHthc3NlcnRIdHRwc1VybH0gZnJvbSAnLi4vLi4vLi4vc3JjL3VybCc7XG5pbXBvcnQge0NTUyBhcyBhdHRyaWJ1dGlvbkNTU30gZnJvbSAnLi4vLi4vLi4vYnVpbGQvYW1wLXN0b3J5LWF1dG8tYWRzLWF0dHJpYnV0aW9uLTAuMS5jc3MnO1xuaW1wb3J0IHtjcmVhdGVFbGVtZW50V2l0aEF0dHJpYnV0ZXMsIGl0ZXJhdGVDdXJzb3J9IGZyb20gJyNjb3JlL2RvbSc7XG5pbXBvcnQge2NyZWF0ZVNoYWRvd1Jvb3RXaXRoU3R5bGV9IGZyb20gJy4uLy4uL2FtcC1zdG9yeS8xLjAvdXRpbHMnO1xuaW1wb3J0IHtDU1MgYXMgY3RhQnV0dG9uQ1NTfSBmcm9tICcuLi8uLi8uLi9idWlsZC9hbXAtc3RvcnktYXV0by1hZHMtY3RhLWJ1dHRvbi0wLjEuY3NzJztcbmltcG9ydCB7ZGV2LCB1c2VyfSBmcm9tICcuLi8uLi8uLi9zcmMvbG9nJztcbmltcG9ydCB7ZGljdCwgbWFwfSBmcm9tICcjY29yZS90eXBlcy9vYmplY3QnO1xuaW1wb3J0IHtvcGVuV2luZG93RGlhbG9nfSBmcm9tICcuLi8uLi8uLi9zcmMvb3Blbi13aW5kb3ctZGlhbG9nJztcblxuLyoqXG4gKiBAdHlwZWRlZiB7e1xuICogIGN0YS10eXBlOiA/c3RyaW5nLFxuICogIGN0YS11cmw6ID9zdHJpbmcsXG4gKiAgY3RhLWxhbmRpbmctcGFnZS10eXBlOiA/c3RyaW5nLFxuICogIGF0dHJpYnV0aW9uLWljb246ID9zdHJpbmcsXG4gKiAgYXR0cmlidXRpb24tdXJsOiA/c3RyaW5nLFxuICogfX1cbiAqL1xuZXhwb3J0IGxldCBTdG9yeUFkVUlNZXRhZGF0YTtcblxuLyoqIEBjb25zdCB7c3RyaW5nfSAqL1xuY29uc3QgVEFHID0gJ2FtcC1zdG9yeS1hdXRvLWFkczp1aSc7XG5cbi8qKiBAY29uc3Qge3N0cmluZ30gKi9cbmNvbnN0IENUQV9NRVRBX1BSRUZJWCA9ICdhbXAtY3RhLSc7XG5cbi8qKiBAY29uc3Qge3N0cmluZ30gKi9cbmNvbnN0IEE0QV9WQVJTX01FVEFfUFJFRklYID0gJ2FtcDRhZHMtdmFycy0nO1xuXG5leHBvcnQgY29uc3QgU1RBUlRfQ1RBX0FOSU1BVElPTl9BVFRSID0gJ2N0YS1hY3RpdmUnO1xuXG4vKiogQGVudW0ge3N0cmluZ30gKi9cbmV4cG9ydCBjb25zdCBBNEFWYXJOYW1lcyA9IHtcbiAgQVRUUklCVVRJT05fSUNPTjogJ2F0dHJpYnV0aW9uLWljb24nLFxuICBBVFRSSUJVVElPTl9VUkw6ICdhdHRyaWJ1dGlvbi11cmwnLFxuICBDVEFfVFlQRTogJ2N0YS10eXBlJyxcbiAgQ1RBX1VSTDogJ2N0YS11cmwnLFxufTtcblxuLyoqIEBlbnVtIHtzdHJpbmd9ICovXG5jb25zdCBEYXRhQXR0cnMgPSB7XG4gIENUQV9UWVBFOiAnZGF0YS12YXJzLWN0YXR5cGUnLFxuICBDVEFfVVJMOiAnZGF0YS12YXJzLWN0YXVybCcsXG59O1xuXG4vKipcbiAqIEZpbmRzIGFsbCBtZXRhIHRhZ3Mgc3RhcnRpbmcgd2l0aCBgYW1wNGFkcy12YXJzLWAgb3IgYGFtcC1jdGFgLlxuICogQHBhcmFtIHtEb2N1bWVudH0gZG9jXG4gKiBAcmV0dXJuIHshSUFycmF5TGlrZX1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFN0b3J5QWRNZXRhVGFncyhkb2MpIHtcbiAgY29uc3Qgc2VsZWN0b3IgPSAnbWV0YVtuYW1lXj1hbXA0YWRzLXZhcnMtXSxtZXRhW25hbWVePWFtcC1jdGEtXSc7XG4gIHJldHVybiBkb2MucXVlcnlTZWxlY3RvckFsbChzZWxlY3Rvcik7XG59XG5cbi8qKlxuICogQ3JlYXRlcyBvYmplY3QgY29udGFpbmluZyBpbmZvcm1hdGlvbiBleHRyYWN0ZWQgZnJvbSB0aGUgY3JlYXRpdmVcbiAqIHRoYXQgaXMgbmVlZGVkIHRvIHJlbmRlciBzdG9yeSBhZCB1aSBlLmcuIGN0YSwgYXR0cmlidXRpb24sIGV0Yy5cbiAqIEBwYXJhbSB7IURvY3VtZW50fSBkb2NcbiAqIEByZXR1cm4ge1N0b3J5QWRVSU1ldGFkYXRhfVxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0U3RvcnlBZE1ldGFkYXRhRnJvbURvYyhkb2MpIHtcbiAgY29uc3Qgc3RvcnlNZXRhVGFncyA9IGdldFN0b3J5QWRNZXRhVGFncyhkb2MpO1xuICBjb25zdCB2YXJzID0gbWFwKCk7XG4gIGl0ZXJhdGVDdXJzb3Ioc3RvcnlNZXRhVGFncywgKHRhZykgPT4ge1xuICAgIGNvbnN0IHtjb250ZW50LCBuYW1lfSA9IHRhZztcbiAgICBpZiAobmFtZS5zdGFydHNXaXRoKENUQV9NRVRBX1BSRUZJWCkpIHtcbiAgICAgIGNvbnN0IGtleSA9IG5hbWUuc3BsaXQoJ2FtcC0nKVsxXTtcbiAgICAgIHZhcnNba2V5XSA9IGNvbnRlbnQ7XG4gICAgfSBlbHNlIGlmIChuYW1lLnN0YXJ0c1dpdGgoQTRBX1ZBUlNfTUVUQV9QUkVGSVgpKSB7XG4gICAgICBjb25zdCBrZXkgPSBuYW1lLnNwbGl0KEE0QV9WQVJTX01FVEFfUFJFRklYKVsxXTtcbiAgICAgIHZhcnNba2V5XSA9IGNvbnRlbnQ7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIHZhcnM7XG59XG5cbi8qKlxuICogR2V0cyBzdG9yeSBhZCBVSSBtZXRhZGF0YSBmcm9tIHRoZSA8YW1wLWFkPiBlbGVtZW50LlxuICogQHBhcmFtIHshRWxlbWVudH0gYWRFbGVtZW50XG4gKiBAcmV0dXJuIHshT2JqZWN0fVxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0U3RvcnlBZE1ldGFkYXRhRnJvbUVsZW1lbnQoYWRFbGVtZW50KSB7XG4gIGNvbnN0IGN0YVVybCA9IGFkRWxlbWVudC5nZXRBdHRyaWJ1dGUoRGF0YUF0dHJzLkNUQV9VUkwpO1xuICBjb25zdCBjdGFUeXBlID0gYWRFbGVtZW50LmdldEF0dHJpYnV0ZShEYXRhQXR0cnMuQ1RBX1RZUEUpO1xuICByZXR1cm4ge1xuICAgIFtBNEFWYXJOYW1lcy5DVEFfVFlQRV06IGN0YVR5cGUsXG4gICAgW0E0QVZhck5hbWVzLkNUQV9VUkxdOiBjdGFVcmwsXG4gIH07XG59XG5cbi8qKlxuICogUmV0dXJucyBhIGJvb2xlYW4gaW5kaWNhdGluZyBpZiB0aGVyZSBpcyBzdWZmaWNlbnQgbWV0YWRhdGEgdG8gcmVuZGVyIENUQS5cbiAqIEBwYXJhbSB7IVN0b3J5QWRVSU1ldGFkYXRhfSBtZXRhZGF0YVxuICogQHBhcmFtIHtib29sZWFuPX0gb3B0X2luYWJveFxuICogQHJldHVybiB7Ym9vbGVhbn1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkYXRlQ3RhTWV0YWRhdGEobWV0YWRhdGEsIG9wdF9pbmFib3gpIHtcbiAgLy8gSWYgbWFraW5nIGEgQ1RBIGxheWVyIHdlIG5lZWQgYSBidXR0b24gbmFtZSAmIG91dGxpbmsgdXJsLlxuICBpZiAoIW1ldGFkYXRhW0E0QVZhck5hbWVzLkNUQV9UWVBFXSB8fCAhbWV0YWRhdGFbQTRBVmFyTmFtZXMuQ1RBX1VSTF0pIHtcbiAgICAvLyBEb24ndCBwb2x1dGUgaW5hYm94IGxvZ3MsIGFzIHdlIGRvbid0IGtub3cgd2hlbiB0aGlzIGlzIGludGVuZGVkIHRvXG4gICAgLy8gYmUgYSBzdG9yeSBhZC5cbiAgICAhb3B0X2luYWJveCAmJlxuICAgICAgdXNlcigpLmVycm9yKFRBRywgJ0JvdGggQ1RBIFR5cGUgJiBDVEEgVXJsIGFyZSByZXF1aXJlZCBpbiBhZCByZXNwb25zZS4nKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgcmV0dXJuIHRydWU7XG59XG5cbi8qKlxuICogQ3JlYXRlcyBhZCBhdHRyaWJ1dGlvbiBVSSBpZiBzdWZmaWNlbnQgbWV0YWRhdGEuIFJldHVybnMgZWxlbWVudCBpZlxuICogc3VjY2Vzc2Z1bGx5IGNyZWF0ZWQuXG4gKiBAcGFyYW0geyFXaW5kb3d9IHdpblxuICogQHBhcmFtIHshU3RvcnlBZFVJTWV0YWRhdGF9IG1ldGFkYXRhXG4gKiBAcGFyYW0geyFFbGVtZW50fSBjb250YWluZXJcbiAqIEByZXR1cm4gez9FbGVtZW50fVxuICovXG5leHBvcnQgZnVuY3Rpb24gbWF5YmVDcmVhdGVBdHRyaWJ1dGlvbih3aW4sIG1ldGFkYXRhLCBjb250YWluZXIpIHtcbiAgY29uc3QgZG9jID0gd2luLmRvY3VtZW50O1xuXG4gIHRyeSB7XG4gICAgY29uc3QgaHJlZiA9IG1ldGFkYXRhW0E0QVZhck5hbWVzLkFUVFJJQlVUSU9OX1VSTF07XG4gICAgY29uc3Qgc3JjID0gbWV0YWRhdGFbQTRBVmFyTmFtZXMuQVRUUklCVVRJT05fSUNPTl07XG5cbiAgICAvLyBBZCBhdHRyaWJ1dGlvbiBpcyBvcHRpb25hbCwgYnV0IG5lZWQgYm90aCB0byByZW5kZXIuXG4gICAgaWYgKCFocmVmIHx8ICFzcmMpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGFzc2VydEh0dHBzVXJsKFxuICAgICAgaHJlZixcbiAgICAgIGRldigpLmFzc2VydEVsZW1lbnQoY29udGFpbmVyKSxcbiAgICAgICdhbXAtc3RvcnktYXV0by1hZHMgYXR0cmlidXRpb24gdXJsJ1xuICAgICk7XG5cbiAgICBhc3NlcnRIdHRwc1VybChcbiAgICAgIHNyYyxcbiAgICAgIGRldigpLmFzc2VydEVsZW1lbnQoY29udGFpbmVyKSxcbiAgICAgICdhbXAtc3RvcnktYXV0by1hZHMgYXR0cmlidXRpb24gaWNvbidcbiAgICApO1xuXG4gICAgY29uc3Qgcm9vdCA9IGNyZWF0ZUVsZW1lbnRXaXRoQXR0cmlidXRlcyhcbiAgICAgIGRvYyxcbiAgICAgICdkaXYnLFxuICAgICAgZGljdCh7XG4gICAgICAgICdyb2xlJzogJ2J1dHRvbicsXG4gICAgICAgICdjbGFzcyc6ICdpLWFtcGh0bWwtYXR0cmlidXRpb24taG9zdCcsXG4gICAgICB9KVxuICAgICk7XG5cbiAgICBjb25zdCBhZENob2ljZXNJY29uID0gY3JlYXRlRWxlbWVudFdpdGhBdHRyaWJ1dGVzKFxuICAgICAgZG9jLFxuICAgICAgJ2ltZycsXG4gICAgICBkaWN0KHtcbiAgICAgICAgJ2NsYXNzJzogJ2ktYW1waHRtbC1zdG9yeS1hZC1hdHRyaWJ1dGlvbicsXG4gICAgICAgICdzcmMnOiBzcmMsXG4gICAgICB9KVxuICAgICk7XG5cbiAgICBhZENob2ljZXNJY29uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKHVudXNlZEV2ZW50KSA9PlxuICAgICAgaGFuZGxlQXR0cmlidXRpb25DbGljayh3aW4sIGhyZWYpXG4gICAgKTtcblxuICAgIGNyZWF0ZVNoYWRvd1Jvb3RXaXRoU3R5bGUocm9vdCwgYWRDaG9pY2VzSWNvbiwgYXR0cmlidXRpb25DU1MpO1xuICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChyb290KTtcblxuICAgIHJldHVybiBhZENob2ljZXNJY29uO1xuICB9IGNhdGNoIChlKSB7XG4gICAgLy8gSWYgc29tZXRoaW5nIGdvZXMgd3JvbmcgY3JlYXRpbmcgdGhlIGF0dHJpYnV0aW9uLCB3ZSBzdGlsbCB3YW50IHRvXG4gICAgLy8gc2hvdyB0aGUgYWQuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cblxuLyoqXG4gKiBPcGVucyBhdHRyaWJ1dGlvbiBjbGljayBpbiBuZXcgd2luZG93LlxuICogQHBhcmFtIHshV2luZG93fSB3aW5cbiAqIEBwYXJhbSB7c3RyaW5nfSBocmVmXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBoYW5kbGVBdHRyaWJ1dGlvbkNsaWNrKHdpbiwgaHJlZikge1xuICBvcGVuV2luZG93RGlhbG9nKHdpbiwgaHJlZiwgJ19ibGFuaycpO1xufVxuXG4vKipcbiAqIEBwYXJhbSB7IURvY3VtZW50fSBkb2NcbiAqIEBwYXJhbSB7IS4vc3RvcnktYWQtYnV0dG9uLXRleHQtZml0dGVyLkJ1dHRvblRleHRGaXR0ZXJ9IGJ1dHRvbkZpdHRlclxuICogQHBhcmFtIHshRWxlbWVudH0gY29udGFpbmVyXG4gKiBAcGFyYW0geyFTdG9yeUFkVUlNZXRhZGF0YX0gdWlNZXRhZGF0YVxuICogQHJldHVybiB7IVByb21pc2U8P0VsZW1lbnQ+fSBJZiBhbmNob3Igd2FzIHN1Y2Nlc3NmdWxseSBjcmVhdGVkLlxuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQ3RhKGRvYywgYnV0dG9uRml0dGVyLCBjb250YWluZXIsIHVpTWV0YWRhdGEpIHtcbiAgY29uc3QgY3RhVXJsID0gdWlNZXRhZGF0YVtBNEFWYXJOYW1lcy5DVEFfVVJMXTtcbiAgY29uc3QgY3RhVGV4dCA9IHVpTWV0YWRhdGFbQTRBVmFyTmFtZXMuQ1RBX1RZUEVdO1xuXG4gIGNvbnN0IGEgPSBjcmVhdGVFbGVtZW50V2l0aEF0dHJpYnV0ZXMoXG4gICAgZG9jLFxuICAgICdhJyxcbiAgICBkaWN0KHtcbiAgICAgICdjbGFzcyc6ICdpLWFtcGh0bWwtc3RvcnktYWQtbGluaycsXG4gICAgICAndGFyZ2V0JzogJ19ibGFuaycsXG4gICAgICAnaHJlZic6IGN0YVVybCxcbiAgICB9KVxuICApO1xuXG4gIGNvbnN0IGZpdFByb21pc2UgPSBidXR0b25GaXR0ZXIuZml0KFxuICAgIGRldigpLmFzc2VydEVsZW1lbnQoY29udGFpbmVyKSxcbiAgICBhLCAvLyBDb250YWluZXJcbiAgICBjdGFUZXh0IC8vIENvbnRlbnRcbiAgKTtcblxuICByZXR1cm4gZml0UHJvbWlzZS50aGVuKChzdWNjZXNzKSA9PiB7XG4gICAgaWYgKCFzdWNjZXNzKSB7XG4gICAgICB1c2VyKCkud2FybihUQUcsICdDVEEgYnV0dG9uIHRleHQgaXMgdG9vIGxvbmcuIEFkIHdhcyBkaXNjYXJkZWQuJyk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBhLmhyZWYgPSBjdGFVcmw7XG4gICAgYS50ZXh0Q29udGVudCA9IGN0YVRleHQ7XG5cbiAgICBpZiAoYS5wcm90b2NvbCAhPT0gJ2h0dHBzOicgJiYgYS5wcm90b2NvbCAhPT0gJ2h0dHA6Jykge1xuICAgICAgdXNlcigpLndhcm4oVEFHLCAnQ1RBIHVybCBpcyBub3QgdmFsaWQuIEFkIHdhcyBkaXNjYXJkZWQnKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IGN0YUxheWVyID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2FtcC1zdG9yeS1jdGEtbGF5ZXInKTtcbiAgICBjdGFMYXllci5jbGFzc05hbWUgPSAnaS1hbXBodG1sLWN0YS1jb250YWluZXInO1xuXG4gICAgY29uc3QgbGlua1Jvb3QgPSBjcmVhdGVFbGVtZW50V2l0aEF0dHJpYnV0ZXMoXG4gICAgICBkb2MsXG4gICAgICAnZGl2JyxcbiAgICAgIGRpY3Qoe1xuICAgICAgICAnY2xhc3MnOiAnaS1hbXBodG1sLXN0b3J5LWFkLWxpbmstcm9vdCcsXG4gICAgICAgICdyb2xlJzogJ2J1dHRvbicsXG4gICAgICB9KVxuICAgICk7XG5cbiAgICBjcmVhdGVTaGFkb3dSb290V2l0aFN0eWxlKGxpbmtSb290LCBhLCBjdGFCdXR0b25DU1MpO1xuXG4gICAgY3RhTGF5ZXIuYXBwZW5kQ2hpbGQobGlua1Jvb3QpO1xuICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChjdGFMYXllcik7XG4gICAgcmV0dXJuIGE7XG4gIH0pO1xufVxuIl19
// /Users/mszylkowski/src/amphtml/extensions/amp-story-auto-ads/0.1/story-ad-ui.js