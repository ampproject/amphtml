/**
 * Copyright 2020 The AMP HTML Authors. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS-IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { computedStyle } from "../style";
import { tryCallback } from "../../error";
import { remove } from "../../types/array";
import { toWin } from "../../window";
import { LayoutSizeDef } from "./rect";

/** @typedef {!LayoutSizeDef|!ResizeObserverSize} TargetSize */

/** @enum {number} */
var Type = {
  /**
   * Mapped to the `ResizeObserverEntry.contentRect` and returns a
   * `LayoutSizeDef` value.
   */
  CONTENT: 0,

  /**
   * Mapped to the `ResizeObserverEntry.borderBoxSize` and returns a
   * `ResizeObserverSize` value.
   */
  BORDER_BOX: 1
};
var VERTICAL_RE = /vertical/;

/** @const {!WeakMap<!Window, !ResizeObserver>} */
var observers = /* #__PURE__ */new WeakMap();

/**
 * @const {!WeakMap<!Element, !Array<{
 *   type: !Type,
 *   callback: (function(!LayoutSizeDef)|function(!ResizeObserverSize))
 * }>>}
 */
var targetObserverMultimap = /* #__PURE__ */new WeakMap();

/** @const {!WeakMap<!Element, !ResizeObserverEntry>} */
var targetEntryMap = /* #__PURE__ */new WeakMap();

/**
 * @param {!Element} element
 * @param {function(!LayoutSizeDef)} callback
 */
export function observeContentSize(element, callback) {
  observeSize(element, Type.CONTENT, callback);
}

/**
 * @param {!Element} element
 * @param {function(!LayoutSizeDef)} callback
 */
export function unobserveContentSize(element, callback) {
  unobserveSize(element, Type.CONTENT, callback);
}

/**
 * @param {!Element} element
 * @return {!Promise<!LayoutSizeDef>}
 */
export function measureContentSize(element) {
  return new Promise(function (resolve) {
    var onSize = function onSize(size) {
      resolve(size);
      unobserveContentSize(element, onSize);
    };

    observeContentSize(element, onSize);
  });
}

/**
 * Note: this method doesn't support multi-fragment border boxes.
 * @param {!Element} element
 * @param {function(!ResizeObserverSize)} callback
 */
export function observeBorderBoxSize(element, callback) {
  observeSize(element, Type.BORDER_BOX, callback);
}

/**
 * Note: this method doesn't support multi-fragment border boxes.
 * @param {!Element} element
 * @param {function(!ResizeObserverSize)} callback
 */
export function unobserveBorderBoxSize(element, callback) {
  unobserveSize(element, Type.BORDER_BOX, callback);
}

/**
 * Note: this method doesn't support multi-fragment border boxes.
 * @param {!Element} element
 * @return {!Promise<!ResizeObserverSize>}
 */
export function measureBorderBoxSize(element) {
  return new Promise(function (resolve) {
    var onSize = function onSize(size) {
      resolve(size);
      unobserveBorderBoxSize(element, onSize);
    };

    observeBorderBoxSize(element, onSize);
  });
}

/**
 * @param {!Element} element
 * @param {!Type} type
 * @param {function(!LayoutSizeDef)|function(!ResizeObserverSize)} callback
 */
function observeSize(element, type, callback) {
  var win = element.ownerDocument.defaultView;

  if (!win) {
    return;
  }

  var callbacks = targetObserverMultimap.get(element);

  if (!callbacks) {
    callbacks = [];
    targetObserverMultimap.set(element, callbacks);
    getObserver(win).observe(element);
  }

  var exists = callbacks.some(function (cb) {
    return cb.callback === callback && cb.type === type;
  });

  if (!exists) {
    callbacks.push({
      type: type,
      callback: callback
    });
    var entry = targetEntryMap.get(element);

    if (entry) {
      setTimeout(function () {
        return computeAndCall(type, callback, entry);
      });
    }
  }
}

/**
 * @param {!Element} element
 * @param {!Type} type
 * @param {function(!LayoutSizeDef)|function(!ResizeObserverSize)} callback
 */
function unobserveSize(element, type, callback) {
  var callbacks = targetObserverMultimap.get(element);

  if (!callbacks) {
    return;
  }

  remove(callbacks, function (cb) {
    return cb.callback === callback && cb.type === type;
  });

  if (callbacks.length == 0) {
    targetObserverMultimap.delete(element);
    targetEntryMap.delete(element);
    var win = element.ownerDocument.defaultView;

    if (win) {
      getObserver(win).unobserve(element);
    }
  }
}

/**
 * @param {!Window} win
 * @return {!ResizeObserver}
 */
function getObserver(win) {
  var observer = observers.get(win);

  if (!observer) {
    observer = new win.ResizeObserver(processEntries);
    observers.set(win, observer);
  }

  return observer;
}

/**
 * @param {!Array<!ResizeObserverEntry>} entries
 */
function processEntries(entries) {
  var seen = new Set();

  for (var i = entries.length - 1; i >= 0; i--) {
    var entry = entries[i];
    var target = entry.target;

    if (seen.has(target)) {
      continue;
    }

    seen.add(target);
    var callbacks = targetObserverMultimap.get(target);

    if (!callbacks) {
      continue;
    }

    targetEntryMap.set(target, entry);

    for (var k = 0; k < callbacks.length; k++) {
      var _callbacks$k = callbacks[k],
          callback = _callbacks$k.callback,
          type = _callbacks$k.type;
      computeAndCall(type, callback, entry);
    }
  }
}

/**
 * @param {Type} type
 * @param {function(!LayoutSizeDef)|function(!ResizeObserverSize)} callback
 * @param {!ResizeObserverEntry} entry
 */
function computeAndCall(type, callback, entry) {
  if (type == Type.CONTENT) {
    var contentRect = entry.contentRect;
    var height = contentRect.height,
        width = contentRect.width;

    /** @type {!LayoutSizeDef} */
    var size = {
      width: width,
      height: height
    };
    tryCallback(callback, size);
  } else if (type == Type.BORDER_BOX) {
    var borderBoxSizeArray = entry.borderBoxSize;

    /** @type {!ResizeObserverSize} */
    var borderBoxSize;

    if (borderBoxSizeArray) {
      // `borderBoxSize` is supported. Only single-fragment border boxes are
      // supported here (`borderBoxSize[0]`).
      if (borderBoxSizeArray.length > 0) {
        borderBoxSize = borderBoxSizeArray[0];
      } else {
        borderBoxSize =
        /** @type {!ResizeObserverSize} */
        {
          inlineSize: 0,
          blockSize: 0
        };
      }
    } else {
      // `borderBoxSize` is not supported: polyfill it via blocking measures.
      var target = entry.target;
      var win = toWin(target.ownerDocument.defaultView);
      var isVertical = VERTICAL_RE.test(computedStyle(win, target)['writing-mode']);
      var offsetHeight =
      /** @type {!HTMLElement} */
      target.offsetHeight,
          offsetWidth =
      /** @type {!HTMLElement} */
      target.offsetWidth;
      var inlineSize, blockSize;

      if (isVertical) {
        blockSize = offsetWidth;
        inlineSize = offsetHeight;
      } else {
        inlineSize = offsetWidth;
        blockSize = offsetHeight;
      }

      borderBoxSize = {
        inlineSize: inlineSize,
        blockSize: blockSize
      };
    }

    tryCallback(callback, borderBoxSize);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNpemUtb2JzZXJ2ZXIuanMiXSwibmFtZXMiOlsiY29tcHV0ZWRTdHlsZSIsInRyeUNhbGxiYWNrIiwicmVtb3ZlIiwidG9XaW4iLCJMYXlvdXRTaXplRGVmIiwiVHlwZSIsIkNPTlRFTlQiLCJCT1JERVJfQk9YIiwiVkVSVElDQUxfUkUiLCJvYnNlcnZlcnMiLCJXZWFrTWFwIiwidGFyZ2V0T2JzZXJ2ZXJNdWx0aW1hcCIsInRhcmdldEVudHJ5TWFwIiwib2JzZXJ2ZUNvbnRlbnRTaXplIiwiZWxlbWVudCIsImNhbGxiYWNrIiwib2JzZXJ2ZVNpemUiLCJ1bm9ic2VydmVDb250ZW50U2l6ZSIsInVub2JzZXJ2ZVNpemUiLCJtZWFzdXJlQ29udGVudFNpemUiLCJQcm9taXNlIiwicmVzb2x2ZSIsIm9uU2l6ZSIsInNpemUiLCJvYnNlcnZlQm9yZGVyQm94U2l6ZSIsInVub2JzZXJ2ZUJvcmRlckJveFNpemUiLCJtZWFzdXJlQm9yZGVyQm94U2l6ZSIsInR5cGUiLCJ3aW4iLCJvd25lckRvY3VtZW50IiwiZGVmYXVsdFZpZXciLCJjYWxsYmFja3MiLCJnZXQiLCJzZXQiLCJnZXRPYnNlcnZlciIsIm9ic2VydmUiLCJleGlzdHMiLCJzb21lIiwiY2IiLCJwdXNoIiwiZW50cnkiLCJzZXRUaW1lb3V0IiwiY29tcHV0ZUFuZENhbGwiLCJsZW5ndGgiLCJkZWxldGUiLCJ1bm9ic2VydmUiLCJvYnNlcnZlciIsIlJlc2l6ZU9ic2VydmVyIiwicHJvY2Vzc0VudHJpZXMiLCJlbnRyaWVzIiwic2VlbiIsIlNldCIsImkiLCJ0YXJnZXQiLCJoYXMiLCJhZGQiLCJrIiwiY29udGVudFJlY3QiLCJoZWlnaHQiLCJ3aWR0aCIsImJvcmRlckJveFNpemVBcnJheSIsImJvcmRlckJveFNpemUiLCJpbmxpbmVTaXplIiwiYmxvY2tTaXplIiwiaXNWZXJ0aWNhbCIsInRlc3QiLCJvZmZzZXRIZWlnaHQiLCJvZmZzZXRXaWR0aCJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNB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TUFBakUsQ0FBcUJjLFdBQXJCO0FBQ0EsVUFBSUwsVUFBSixFQUFnQkMsU0FBaEI7O0FBQ0EsVUFBSUMsVUFBSixFQUFnQjtBQUNkRCxRQUFBQSxTQUFTLEdBQUdJLFdBQVo7QUFDQUwsUUFBQUEsVUFBVSxHQUFHSSxZQUFiO0FBQ0QsT0FIRCxNQUdPO0FBQ0xKLFFBQUFBLFVBQVUsR0FBR0ssV0FBYjtBQUNBSixRQUFBQSxTQUFTLEdBQUdHLFlBQVo7QUFDRDs7QUFDREwsTUFBQUEsYUFBYSxHQUFHO0FBQUNDLFFBQUFBLFVBQVUsRUFBVkEsVUFBRDtBQUFhQyxRQUFBQSxTQUFTLEVBQVRBO0FBQWIsT0FBaEI7QUFDRDs7QUFDRDlELElBQUFBLFdBQVcsQ0FBQ2MsUUFBRCxFQUFXOEMsYUFBWCxDQUFYO0FBQ0Q7QUFDRiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IDIwMjAgVGhlIEFNUCBIVE1MIEF1dGhvcnMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUy1JU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQge2NvbXB1dGVkU3R5bGV9IGZyb20gJyNjb3JlL2RvbS9zdHlsZSc7XG5pbXBvcnQge3RyeUNhbGxiYWNrfSBmcm9tICcjY29yZS9lcnJvcic7XG5pbXBvcnQge3JlbW92ZX0gZnJvbSAnI2NvcmUvdHlwZXMvYXJyYXknO1xuaW1wb3J0IHt0b1dpbn0gZnJvbSAnI2NvcmUvd2luZG93JztcblxuaW1wb3J0IHtMYXlvdXRTaXplRGVmfSBmcm9tICcuL3JlY3QnO1xuXG4vKiogQHR5cGVkZWYgeyFMYXlvdXRTaXplRGVmfCFSZXNpemVPYnNlcnZlclNpemV9IFRhcmdldFNpemUgKi9cblxuLyoqIEBlbnVtIHtudW1iZXJ9ICovXG5jb25zdCBUeXBlID0ge1xuICAvKipcbiAgICogTWFwcGVkIHRvIHRoZSBgUmVzaXplT2JzZXJ2ZXJFbnRyeS5jb250ZW50UmVjdGAgYW5kIHJldHVybnMgYVxuICAgKiBgTGF5b3V0U2l6ZURlZmAgdmFsdWUuXG4gICAqL1xuICBDT05URU5UOiAwLFxuICAvKipcbiAgICogTWFwcGVkIHRvIHRoZSBgUmVzaXplT2JzZXJ2ZXJFbnRyeS5ib3JkZXJCb3hTaXplYCBhbmQgcmV0dXJucyBhXG4gICAqIGBSZXNpemVPYnNlcnZlclNpemVgIHZhbHVlLlxuICAgKi9cbiAgQk9SREVSX0JPWDogMSxcbn07XG5cbmNvbnN0IFZFUlRJQ0FMX1JFID0gL3ZlcnRpY2FsLztcblxuLyoqIEBjb25zdCB7IVdlYWtNYXA8IVdpbmRvdywgIVJlc2l6ZU9ic2VydmVyPn0gKi9cbmNvbnN0IG9ic2VydmVycyA9IC8qICNfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpO1xuXG4vKipcbiAqIEBjb25zdCB7IVdlYWtNYXA8IUVsZW1lbnQsICFBcnJheTx7XG4gKiAgIHR5cGU6ICFUeXBlLFxuICogICBjYWxsYmFjazogKGZ1bmN0aW9uKCFMYXlvdXRTaXplRGVmKXxmdW5jdGlvbighUmVzaXplT2JzZXJ2ZXJTaXplKSlcbiAqIH0+Pn1cbiAqL1xuY29uc3QgdGFyZ2V0T2JzZXJ2ZXJNdWx0aW1hcCA9IC8qICNfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpO1xuXG4vKiogQGNvbnN0IHshV2Vha01hcDwhRWxlbWVudCwgIVJlc2l6ZU9ic2VydmVyRW50cnk+fSAqL1xuY29uc3QgdGFyZ2V0RW50cnlNYXAgPSAvKiAjX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTtcblxuLyoqXG4gKiBAcGFyYW0geyFFbGVtZW50fSBlbGVtZW50XG4gKiBAcGFyYW0ge2Z1bmN0aW9uKCFMYXlvdXRTaXplRGVmKX0gY2FsbGJhY2tcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG9ic2VydmVDb250ZW50U2l6ZShlbGVtZW50LCBjYWxsYmFjaykge1xuICBvYnNlcnZlU2l6ZShlbGVtZW50LCBUeXBlLkNPTlRFTlQsIGNhbGxiYWNrKTtcbn1cblxuLyoqXG4gKiBAcGFyYW0geyFFbGVtZW50fSBlbGVtZW50XG4gKiBAcGFyYW0ge2Z1bmN0aW9uKCFMYXlvdXRTaXplRGVmKX0gY2FsbGJhY2tcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHVub2JzZXJ2ZUNvbnRlbnRTaXplKGVsZW1lbnQsIGNhbGxiYWNrKSB7XG4gIHVub2JzZXJ2ZVNpemUoZWxlbWVudCwgVHlwZS5DT05URU5ULCBjYWxsYmFjayk7XG59XG5cbi8qKlxuICogQHBhcmFtIHshRWxlbWVudH0gZWxlbWVudFxuICogQHJldHVybiB7IVByb21pc2U8IUxheW91dFNpemVEZWY+fVxuICovXG5leHBvcnQgZnVuY3Rpb24gbWVhc3VyZUNvbnRlbnRTaXplKGVsZW1lbnQpIHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgY29uc3Qgb25TaXplID0gKHNpemUpID0+IHtcbiAgICAgIHJlc29sdmUoc2l6ZSk7XG4gICAgICB1bm9ic2VydmVDb250ZW50U2l6ZShlbGVtZW50LCBvblNpemUpO1xuICAgIH07XG4gICAgb2JzZXJ2ZUNvbnRlbnRTaXplKGVsZW1lbnQsIG9uU2l6ZSk7XG4gIH0pO1xufVxuXG4vKipcbiAqIE5vdGU6IHRoaXMgbWV0aG9kIGRvZXNuJ3Qgc3VwcG9ydCBtdWx0aS1mcmFnbWVudCBib3JkZXIgYm94ZXMuXG4gKiBAcGFyYW0geyFFbGVtZW50fSBlbGVtZW50XG4gKiBAcGFyYW0ge2Z1bmN0aW9uKCFSZXNpemVPYnNlcnZlclNpemUpfSBjYWxsYmFja1xuICovXG5leHBvcnQgZnVuY3Rpb24gb2JzZXJ2ZUJvcmRlckJveFNpemUoZWxlbWVudCwgY2FsbGJhY2spIHtcbiAgb2JzZXJ2ZVNpemUoZWxlbWVudCwgVHlwZS5CT1JERVJfQk9YLCBjYWxsYmFjayk7XG59XG5cbi8qKlxuICogTm90ZTogdGhpcyBtZXRob2QgZG9lc24ndCBzdXBwb3J0IG11bHRpLWZyYWdtZW50IGJvcmRlciBib3hlcy5cbiAqIEBwYXJhbSB7IUVsZW1lbnR9IGVsZW1lbnRcbiAqIEBwYXJhbSB7ZnVuY3Rpb24oIVJlc2l6ZU9ic2VydmVyU2l6ZSl9IGNhbGxiYWNrXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB1bm9ic2VydmVCb3JkZXJCb3hTaXplKGVsZW1lbnQsIGNhbGxiYWNrKSB7XG4gIHVub2JzZXJ2ZVNpemUoZWxlbWVudCwgVHlwZS5CT1JERVJfQk9YLCBjYWxsYmFjayk7XG59XG5cbi8qKlxuICogTm90ZTogdGhpcyBtZXRob2QgZG9lc24ndCBzdXBwb3J0IG11bHRpLWZyYWdtZW50IGJvcmRlciBib3hlcy5cbiAqIEBwYXJhbSB7IUVsZW1lbnR9IGVsZW1lbnRcbiAqIEByZXR1cm4geyFQcm9taXNlPCFSZXNpemVPYnNlcnZlclNpemU+fVxuICovXG5leHBvcnQgZnVuY3Rpb24gbWVhc3VyZUJvcmRlckJveFNpemUoZWxlbWVudCkge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICBjb25zdCBvblNpemUgPSAoc2l6ZSkgPT4ge1xuICAgICAgcmVzb2x2ZShzaXplKTtcbiAgICAgIHVub2JzZXJ2ZUJvcmRlckJveFNpemUoZWxlbWVudCwgb25TaXplKTtcbiAgICB9O1xuICAgIG9ic2VydmVCb3JkZXJCb3hTaXplKGVsZW1lbnQsIG9uU2l6ZSk7XG4gIH0pO1xufVxuXG4vKipcbiAqIEBwYXJhbSB7IUVsZW1lbnR9IGVsZW1lbnRcbiAqIEBwYXJhbSB7IVR5cGV9IHR5cGVcbiAqIEBwYXJhbSB7ZnVuY3Rpb24oIUxheW91dFNpemVEZWYpfGZ1bmN0aW9uKCFSZXNpemVPYnNlcnZlclNpemUpfSBjYWxsYmFja1xuICovXG5mdW5jdGlvbiBvYnNlcnZlU2l6ZShlbGVtZW50LCB0eXBlLCBjYWxsYmFjaykge1xuICBjb25zdCB3aW4gPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXc7XG4gIGlmICghd2luKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGxldCBjYWxsYmFja3MgPSB0YXJnZXRPYnNlcnZlck11bHRpbWFwLmdldChlbGVtZW50KTtcbiAgaWYgKCFjYWxsYmFja3MpIHtcbiAgICBjYWxsYmFja3MgPSBbXTtcbiAgICB0YXJnZXRPYnNlcnZlck11bHRpbWFwLnNldChlbGVtZW50LCBjYWxsYmFja3MpO1xuICAgIGdldE9ic2VydmVyKHdpbikub2JzZXJ2ZShlbGVtZW50KTtcbiAgfVxuICBjb25zdCBleGlzdHMgPSBjYWxsYmFja3Muc29tZShcbiAgICAoY2IpID0+IGNiLmNhbGxiYWNrID09PSBjYWxsYmFjayAmJiBjYi50eXBlID09PSB0eXBlXG4gICk7XG4gIGlmICghZXhpc3RzKSB7XG4gICAgY2FsbGJhY2tzLnB1c2goe3R5cGUsIGNhbGxiYWNrfSk7XG4gICAgY29uc3QgZW50cnkgPSB0YXJnZXRFbnRyeU1hcC5nZXQoZWxlbWVudCk7XG4gICAgaWYgKGVudHJ5KSB7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IGNvbXB1dGVBbmRDYWxsKHR5cGUsIGNhbGxiYWNrLCBlbnRyeSkpO1xuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIEBwYXJhbSB7IUVsZW1lbnR9IGVsZW1lbnRcbiAqIEBwYXJhbSB7IVR5cGV9IHR5cGVcbiAqIEBwYXJhbSB7ZnVuY3Rpb24oIUxheW91dFNpemVEZWYpfGZ1bmN0aW9uKCFSZXNpemVPYnNlcnZlclNpemUpfSBjYWxsYmFja1xuICovXG5mdW5jdGlvbiB1bm9ic2VydmVTaXplKGVsZW1lbnQsIHR5cGUsIGNhbGxiYWNrKSB7XG4gIGNvbnN0IGNhbGxiYWNrcyA9IHRhcmdldE9ic2VydmVyTXVsdGltYXAuZ2V0KGVsZW1lbnQpO1xuICBpZiAoIWNhbGxiYWNrcykge1xuICAgIHJldHVybjtcbiAgfVxuICByZW1vdmUoY2FsbGJhY2tzLCAoY2IpID0+IGNiLmNhbGxiYWNrID09PSBjYWxsYmFjayAmJiBjYi50eXBlID09PSB0eXBlKTtcbiAgaWYgKGNhbGxiYWNrcy5sZW5ndGggPT0gMCkge1xuICAgIHRhcmdldE9ic2VydmVyTXVsdGltYXAuZGVsZXRlKGVsZW1lbnQpO1xuICAgIHRhcmdldEVudHJ5TWFwLmRlbGV0ZShlbGVtZW50KTtcbiAgICBjb25zdCB3aW4gPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXc7XG4gICAgaWYgKHdpbikge1xuICAgICAgZ2V0T2JzZXJ2ZXIod2luKS51bm9ic2VydmUoZWxlbWVudCk7XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogQHBhcmFtIHshV2luZG93fSB3aW5cbiAqIEByZXR1cm4geyFSZXNpemVPYnNlcnZlcn1cbiAqL1xuZnVuY3Rpb24gZ2V0T2JzZXJ2ZXIod2luKSB7XG4gIGxldCBvYnNlcnZlciA9IG9ic2VydmVycy5nZXQod2luKTtcbiAgaWYgKCFvYnNlcnZlcikge1xuICAgIG9ic2VydmVyID0gbmV3IHdpbi5SZXNpemVPYnNlcnZlcihwcm9jZXNzRW50cmllcyk7XG4gICAgb2JzZXJ2ZXJzLnNldCh3aW4sIG9ic2VydmVyKTtcbiAgfVxuICByZXR1cm4gb2JzZXJ2ZXI7XG59XG5cbi8qKlxuICogQHBhcmFtIHshQXJyYXk8IVJlc2l6ZU9ic2VydmVyRW50cnk+fSBlbnRyaWVzXG4gKi9cbmZ1bmN0aW9uIHByb2Nlc3NFbnRyaWVzKGVudHJpZXMpIHtcbiAgY29uc3Qgc2VlbiA9IG5ldyBTZXQoKTtcbiAgZm9yIChsZXQgaSA9IGVudHJpZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICBjb25zdCBlbnRyeSA9IGVudHJpZXNbaV07XG4gICAgY29uc3Qge3RhcmdldH0gPSBlbnRyeTtcbiAgICBpZiAoc2Vlbi5oYXModGFyZ2V0KSkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIHNlZW4uYWRkKHRhcmdldCk7XG4gICAgY29uc3QgY2FsbGJhY2tzID0gdGFyZ2V0T2JzZXJ2ZXJNdWx0aW1hcC5nZXQodGFyZ2V0KTtcbiAgICBpZiAoIWNhbGxiYWNrcykge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIHRhcmdldEVudHJ5TWFwLnNldCh0YXJnZXQsIGVudHJ5KTtcbiAgICBmb3IgKGxldCBrID0gMDsgayA8IGNhbGxiYWNrcy5sZW5ndGg7IGsrKykge1xuICAgICAgY29uc3Qge2NhbGxiYWNrLCB0eXBlfSA9IGNhbGxiYWNrc1trXTtcbiAgICAgIGNvbXB1dGVBbmRDYWxsKHR5cGUsIGNhbGxiYWNrLCBlbnRyeSk7XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogQHBhcmFtIHtUeXBlfSB0eXBlXG4gKiBAcGFyYW0ge2Z1bmN0aW9uKCFMYXlvdXRTaXplRGVmKXxmdW5jdGlvbighUmVzaXplT2JzZXJ2ZXJTaXplKX0gY2FsbGJhY2tcbiAqIEBwYXJhbSB7IVJlc2l6ZU9ic2VydmVyRW50cnl9IGVudHJ5XG4gKi9cbmZ1bmN0aW9uIGNvbXB1dGVBbmRDYWxsKHR5cGUsIGNhbGxiYWNrLCBlbnRyeSkge1xuICBpZiAodHlwZSA9PSBUeXBlLkNPTlRFTlQpIHtcbiAgICBjb25zdCB7Y29udGVudFJlY3R9ID0gZW50cnk7XG4gICAgY29uc3Qge2hlaWdodCwgd2lkdGh9ID0gY29udGVudFJlY3Q7XG4gICAgLyoqIEB0eXBlIHshTGF5b3V0U2l6ZURlZn0gKi9cbiAgICBjb25zdCBzaXplID0ge3dpZHRoLCBoZWlnaHR9O1xuICAgIHRyeUNhbGxiYWNrKGNhbGxiYWNrLCBzaXplKTtcbiAgfSBlbHNlIGlmICh0eXBlID09IFR5cGUuQk9SREVSX0JPWCkge1xuICAgIGNvbnN0IHtib3JkZXJCb3hTaXplOiBib3JkZXJCb3hTaXplQXJyYXl9ID0gZW50cnk7XG4gICAgLyoqIEB0eXBlIHshUmVzaXplT2JzZXJ2ZXJTaXplfSAqL1xuICAgIGxldCBib3JkZXJCb3hTaXplO1xuICAgIGlmIChib3JkZXJCb3hTaXplQXJyYXkpIHtcbiAgICAgIC8vIGBib3JkZXJCb3hTaXplYCBpcyBzdXBwb3J0ZWQuIE9ubHkgc2luZ2xlLWZyYWdtZW50IGJvcmRlciBib3hlcyBhcmVcbiAgICAgIC8vIHN1cHBvcnRlZCBoZXJlIChgYm9yZGVyQm94U2l6ZVswXWApLlxuICAgICAgaWYgKGJvcmRlckJveFNpemVBcnJheS5sZW5ndGggPiAwKSB7XG4gICAgICAgIGJvcmRlckJveFNpemUgPSBib3JkZXJCb3hTaXplQXJyYXlbMF07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBib3JkZXJCb3hTaXplID0gLyoqIEB0eXBlIHshUmVzaXplT2JzZXJ2ZXJTaXplfSAqLyAoe1xuICAgICAgICAgIGlubGluZVNpemU6IDAsXG4gICAgICAgICAgYmxvY2tTaXplOiAwLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gYGJvcmRlckJveFNpemVgIGlzIG5vdCBzdXBwb3J0ZWQ6IHBvbHlmaWxsIGl0IHZpYSBibG9ja2luZyBtZWFzdXJlcy5cbiAgICAgIGNvbnN0IHt0YXJnZXR9ID0gZW50cnk7XG4gICAgICBjb25zdCB3aW4gPSB0b1dpbih0YXJnZXQub3duZXJEb2N1bWVudC5kZWZhdWx0Vmlldyk7XG4gICAgICBjb25zdCBpc1ZlcnRpY2FsID0gVkVSVElDQUxfUkUudGVzdChcbiAgICAgICAgY29tcHV0ZWRTdHlsZSh3aW4sIHRhcmdldClbJ3dyaXRpbmctbW9kZSddXG4gICAgICApO1xuICAgICAgY29uc3Qge29mZnNldEhlaWdodCwgb2Zmc2V0V2lkdGh9ID0gLyoqIEB0eXBlIHshSFRNTEVsZW1lbnR9ICovICh0YXJnZXQpO1xuICAgICAgbGV0IGlubGluZVNpemUsIGJsb2NrU2l6ZTtcbiAgICAgIGlmIChpc1ZlcnRpY2FsKSB7XG4gICAgICAgIGJsb2NrU2l6ZSA9IG9mZnNldFdpZHRoO1xuICAgICAgICBpbmxpbmVTaXplID0gb2Zmc2V0SGVpZ2h0O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaW5saW5lU2l6ZSA9IG9mZnNldFdpZHRoO1xuICAgICAgICBibG9ja1NpemUgPSBvZmZzZXRIZWlnaHQ7XG4gICAgICB9XG4gICAgICBib3JkZXJCb3hTaXplID0ge2lubGluZVNpemUsIGJsb2NrU2l6ZX07XG4gICAgfVxuICAgIHRyeUNhbGxiYWNrKGNhbGxiYWNrLCBib3JkZXJCb3hTaXplKTtcbiAgfVxufVxuIl19
// /Users/mszylkowski/src/amphtml/src/core/dom/layout/size-observer.js