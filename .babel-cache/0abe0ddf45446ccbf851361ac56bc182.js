import { resolvedPromise as _resolvedPromise5 } from "./core/data-structures/promise";
import { resolvedPromise as _resolvedPromise4 } from "./core/data-structures/promise";
import { resolvedPromise as _resolvedPromise3 } from "./core/data-structures/promise";
import { resolvedPromise as _resolvedPromise2 } from "./core/data-structures/promise";
import { resolvedPromise as _resolvedPromise } from "./core/data-structures/promise";

/**
 * Copyright 2016 The AMP HTML Authors. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS-IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Deferred } from "./core/data-structures/promise";
import { parseQueryString } from "./core/types/string/url";
import { WindowInterface } from "./core/window/interface";
import { isExperimentOn } from "./experiments";
import { dev, user, userAssert } from "./log";
import { getMode } from "./mode";
import { Services } from "./service";
import { addParamsToUrl, isProxyOrigin, parseUrlDeprecated } from "./url";
var TIMEOUT_VALUE = 8000;
var trackImpressionPromise = null;
var DEFAULT_APPEND_URL_PARAM = ['gclid', 'gclsrc'];

/**
 * These domains are trusted with more sensitive viewer operations such as
 * sending impression requests. If you believe your domain should be here,
 * file the issue on GitHub to discuss. The process will be similar
 * (but somewhat more stringent) to the one described in the [3p/README.md](
 * https://github.com/ampproject/amphtml/blob/main/3p/README.md)
 *
 * @type {!Array<!RegExp>}
 */
var TRUSTED_REFERRER_HOSTS = [
/**
 * Twitter's link wrapper domains:
 * - t.co
 */
/^t.co$/];

/**
 * A function to get the trackImpressionPromise;
 * @return {!Promise}
 */
export function getTrackImpressionPromise() {
  return userAssert(trackImpressionPromise, 'E#19457 trackImpressionPromise');
}

/**
 * Function that reset the trackImpressionPromise only for testing
 * @visibleForTesting
 */
export function resetTrackImpressionPromiseForTesting() {
  trackImpressionPromise = null;
}

/**
 * Emit a HTTP request to a destination defined on the incoming URL.
 * Launched for trusted viewer. Otherwise guarded by experiment.
 * @param {!Window} win
 */
export function maybeTrackImpression(win) {
  var deferred = new Deferred();
  var promise = deferred.promise,
      resolveImpression = deferred.resolve;
  trackImpressionPromise = Services.timerFor(win).timeoutPromise(TIMEOUT_VALUE, promise, 'TrackImpressionPromise timeout').catch(function (error) {
    dev().warn('IMPRESSION', error);
  });
  var viewer = Services.viewerForDoc(win.document.documentElement);
  var isTrustedViewerPromise = viewer.isTrustedViewer();
  var isTrustedReferrerPromise = viewer.getReferrerUrl().then(function (referrer) {
    return isTrustedReferrer(referrer);
  });
  Promise.all([isTrustedViewerPromise, isTrustedReferrerPromise]).then(function (results) {
    var isTrustedViewer = results[0];
    var isTrustedReferrer = results[1];

    // Enable the feature in the case of trusted viewer,
    // or trusted referrer
    // or with experiment turned on
    if (!isTrustedViewer && !isTrustedReferrer && !isExperimentOn(win, 'alp')) {
      resolveImpression();
      return;
    }

    var replaceUrlPromise = handleReplaceUrl(win);
    var clickUrlPromise = handleClickUrl(win);
    Promise.all([replaceUrlPromise, clickUrlPromise]).then(function () {
      resolveImpression();
    }, function () {});
  });
}

/**
 * Signal that impression tracking is not relevant in this environment.
 */
export function doNotTrackImpression() {
  trackImpressionPromise = _resolvedPromise();
}

/**
 * Handle the getReplaceUrl and return a promise when url is replaced Only
 * handles replaceUrl when viewer indicates AMP to do so. Viewer should indicate
 * by setting the legacy replaceUrl init param and add `replaceUrl` to its
 * capability param. Future plan is to change the type of legacy init replaceUrl
 * param from url string to boolean value. Please NOTE replaceUrl and adLocation
 * will never arrive at same time, so there is no race condition on the order of
 * handling url replacement.
 * @param {!Window} win
 * @return {!Promise}
 */
function handleReplaceUrl(win) {
  var viewer = Services.viewerForDoc(win.document.documentElement);

  // ReplaceUrl substitution doesn't have to wait until the document is visible
  if (!viewer.getParam('replaceUrl')) {
    // The init replaceUrl param serve as a signal on whether replaceUrl is
    // required for this doc.
    return _resolvedPromise2();
  }

  if (!viewer.hasCapability('replaceUrl')) {
    // If Viewer is not capability of providing async replaceUrl, use the legacy
    // init replaceUrl param.
    viewer.replaceUrl(viewer.getParam('replaceUrl') || null);
    return _resolvedPromise3();
  }

  // request async replaceUrl is viewer support getReplaceUrl.
  return viewer.sendMessageAwaitResponse('getReplaceUrl',
  /* data */
  undefined).then(function (response) {
    if (!response || typeof response != 'object') {
      dev().warn('IMPRESSION', 'get invalid replaceUrl response');
      return;
    }

    viewer.replaceUrl(response['replaceUrl'] || null);
  }, function (err) {
    dev().warn('IMPRESSION', 'Error request replaceUrl from viewer', err);
  });
}

/**
 * @param {string} referrer
 * @return {boolean}
 * @visibleForTesting
 */
export function isTrustedReferrer(referrer) {
  var url = parseUrlDeprecated(referrer);

  if (url.protocol != 'https:') {
    return false;
  }

  return TRUSTED_REFERRER_HOSTS.some(function (th) {
    return th.test(url.hostname);
  });
}

/**
 * Perform the impression request if it has been provided via
 * the click param in the viewer arguments. Returns a promise.
 * @param {!Window} win
 * @return {!Promise}
 */
function handleClickUrl(win) {
  var ampdoc = Services.ampdoc(win.document.documentElement);
  var viewer = Services.viewerForDoc(ampdoc);

  /** @const {?string} */
  var clickUrl = viewer.getParam('click');

  if (!clickUrl) {
    return _resolvedPromise4();
  }

  if (clickUrl.indexOf('https://') != 0) {
    user().warn('IMPRESSION', 'click fragment param should start with https://. Found ', clickUrl);
    return _resolvedPromise5();
  }

  if (WindowInterface.getLocation(win).hash) {
    // This is typically done using replaceState inside the viewer.
    // If for some reason it failed, get rid of the fragment here to
    // avoid duplicate tracking.
    WindowInterface.getLocation(win).hash = '';
  }

  // TODO(@zhouyx) need test with a real response.
  return ampdoc.whenFirstVisible().then(function () {
    return invoke(win, dev().assertString(clickUrl));
  }).then(function (response) {
    applyResponse(win, response);
  }).catch(function (err) {
    user().warn('IMPRESSION', 'Error on request clickUrl: ', err);
  });
}

/**
 * Send the url to ad server and wait for its response
 * @param {!Window} win
 * @param {string} clickUrl
 * @return {!Promise<?JsonObject>}
 */
function invoke(win, clickUrl) {
  if (getMode().localDev && !getMode().test) {
    clickUrl = 'http://localhost:8000/impression-proxy?url=' + clickUrl;
  }

  return Services.xhrFor(win).fetchJson(clickUrl, {
    credentials: 'include'
  }).then(function (res) {
    // Treat 204 no content response specially
    if (res.status == 204) {
      return null;
    }

    return res.json();
  });
}

/**
 * parse the response back from ad server
 * Set for analytics purposes
 * @param {!Window} win
 * @param {?JsonObject} response
 */
function applyResponse(win, response) {
  if (!response) {
    return;
  }

  var adLocation = response['location'];
  var adTracking = response['tracking_url'];
  // If there is a tracking_url, need to track it
  // Otherwise track the location
  var trackUrl = adTracking || adLocation;

  if (trackUrl && !isProxyOrigin(trackUrl)) {
    // To request the provided trackUrl for tracking purposes.
    new Image().src = trackUrl;
  }

  // Replace the location href params with new location params we get (if any).
  if (adLocation) {
    if (!win.history.replaceState) {
      return;
    }

    var viewer = Services.viewerForDoc(win.document.documentElement);
    var currentHref = WindowInterface.getLocation(win).href;
    var url = parseUrlDeprecated(adLocation);
    var params = parseQueryString(url.search);
    var newHref = addParamsToUrl(currentHref, params);
    // TODO: Avoid overwriting the fragment parameter.
    win.history.replaceState(null, '', newHref);
    viewer.maybeUpdateFragmentForCct();
  }
}

/**
 * Return a promise that whether appending extra url params to outgoing link is
 * required.
 * @param {!./service/ampdoc-impl.AmpDoc} ampdoc
 * @return {!Promise<boolean>}
 */
export function shouldAppendExtraParams(ampdoc) {
  return ampdoc.whenReady().then(function () {
    return !!ampdoc.getBody().querySelector('amp-analytics[type=googleanalytics]');
  });
}

/**
 * Return the extra url params string that should be appended to outgoing link
 * @param {!Window} win
 * @param {!Element} target
 * @return {string}
 */
export function getExtraParamsUrl(win, target) {
  // Get an array with extra params that needs to append.
  var url = parseUrlDeprecated(WindowInterface.getLocation(win).href);
  var params = parseQueryString(url.search);
  var appendParams = [];

  for (var i = 0; i < DEFAULT_APPEND_URL_PARAM.length; i++) {
    var param = DEFAULT_APPEND_URL_PARAM[i];

    if (typeof params[param] !== 'undefined') {
      appendParams.push(param);
    }
  }

  // Check if the param already exists
  var additionalUrlParams = target.getAttribute('data-amp-addparams');
  var href = target.href;

  if (additionalUrlParams) {
    href = addParamsToUrl(href, parseQueryString(additionalUrlParams));
  }

  var loc = parseUrlDeprecated(href);
  var existParams = parseQueryString(loc.search);

  for (var _i = appendParams.length - 1; _i >= 0; _i--) {
    var _param = appendParams[_i];

    if (typeof existParams[_param] !== 'undefined') {
      appendParams.splice(_i, 1);
    }
  }

  return getQueryParamUrl(appendParams);
}

/**
 * Helper method to convert an query param array to string
 * @param {!Array<string>} params
 * @return {string}
 */
function getQueryParamUrl(params) {
  var url = '';

  for (var i = 0; i < params.length; i++) {
    var param = params[i];
    url += i == 0 ? param + "=QUERY_PARAM(" + param + ")" : "&" + param + "=QUERY_PARAM(" + param + ")";
  }

  return url;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImltcHJlc3Npb24uanMiXSwibmFtZXMiOlsiRGVmZXJyZWQiLCJwYXJzZVF1ZXJ5U3RyaW5nIiwiV2luZG93SW50ZXJmYWNlIiwiaXNFeHBlcmltZW50T24iLCJkZXYiLCJ1c2VyIiwidXNlckFzc2VydCIsImdldE1vZGUiLCJTZXJ2aWNlcyIsImFkZFBhcmFtc1RvVXJsIiwiaXNQcm94eU9yaWdpbiIsInBhcnNlVXJsRGVwcmVjYXRlZCIsIlRJTUVPVVRfVkFMVUUiLCJ0cmFja0ltcHJlc3Npb25Qcm9taXNlIiwiREVGQVVMVF9BUFBFTkRfVVJMX1BBUkFNIiwiVFJVU1RFRF9SRUZFUlJFUl9IT1NUUyIsImdldFRyYWNrSW1wcmVzc2lvblByb21pc2UiLCJyZXNldFRyYWNrSW1wcmVzc2lvblByb21pc2VGb3JUZXN0aW5nIiwibWF5YmVUcmFja0ltcHJlc3Npb24iLCJ3aW4iLCJkZWZlcnJlZCIsInByb21pc2UiLCJyZXNvbHZlSW1wcmVzc2lvbiIsInJlc29sdmUiLCJ0aW1lckZvciIsInRpbWVvdXRQcm9taXNlIiwiY2F0Y2giLCJlcnJvciIsIndhcm4iLCJ2aWV3ZXIiLCJ2aWV3ZXJGb3JEb2MiLCJkb2N1bWVudCIsImRvY3VtZW50RWxlbWVudCIsImlzVHJ1c3RlZFZpZXdlclByb21pc2UiLCJpc1RydXN0ZWRWaWV3ZXIiLCJpc1RydXN0ZWRSZWZlcnJlclByb21pc2UiLCJnZXRSZWZlcnJlclVybCIsInRoZW4iLCJyZWZlcnJlciIsImlzVHJ1c3RlZFJlZmVycmVyIiwiUHJvbWlzZSIsImFsbCIsInJlc3VsdHMiLCJyZXBsYWNlVXJsUHJvbWlzZSIsImhhbmRsZVJlcGxhY2VVcmwiLCJjbGlja1VybFByb21pc2UiLCJoYW5kbGVDbGlja1VybCIsImRvTm90VHJhY2tJbXByZXNzaW9uIiwiZ2V0UGFyYW0iLCJoYXNDYXBhYmlsaXR5IiwicmVwbGFjZVVybCIsInNlbmRNZXNzYWdlQXdhaXRSZXNwb25zZSIsInVuZGVmaW5lZCIsInJlc3BvbnNlIiwiZXJyIiwidXJsIiwicHJvdG9jb2wiLCJzb21lIiwidGgiLCJ0ZXN0IiwiaG9zdG5hbWUiLCJhbXBkb2MiLCJjbGlja1VybCIsImluZGV4T2YiLCJnZXRMb2NhdGlvbiIsImhhc2giLCJ3aGVuRmlyc3RWaXNpYmxlIiwiaW52b2tlIiwiYXNzZXJ0U3RyaW5nIiwiYXBwbHlSZXNwb25zZSIsImxvY2FsRGV2IiwieGhyRm9yIiwiZmV0Y2hKc29uIiwiY3JlZGVudGlhbHMiLCJyZXMiLCJzdGF0dXMiLCJqc29uIiwiYWRMb2NhdGlvbiIsImFkVHJhY2tpbmciLCJ0cmFja1VybCIsIkltYWdlIiwic3JjIiwiaGlzdG9yeSIsInJlcGxhY2VTdGF0ZSIsImN1cnJlbnRIcmVmIiwiaHJlZiIsInBhcmFtcyIsInNlYXJjaCIsIm5ld0hyZWYiLCJtYXliZVVwZGF0ZUZyYWdtZW50Rm9yQ2N0Iiwic2hvdWxkQXBwZW5kRXh0cmFQYXJhbXMiLCJ3aGVuUmVhZHkiLCJnZXRCb2R5IiwicXVlcnlTZWxlY3RvciIsImdldEV4dHJhUGFyYW1zVXJsIiwidGFyZ2V0IiwiYXBwZW5kUGFyYW1zIiwiaSIsImxlbmd0aCIsInBhcmFtIiwicHVzaCIsImFkZGl0aW9uYWxVcmxQYXJhbXMiLCJnZXRBdHRyaWJ1dGUiLCJsb2MiLCJleGlzdFBhcmFtcyIsInNwbGljZSIsImdldFF1ZXJ5UGFyYW1VcmwiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUVBLFNBQVFBLFFBQVI7QUFDQSxTQUFRQyxnQkFBUjtBQUNBLFNBQVFDLGVBQVI7QUFDQSxTQUFRQyxjQUFSO0FBQ0EsU0FBUUMsR0FBUixFQUFhQyxJQUFiLEVBQW1CQyxVQUFuQjtBQUNBLFNBQVFDLE9BQVI7QUFDQSxTQUFRQyxRQUFSO0FBQ0EsU0FBUUMsY0FBUixFQUF3QkMsYUFBeEIsRUFBdUNDLGtCQUF2QztBQUVBLElBQU1DLGFBQWEsR0FBRyxJ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LElBQUksQ0FBM0MsRUFBOENBLEVBQUMsRUFBL0MsRUFBbUQ7QUFDakQsUUFBTUUsTUFBSyxHQUFHSCxZQUFZLENBQUNDLEVBQUQsQ0FBMUI7O0FBQ0EsUUFBSSxPQUFPTyxXQUFXLENBQUNMLE1BQUQsQ0FBbEIsS0FBOEIsV0FBbEMsRUFBK0M7QUFDN0NILE1BQUFBLFlBQVksQ0FBQ1MsTUFBYixDQUFvQlIsRUFBcEIsRUFBdUIsQ0FBdkI7QUFDRDtBQUNGOztBQUNELFNBQU9TLGdCQUFnQixDQUFDVixZQUFELENBQXZCO0FBQ0Q7O0FBRUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVNVLGdCQUFULENBQTBCcEIsTUFBMUIsRUFBa0M7QUFDaEMsTUFBSS9CLEdBQUcsR0FBRyxFQUFWOztBQUNBLE9BQUssSUFBSTBDLENBQUMsR0FBRyxDQUFiLEVBQWdCQSxDQUFDLEdBQUdYLE1BQU0sQ0FBQ1ksTUFBM0IsRUFBbUNELENBQUMsRUFBcEMsRUFBd0M7QUFDdEMsUUFBTUUsS0FBSyxHQUFHYixNQUFNLENBQUNXLENBQUQsQ0FBcEI7QUFDQTFDLElBQUFBLEdBQUcsSUFDRDBDLENBQUMsSUFBSSxDQUFMLEdBQ09FLEtBRFAscUJBQzRCQSxLQUQ1QixlQUVRQSxLQUZSLHFCQUU2QkEsS0FGN0IsTUFERjtBQUlEOztBQUNELFNBQU81QyxHQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAyMDE2IFRoZSBBTVAgSFRNTCBBdXRob3JzLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMtSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHtEZWZlcnJlZH0gZnJvbSAnLi9jb3JlL2RhdGEtc3RydWN0dXJlcy9wcm9taXNlJztcbmltcG9ydCB7cGFyc2VRdWVyeVN0cmluZ30gZnJvbSAnLi9jb3JlL3R5cGVzL3N0cmluZy91cmwnO1xuaW1wb3J0IHtXaW5kb3dJbnRlcmZhY2V9IGZyb20gJy4vY29yZS93aW5kb3cvaW50ZXJmYWNlJztcbmltcG9ydCB7aXNFeHBlcmltZW50T259IGZyb20gJy4vZXhwZXJpbWVudHMnO1xuaW1wb3J0IHtkZXYsIHVzZXIsIHVzZXJBc3NlcnR9IGZyb20gJy4vbG9nJztcbmltcG9ydCB7Z2V0TW9kZX0gZnJvbSAnLi9tb2RlJztcbmltcG9ydCB7U2VydmljZXN9IGZyb20gJy4vc2VydmljZSc7XG5pbXBvcnQge2FkZFBhcmFtc1RvVXJsLCBpc1Byb3h5T3JpZ2luLCBwYXJzZVVybERlcHJlY2F0ZWR9IGZyb20gJy4vdXJsJztcblxuY29uc3QgVElNRU9VVF9WQUxVRSA9IDgwMDA7XG5cbmxldCB0cmFja0ltcHJlc3Npb25Qcm9taXNlID0gbnVsbDtcblxuY29uc3QgREVGQVVMVF9BUFBFTkRfVVJMX1BBUkFNID0gWydnY2xpZCcsICdnY2xzcmMnXTtcblxuLyoqXG4gKiBUaGVzZSBkb21haW5zIGFyZSB0cnVzdGVkIHdpdGggbW9yZSBzZW5zaXRpdmUgdmlld2VyIG9wZXJhdGlvbnMgc3VjaCBhc1xuICogc2VuZGluZyBpbXByZXNzaW9uIHJlcXVlc3RzLiBJZiB5b3UgYmVsaWV2ZSB5b3VyIGRvbWFpbiBzaG91bGQgYmUgaGVyZSxcbiAqIGZpbGUgdGhlIGlzc3VlIG9uIEdpdEh1YiB0byBkaXNjdXNzLiBUaGUgcHJvY2VzcyB3aWxsIGJlIHNpbWlsYXJcbiAqIChidXQgc29tZXdoYXQgbW9yZSBzdHJpbmdlbnQpIHRvIHRoZSBvbmUgZGVzY3JpYmVkIGluIHRoZSBbM3AvUkVBRE1FLm1kXShcbiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9hbXBwcm9qZWN0L2FtcGh0bWwvYmxvYi9tYWluLzNwL1JFQURNRS5tZClcbiAqXG4gKiBAdHlwZSB7IUFycmF5PCFSZWdFeHA+fVxuICovXG5jb25zdCBUUlVTVEVEX1JFRkVSUkVSX0hPU1RTID0gW1xuICAvKipcbiAgICogVHdpdHRlcidzIGxpbmsgd3JhcHBlciBkb21haW5zOlxuICAgKiAtIHQuY29cbiAgICovXG4gIC9edC5jbyQvLFxuXTtcblxuLyoqXG4gKiBBIGZ1bmN0aW9uIHRvIGdldCB0aGUgdHJhY2tJbXByZXNzaW9uUHJvbWlzZTtcbiAqIEByZXR1cm4geyFQcm9taXNlfVxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0VHJhY2tJbXByZXNzaW9uUHJvbWlzZSgpIHtcbiAgcmV0dXJuIHVzZXJBc3NlcnQodHJhY2tJbXByZXNzaW9uUHJvbWlzZSwgJ0UjMTk0NTcgdHJhY2tJbXByZXNzaW9uUHJvbWlzZScpO1xufVxuXG4vKipcbiAqIEZ1bmN0aW9uIHRoYXQgcmVzZXQgdGhlIHRyYWNrSW1wcmVzc2lvblByb21pc2Ugb25seSBmb3IgdGVzdGluZ1xuICogQHZpc2libGVGb3JUZXN0aW5nXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZXNldFRyYWNrSW1wcmVzc2lvblByb21pc2VGb3JUZXN0aW5nKCkge1xuICB0cmFja0ltcHJlc3Npb25Qcm9taXNlID0gbnVsbDtcbn1cblxuLyoqXG4gKiBFbWl0IGEgSFRUUCByZXF1ZXN0IHRvIGEgZGVzdGluYXRpb24gZGVmaW5lZCBvbiB0aGUgaW5jb21pbmcgVVJMLlxuICogTGF1bmNoZWQgZm9yIHRydXN0ZWQgdmlld2VyLiBPdGhlcndpc2UgZ3VhcmRlZCBieSBleHBlcmltZW50LlxuICogQHBhcmFtIHshV2luZG93fSB3aW5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG1heWJlVHJhY2tJbXByZXNzaW9uKHdpbikge1xuICBjb25zdCBkZWZlcnJlZCA9IG5ldyBEZWZlcnJlZCgpO1xuICBjb25zdCB7cHJvbWlzZSwgcmVzb2x2ZTogcmVzb2x2ZUltcHJlc3Npb259ID0gZGVmZXJyZWQ7XG5cbiAgdHJhY2tJbXByZXNzaW9uUHJvbWlzZSA9IFNlcnZpY2VzLnRpbWVyRm9yKHdpbilcbiAgICAudGltZW91dFByb21pc2UoVElNRU9VVF9WQUxVRSwgcHJvbWlzZSwgJ1RyYWNrSW1wcmVzc2lvblByb21pc2UgdGltZW91dCcpXG4gICAgLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgZGV2KCkud2FybignSU1QUkVTU0lPTicsIGVycm9yKTtcbiAgICB9KTtcblxuICBjb25zdCB2aWV3ZXIgPSBTZXJ2aWNlcy52aWV3ZXJGb3JEb2Mod2luLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudCk7XG4gIGNvbnN0IGlzVHJ1c3RlZFZpZXdlclByb21pc2UgPSB2aWV3ZXIuaXNUcnVzdGVkVmlld2VyKCk7XG4gIGNvbnN0IGlzVHJ1c3RlZFJlZmVycmVyUHJvbWlzZSA9IHZpZXdlclxuICAgIC5nZXRSZWZlcnJlclVybCgpXG4gICAgLnRoZW4oKHJlZmVycmVyKSA9PiBpc1RydXN0ZWRSZWZlcnJlcihyZWZlcnJlcikpO1xuICBQcm9taXNlLmFsbChbaXNUcnVzdGVkVmlld2VyUHJvbWlzZSwgaXNUcnVzdGVkUmVmZXJyZXJQcm9taXNlXSkudGhlbihcbiAgICAocmVzdWx0cykgPT4ge1xuICAgICAgY29uc3QgaXNUcnVzdGVkVmlld2VyID0gcmVzdWx0c1swXTtcbiAgICAgIGNvbnN0IGlzVHJ1c3RlZFJlZmVycmVyID0gcmVzdWx0c1sxXTtcbiAgICAgIC8vIEVuYWJsZSB0aGUgZmVhdHVyZSBpbiB0aGUgY2FzZSBvZiB0cnVzdGVkIHZpZXdlcixcbiAgICAgIC8vIG9yIHRydXN0ZWQgcmVmZXJyZXJcbiAgICAgIC8vIG9yIHdpdGggZXhwZXJpbWVudCB0dXJuZWQgb25cbiAgICAgIGlmIChcbiAgICAgICAgIWlzVHJ1c3RlZFZpZXdlciAmJlxuICAgICAgICAhaXNUcnVzdGVkUmVmZXJyZXIgJiZcbiAgICAgICAgIWlzRXhwZXJpbWVudE9uKHdpbiwgJ2FscCcpXG4gICAgICApIHtcbiAgICAgICAgcmVzb2x2ZUltcHJlc3Npb24oKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjb25zdCByZXBsYWNlVXJsUHJvbWlzZSA9IGhhbmRsZVJlcGxhY2VVcmwod2luKTtcbiAgICAgIGNvbnN0IGNsaWNrVXJsUHJvbWlzZSA9IGhhbmRsZUNsaWNrVXJsKHdpbik7XG5cbiAgICAgIFByb21pc2UuYWxsKFtyZXBsYWNlVXJsUHJvbWlzZSwgY2xpY2tVcmxQcm9taXNlXSkudGhlbihcbiAgICAgICAgKCkgPT4ge1xuICAgICAgICAgIHJlc29sdmVJbXByZXNzaW9uKCk7XG4gICAgICAgIH0sXG4gICAgICAgICgpID0+IHt9XG4gICAgICApO1xuICAgIH1cbiAgKTtcbn1cblxuLyoqXG4gKiBTaWduYWwgdGhhdCBpbXByZXNzaW9uIHRyYWNraW5nIGlzIG5vdCByZWxldmFudCBpbiB0aGlzIGVudmlyb25tZW50LlxuICovXG5leHBvcnQgZnVuY3Rpb24gZG9Ob3RUcmFja0ltcHJlc3Npb24oKSB7XG4gIHRyYWNrSW1wcmVzc2lvblByb21pc2UgPSBQcm9taXNlLnJlc29sdmUoKTtcbn1cblxuLyoqXG4gKiBIYW5kbGUgdGhlIGdldFJlcGxhY2VVcmwgYW5kIHJldHVybiBhIHByb21pc2Ugd2hlbiB1cmwgaXMgcmVwbGFjZWQgT25seVxuICogaGFuZGxlcyByZXBsYWNlVXJsIHdoZW4gdmlld2VyIGluZGljYXRlcyBBTVAgdG8gZG8gc28uIFZpZXdlciBzaG91bGQgaW5kaWNhdGVcbiAqIGJ5IHNldHRpbmcgdGhlIGxlZ2FjeSByZXBsYWNlVXJsIGluaXQgcGFyYW0gYW5kIGFkZCBgcmVwbGFjZVVybGAgdG8gaXRzXG4gKiBjYXBhYmlsaXR5IHBhcmFtLiBGdXR1cmUgcGxhbiBpcyB0byBjaGFuZ2UgdGhlIHR5cGUgb2YgbGVnYWN5IGluaXQgcmVwbGFjZVVybFxuICogcGFyYW0gZnJvbSB1cmwgc3RyaW5nIHRvIGJvb2xlYW4gdmFsdWUuIFBsZWFzZSBOT1RFIHJlcGxhY2VVcmwgYW5kIGFkTG9jYXRpb25cbiAqIHdpbGwgbmV2ZXIgYXJyaXZlIGF0IHNhbWUgdGltZSwgc28gdGhlcmUgaXMgbm8gcmFjZSBjb25kaXRpb24gb24gdGhlIG9yZGVyIG9mXG4gKiBoYW5kbGluZyB1cmwgcmVwbGFjZW1lbnQuXG4gKiBAcGFyYW0geyFXaW5kb3d9IHdpblxuICogQHJldHVybiB7IVByb21pc2V9XG4gKi9cbmZ1bmN0aW9uIGhhbmRsZVJlcGxhY2VVcmwod2luKSB7XG4gIGNvbnN0IHZpZXdlciA9IFNlcnZpY2VzLnZpZXdlckZvckRvYyh3aW4uZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KTtcblxuICAvLyBSZXBsYWNlVXJsIHN1YnN0aXR1dGlvbiBkb2Vzbid0IGhhdmUgdG8gd2FpdCB1bnRpbCB0aGUgZG9jdW1lbnQgaXMgdmlzaWJsZVxuICBpZiAoIXZpZXdlci5nZXRQYXJhbSgncmVwbGFjZVVybCcpKSB7XG4gICAgLy8gVGhlIGluaXQgcmVwbGFjZVVybCBwYXJhbSBzZXJ2ZSBhcyBhIHNpZ25hbCBvbiB3aGV0aGVyIHJlcGxhY2VVcmwgaXNcbiAgICAvLyByZXF1aXJlZCBmb3IgdGhpcyBkb2MuXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICB9XG5cbiAgaWYgKCF2aWV3ZXIuaGFzQ2FwYWJpbGl0eSgncmVwbGFjZVVybCcpKSB7XG4gICAgLy8gSWYgVmlld2VyIGlzIG5vdCBjYXBhYmlsaXR5IG9mIHByb3ZpZGluZyBhc3luYyByZXBsYWNlVXJsLCB1c2UgdGhlIGxlZ2FjeVxuICAgIC8vIGluaXQgcmVwbGFjZVVybCBwYXJhbS5cbiAgICB2aWV3ZXIucmVwbGFjZVVybCh2aWV3ZXIuZ2V0UGFyYW0oJ3JlcGxhY2VVcmwnKSB8fCBudWxsKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gIH1cblxuICAvLyByZXF1ZXN0IGFzeW5jIHJlcGxhY2VVcmwgaXMgdmlld2VyIHN1cHBvcnQgZ2V0UmVwbGFjZVVybC5cbiAgcmV0dXJuIHZpZXdlclxuICAgIC5zZW5kTWVzc2FnZUF3YWl0UmVzcG9uc2UoJ2dldFJlcGxhY2VVcmwnLCAvKiBkYXRhICovIHVuZGVmaW5lZClcbiAgICAudGhlbihcbiAgICAgIChyZXNwb25zZSkgPT4ge1xuICAgICAgICBpZiAoIXJlc3BvbnNlIHx8IHR5cGVvZiByZXNwb25zZSAhPSAnb2JqZWN0Jykge1xuICAgICAgICAgIGRldigpLndhcm4oJ0lNUFJFU1NJT04nLCAnZ2V0IGludmFsaWQgcmVwbGFjZVVybCByZXNwb25zZScpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB2aWV3ZXIucmVwbGFjZVVybChyZXNwb25zZVsncmVwbGFjZVVybCddIHx8IG51bGwpO1xuICAgICAgfSxcbiAgICAgIChlcnIpID0+IHtcbiAgICAgICAgZGV2KCkud2FybignSU1QUkVTU0lPTicsICdFcnJvciByZXF1ZXN0IHJlcGxhY2VVcmwgZnJvbSB2aWV3ZXInLCBlcnIpO1xuICAgICAgfVxuICAgICk7XG59XG5cbi8qKlxuICogQHBhcmFtIHtzdHJpbmd9IHJlZmVycmVyXG4gKiBAcmV0dXJuIHtib29sZWFufVxuICogQHZpc2libGVGb3JUZXN0aW5nXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpc1RydXN0ZWRSZWZlcnJlcihyZWZlcnJlcikge1xuICBjb25zdCB1cmwgPSBwYXJzZVVybERlcHJlY2F0ZWQocmVmZXJyZXIpO1xuICBpZiAodXJsLnByb3RvY29sICE9ICdodHRwczonKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIHJldHVybiBUUlVTVEVEX1JFRkVSUkVSX0hPU1RTLnNvbWUoKHRoKSA9PiB0aC50ZXN0KHVybC5ob3N0bmFtZSkpO1xufVxuXG4vKipcbiAqIFBlcmZvcm0gdGhlIGltcHJlc3Npb24gcmVxdWVzdCBpZiBpdCBoYXMgYmVlbiBwcm92aWRlZCB2aWFcbiAqIHRoZSBjbGljayBwYXJhbSBpbiB0aGUgdmlld2VyIGFyZ3VtZW50cy4gUmV0dXJucyBhIHByb21pc2UuXG4gKiBAcGFyYW0geyFXaW5kb3d9IHdpblxuICogQHJldHVybiB7IVByb21pc2V9XG4gKi9cbmZ1bmN0aW9uIGhhbmRsZUNsaWNrVXJsKHdpbikge1xuICBjb25zdCBhbXBkb2MgPSBTZXJ2aWNlcy5hbXBkb2Mod2luLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudCk7XG4gIGNvbnN0IHZpZXdlciA9IFNlcnZpY2VzLnZpZXdlckZvckRvYyhhbXBkb2MpO1xuXG4gIC8qKiBAY29uc3Qgez9zdHJpbmd9ICovXG4gIGNvbnN0IGNsaWNrVXJsID0gdmlld2VyLmdldFBhcmFtKCdjbGljaycpO1xuICBpZiAoIWNsaWNrVXJsKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICB9XG5cbiAgaWYgKGNsaWNrVXJsLmluZGV4T2YoJ2h0dHBzOi8vJykgIT0gMCkge1xuICAgIHVzZXIoKS53YXJuKFxuICAgICAgJ0lNUFJFU1NJT04nLFxuICAgICAgJ2NsaWNrIGZyYWdtZW50IHBhcmFtIHNob3VsZCBzdGFydCB3aXRoIGh0dHBzOi8vLiBGb3VuZCAnLFxuICAgICAgY2xpY2tVcmxcbiAgICApO1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgfVxuXG4gIGlmIChXaW5kb3dJbnRlcmZhY2UuZ2V0TG9jYXRpb24od2luKS5oYXNoKSB7XG4gICAgLy8gVGhpcyBpcyB0eXBpY2FsbHkgZG9uZSB1c2luZyByZXBsYWNlU3RhdGUgaW5zaWRlIHRoZSB2aWV3ZXIuXG4gICAgLy8gSWYgZm9yIHNvbWUgcmVhc29uIGl0IGZhaWxlZCwgZ2V0IHJpZCBvZiB0aGUgZnJhZ21lbnQgaGVyZSB0b1xuICAgIC8vIGF2b2lkIGR1cGxpY2F0ZSB0cmFja2luZy5cbiAgICBXaW5kb3dJbnRlcmZhY2UuZ2V0TG9jYXRpb24od2luKS5oYXNoID0gJyc7XG4gIH1cblxuICAvLyBUT0RPKEB6aG91eXgpIG5lZWQgdGVzdCB3aXRoIGEgcmVhbCByZXNwb25zZS5cbiAgcmV0dXJuIGFtcGRvY1xuICAgIC53aGVuRmlyc3RWaXNpYmxlKClcbiAgICAudGhlbigoKSA9PiB7XG4gICAgICByZXR1cm4gaW52b2tlKHdpbiwgZGV2KCkuYXNzZXJ0U3RyaW5nKGNsaWNrVXJsKSk7XG4gICAgfSlcbiAgICAudGhlbigocmVzcG9uc2UpID0+IHtcbiAgICAgIGFwcGx5UmVzcG9uc2Uod2luLCByZXNwb25zZSk7XG4gICAgfSlcbiAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgdXNlcigpLndhcm4oJ0lNUFJFU1NJT04nLCAnRXJyb3Igb24gcmVxdWVzdCBjbGlja1VybDogJywgZXJyKTtcbiAgICB9KTtcbn1cblxuLyoqXG4gKiBTZW5kIHRoZSB1cmwgdG8gYWQgc2VydmVyIGFuZCB3YWl0IGZvciBpdHMgcmVzcG9uc2VcbiAqIEBwYXJhbSB7IVdpbmRvd30gd2luXG4gKiBAcGFyYW0ge3N0cmluZ30gY2xpY2tVcmxcbiAqIEByZXR1cm4geyFQcm9taXNlPD9Kc29uT2JqZWN0Pn1cbiAqL1xuZnVuY3Rpb24gaW52b2tlKHdpbiwgY2xpY2tVcmwpIHtcbiAgaWYgKGdldE1vZGUoKS5sb2NhbERldiAmJiAhZ2V0TW9kZSgpLnRlc3QpIHtcbiAgICBjbGlja1VybCA9ICdodHRwOi8vbG9jYWxob3N0OjgwMDAvaW1wcmVzc2lvbi1wcm94eT91cmw9JyArIGNsaWNrVXJsO1xuICB9XG4gIHJldHVybiBTZXJ2aWNlcy54aHJGb3Iod2luKVxuICAgIC5mZXRjaEpzb24oY2xpY2tVcmwsIHtcbiAgICAgIGNyZWRlbnRpYWxzOiAnaW5jbHVkZScsXG4gICAgfSlcbiAgICAudGhlbigocmVzKSA9PiB7XG4gICAgICAvLyBUcmVhdCAyMDQgbm8gY29udGVudCByZXNwb25zZSBzcGVjaWFsbHlcbiAgICAgIGlmIChyZXMuc3RhdHVzID09IDIwNCkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXMuanNvbigpO1xuICAgIH0pO1xufVxuXG4vKipcbiAqIHBhcnNlIHRoZSByZXNwb25zZSBiYWNrIGZyb20gYWQgc2VydmVyXG4gKiBTZXQgZm9yIGFuYWx5dGljcyBwdXJwb3Nlc1xuICogQHBhcmFtIHshV2luZG93fSB3aW5cbiAqIEBwYXJhbSB7P0pzb25PYmplY3R9IHJlc3BvbnNlXG4gKi9cbmZ1bmN0aW9uIGFwcGx5UmVzcG9uc2Uod2luLCByZXNwb25zZSkge1xuICBpZiAoIXJlc3BvbnNlKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgYWRMb2NhdGlvbiA9IHJlc3BvbnNlWydsb2NhdGlvbiddO1xuICBjb25zdCBhZFRyYWNraW5nID0gcmVzcG9uc2VbJ3RyYWNraW5nX3VybCddO1xuXG4gIC8vIElmIHRoZXJlIGlzIGEgdHJhY2tpbmdfdXJsLCBuZWVkIHRvIHRyYWNrIGl0XG4gIC8vIE90aGVyd2lzZSB0cmFjayB0aGUgbG9jYXRpb25cbiAgY29uc3QgdHJhY2tVcmwgPSBhZFRyYWNraW5nIHx8IGFkTG9jYXRpb247XG5cbiAgaWYgKHRyYWNrVXJsICYmICFpc1Byb3h5T3JpZ2luKHRyYWNrVXJsKSkge1xuICAgIC8vIFRvIHJlcXVlc3QgdGhlIHByb3ZpZGVkIHRyYWNrVXJsIGZvciB0cmFja2luZyBwdXJwb3Nlcy5cbiAgICBuZXcgSW1hZ2UoKS5zcmMgPSB0cmFja1VybDtcbiAgfVxuXG4gIC8vIFJlcGxhY2UgdGhlIGxvY2F0aW9uIGhyZWYgcGFyYW1zIHdpdGggbmV3IGxvY2F0aW9uIHBhcmFtcyB3ZSBnZXQgKGlmIGFueSkuXG4gIGlmIChhZExvY2F0aW9uKSB7XG4gICAgaWYgKCF3aW4uaGlzdG9yeS5yZXBsYWNlU3RhdGUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB2aWV3ZXIgPSBTZXJ2aWNlcy52aWV3ZXJGb3JEb2Mod2luLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudCk7XG4gICAgY29uc3QgY3VycmVudEhyZWYgPSBXaW5kb3dJbnRlcmZhY2UuZ2V0TG9jYXRpb24od2luKS5ocmVmO1xuICAgIGNvbnN0IHVybCA9IHBhcnNlVXJsRGVwcmVjYXRlZChhZExvY2F0aW9uKTtcbiAgICBjb25zdCBwYXJhbXMgPSBwYXJzZVF1ZXJ5U3RyaW5nKHVybC5zZWFyY2gpO1xuICAgIGNvbnN0IG5ld0hyZWYgPSBhZGRQYXJhbXNUb1VybChjdXJyZW50SHJlZiwgcGFyYW1zKTtcbiAgICAvLyBUT0RPOiBBdm9pZCBvdmVyd3JpdGluZyB0aGUgZnJhZ21lbnQgcGFyYW1ldGVyLlxuICAgIHdpbi5oaXN0b3J5LnJlcGxhY2VTdGF0ZShudWxsLCAnJywgbmV3SHJlZik7XG4gICAgdmlld2VyLm1heWJlVXBkYXRlRnJhZ21lbnRGb3JDY3QoKTtcbiAgfVxufVxuXG4vKipcbiAqIFJldHVybiBhIHByb21pc2UgdGhhdCB3aGV0aGVyIGFwcGVuZGluZyBleHRyYSB1cmwgcGFyYW1zIHRvIG91dGdvaW5nIGxpbmsgaXNcbiAqIHJlcXVpcmVkLlxuICogQHBhcmFtIHshLi9zZXJ2aWNlL2FtcGRvYy1pbXBsLkFtcERvY30gYW1wZG9jXG4gKiBAcmV0dXJuIHshUHJvbWlzZTxib29sZWFuPn1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNob3VsZEFwcGVuZEV4dHJhUGFyYW1zKGFtcGRvYykge1xuICByZXR1cm4gYW1wZG9jLndoZW5SZWFkeSgpLnRoZW4oKCkgPT4ge1xuICAgIHJldHVybiAhIWFtcGRvY1xuICAgICAgLmdldEJvZHkoKVxuICAgICAgLnF1ZXJ5U2VsZWN0b3IoJ2FtcC1hbmFseXRpY3NbdHlwZT1nb29nbGVhbmFseXRpY3NdJyk7XG4gIH0pO1xufVxuXG4vKipcbiAqIFJldHVybiB0aGUgZXh0cmEgdXJsIHBhcmFtcyBzdHJpbmcgdGhhdCBzaG91bGQgYmUgYXBwZW5kZWQgdG8gb3V0Z29pbmcgbGlua1xuICogQHBhcmFtIHshV2luZG93fSB3aW5cbiAqIEBwYXJhbSB7IUVsZW1lbnR9IHRhcmdldFxuICogQHJldHVybiB7c3RyaW5nfVxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0RXh0cmFQYXJhbXNVcmwod2luLCB0YXJnZXQpIHtcbiAgLy8gR2V0IGFuIGFycmF5IHdpdGggZXh0cmEgcGFyYW1zIHRoYXQgbmVlZHMgdG8gYXBwZW5kLlxuICBjb25zdCB1cmwgPSBwYXJzZVVybERlcHJlY2F0ZWQoV2luZG93SW50ZXJmYWNlLmdldExvY2F0aW9uKHdpbikuaHJlZik7XG4gIGNvbnN0IHBhcmFtcyA9IHBhcnNlUXVlcnlTdHJpbmcodXJsLnNlYXJjaCk7XG4gIGNvbnN0IGFwcGVuZFBhcmFtcyA9IFtdO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IERFRkFVTFRfQVBQRU5EX1VSTF9QQVJBTS5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IHBhcmFtID0gREVGQVVMVF9BUFBFTkRfVVJMX1BBUkFNW2ldO1xuICAgIGlmICh0eXBlb2YgcGFyYW1zW3BhcmFtXSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIGFwcGVuZFBhcmFtcy5wdXNoKHBhcmFtKTtcbiAgICB9XG4gIH1cblxuICAvLyBDaGVjayBpZiB0aGUgcGFyYW0gYWxyZWFkeSBleGlzdHNcbiAgY29uc3QgYWRkaXRpb25hbFVybFBhcmFtcyA9IHRhcmdldC5nZXRBdHRyaWJ1dGUoJ2RhdGEtYW1wLWFkZHBhcmFtcycpO1xuICBsZXQge2hyZWZ9ID0gdGFyZ2V0O1xuICBpZiAoYWRkaXRpb25hbFVybFBhcmFtcykge1xuICAgIGhyZWYgPSBhZGRQYXJhbXNUb1VybChocmVmLCBwYXJzZVF1ZXJ5U3RyaW5nKGFkZGl0aW9uYWxVcmxQYXJhbXMpKTtcbiAgfVxuICBjb25zdCBsb2MgPSBwYXJzZVVybERlcHJlY2F0ZWQoaHJlZik7XG4gIGNvbnN0IGV4aXN0UGFyYW1zID0gcGFyc2VRdWVyeVN0cmluZyhsb2Muc2VhcmNoKTtcbiAgZm9yIChsZXQgaSA9IGFwcGVuZFBhcmFtcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgIGNvbnN0IHBhcmFtID0gYXBwZW5kUGFyYW1zW2ldO1xuICAgIGlmICh0eXBlb2YgZXhpc3RQYXJhbXNbcGFyYW1dICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgYXBwZW5kUGFyYW1zLnNwbGljZShpLCAxKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGdldFF1ZXJ5UGFyYW1VcmwoYXBwZW5kUGFyYW1zKTtcbn1cblxuLyoqXG4gKiBIZWxwZXIgbWV0aG9kIHRvIGNvbnZlcnQgYW4gcXVlcnkgcGFyYW0gYXJyYXkgdG8gc3RyaW5nXG4gKiBAcGFyYW0geyFBcnJheTxzdHJpbmc+fSBwYXJhbXNcbiAqIEByZXR1cm4ge3N0cmluZ31cbiAqL1xuZnVuY3Rpb24gZ2V0UXVlcnlQYXJhbVVybChwYXJhbXMpIHtcbiAgbGV0IHVybCA9ICcnO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHBhcmFtcy5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IHBhcmFtID0gcGFyYW1zW2ldO1xuICAgIHVybCArPVxuICAgICAgaSA9PSAwXG4gICAgICAgID8gYCR7cGFyYW19PVFVRVJZX1BBUkFNKCR7cGFyYW19KWBcbiAgICAgICAgOiBgJiR7cGFyYW19PVFVRVJZX1BBUkFNKCR7cGFyYW19KWA7XG4gIH1cbiAgcmV0dXJuIHVybDtcbn1cbiJdfQ==
// /Users/mszylkowski/src/amphtml/src/impression.js