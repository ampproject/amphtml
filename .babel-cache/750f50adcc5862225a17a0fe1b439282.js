import { resolvedPromise as _resolvedPromise2 } from "./../../../src/core/data-structures/promise";
import { resolvedPromise as _resolvedPromise } from "./../../../src/core/data-structures/promise";

/**
 * Copyright 2021 The AMP HTML Authors. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS-IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Services } from "../../../src/service";
import { addParamsToUrl, resolveRelativeUrl } from "../../../src/url";
import { createElementWithAttributes, iterateCursor, removeElement } from "../../../src/core/dom";
import { matches } from "../../../src/core/dom/query";
import { toArray } from "../../../src/core/types/array";
import { user } from "../../../src/log";

/**
 * Add the caching sources to the video if opted in.
 * The request is sent to the AMP cache url with /mbv path prefix,
 * and appends the document canonical url as the queryParam `amp_video_host_url`.
 *
 * @param {!Element} videoEl
 * @param {!AmpDoc} ampdoc
 * @param {number=} maxBitrate
 * @return {!Promise}
 */
export function fetchCachedSources(videoEl, ampdoc, maxBitrate) {
  var _videoEl$querySelecto;

  if (maxBitrate === void 0) {
    maxBitrate = Number.POSITIVE_INFINITY;
  }

  var win = ampdoc.win;

  // Keep non cached evergreen sources for crawlers.
  if (Services.platformFor(win).isBot()) {
    return _resolvedPromise();
  }

  if (!(videoEl.getAttribute('src') || (_videoEl$querySelecto = videoEl.querySelector('source[src]')) != null && _videoEl$querySelecto.getAttribute('src'))) {
    user().error('AMP-VIDEO', 'Video cache not properly configured');
    return _resolvedPromise2();
  }

  Services.performanceFor(ampdoc.win).addEnabledExperiment('video-cache');

  var _Services$documentInf = Services.documentInfoForDoc(win.document),
      canonicalUrl = _Services$documentInf.canonicalUrl,
      sourceUrl = _Services$documentInf.sourceUrl;

  maybeReplaceSrcWithSourceElement(videoEl, win);
  var videoUrl = resolveRelativeUrl(selectVideoSource(videoEl), sourceUrl);
  return getCacheUrlService(videoEl, ampdoc).then(function (service) {
    return service.createCacheUrl(videoUrl);
  }).then(function (cacheUrl) {
    var requestUrl = addParamsToUrl(cacheUrl.replace(/\/[ic]\//, '/mbv/'), {
      'amp_video_host_url':
      /* document url that contains the video */
      canonicalUrl
    });
    return Services.xhrFor(win).fetch(requestUrl, {
      prerenderSafe: true
    });
  }).then(function (response) {
    return response.json();
  }).then(function (jsonResponse) {
    return applySourcesToVideo(videoEl, jsonResponse['sources'], maxBitrate);
  }).catch(function () {// If cache fails, video should still load properly.
  });
}

/**
 * Selects and returns the prioritized video source URL
 * @param {!Element} videoEl
 * @return {?string}
 */
function selectVideoSource(videoEl) {
  var _possibleSources$;

  var possibleSources = toArray(videoEl.querySelectorAll('source[src]'));

  for (var i = 0; i < possibleSources.length; i++) {
    if (matches(possibleSources[i], '[type*="video/mp4"]')) {
      return possibleSources[i].getAttribute('src');
    }
  }

  return (_possibleSources$ = possibleSources[0]) == null ? void 0 : _possibleSources$.getAttribute('src');
}

/**
 *
 * @param {!Element} videoEl
 * @param {!Array<!Object>} sources
 * @param {number} maxBitrate
 */
function applySourcesToVideo(videoEl, sources, maxBitrate) {
  sources.sort(function (a, b) {
    return a['bitrate_kbps'] - b['bitrate_kbps'];
  }).forEach(function (source) {
    if (source['bitrate_kbps'] > maxBitrate) {
      return;
    }

    var sourceEl = createElementWithAttributes(videoEl.ownerDocument, 'source', {
      'src': source['url'],
      'type': source['type'],
      'data-bitrate': source['bitrate_kbps'],
      'i-amphtml-video-cached-source': ''
    });
    videoEl.insertBefore(sourceEl, videoEl.firstChild);
  });
}

/**
 * If present, moves the src attribute to a source element to enable playing
 * from multiple sources: the cached ones and the fallback initial src.
 * @param {!Element} videoEl
 * @param {!Window} win
 */
function maybeReplaceSrcWithSourceElement(videoEl, win) {
  if (!videoEl.hasAttribute('src')) {
    return;
  }

  var sourceEl = win.document.createElement('source');
  var srcAttr = videoEl.getAttribute('src');
  sourceEl.setAttribute('src', srcAttr);
  var typeAttr = videoEl.getAttribute('type');

  if (typeAttr) {
    sourceEl.setAttribute('type', typeAttr);
  }

  // Remove the src attr so the source children can play.
  videoEl.removeAttribute('src');
  videoEl.removeAttribute('type');
  // Remove all existing sources as they are never supposed to play for a video
  // that has a src, cf https://html.spec.whatwg.org/#concept-media-load-algorithm
  var sourceEls = videoEl.querySelectorAll('source');
  iterateCursor(sourceEls, function (el) {
    return removeElement(el);
  });
  videoEl.insertBefore(sourceEl, videoEl.firstChild);
}

/**
 * Lazy loads the amp-cache-url extension if needed and retrieves its service.
 * @param {!Element} videoEl
 * @param {!AmpDoc} ampdoc
 * @return {!Promise<../../../amp-cache-url/amp-cache-url.AmpCacheUrlService>}
 */
function getCacheUrlService(videoEl, ampdoc) {
  return Services.extensionsFor(ampdoc.win).installExtensionForDoc(ampdoc, 'amp-cache-url').then(function () {
    return Services.cacheUrlServicePromiseForDoc(videoEl);
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZpZGVvLWNhY2hlLmpzIl0sIm5hbWVzIjpbIlNlcnZpY2VzIiwiYWRkUGFyYW1zVG9VcmwiLCJyZXNvbHZlUmVsYXRpdmVVcmwiLCJjcmVhdGVFbGVtZW50V2l0aEF0dHJpYnV0ZXMiLCJpdGVyYXRlQ3Vyc29yIiwicmVtb3ZlRWxlbWVudCIsIm1hdGNoZXMiLCJ0b0FycmF5IiwidXNlciIsImZldGNoQ2FjaGVkU291cmNlcyIsInZpZGVvRWwiLCJhbXBkb2MiLCJtYXhCaXRyYXRlIiwiTnVtYmVyIiwiUE9TSVRJVkVfSU5GSU5JVFkiLCJ3aW4iLCJwbGF0Zm9ybUZvciIsImlzQm90IiwiZ2V0QXR0cmlidXRlIiwicXVlcnlTZWxlY3RvciIsImVycm9yIiwicGVyZm9ybWFuY2VGb3IiLCJhZGRFbmFibGVkRXhwZXJpbWVudCIsImRvY3VtZW50SW5mb0ZvckRvYyIsImRvY3VtZW50IiwiY2Fub25pY2FsVXJsIiwic291cmNlVXJsIiwibWF5YmVSZXBsYWNlU3JjV2l0aFNvdXJjZUVsZW1lbnQiLCJ2aWRlb1VybCIsInNlbGVjdFZpZGVvU291cmNlIiwiZ2V0Q2FjaGVVcmxTZXJ2aWNlIiwidGhlbiIsInNlcnZpY2UiLCJjcmVhdGVDYWNoZVVybCIsImNhY2hlVXJsIiwicmVxdWVzdFVybCIsInJlcGxhY2UiLCJ4aHJGb3IiLCJmZXRjaCIsInByZXJlbmRlclNhZmUiLCJyZXNwb25zZSIsImpzb24iLCJqc29uUmVzcG9uc2UiLCJhcHBseVNvdXJjZXNUb1ZpZGVvIiwiY2F0Y2giLCJwb3NzaWJsZVNvdXJjZXMiLCJxdWVyeVNlbGVjdG9yQWxsIiwiaSIsImxlbmd0aCIsInNvdXJjZXMiLCJzb3J0IiwiYSIsImIiLCJmb3JFYWNoIiwic291cmNlIiwic291cmNlRWwiLCJvd25lckRvY3VtZW50IiwiaW5zZXJ0QmVmb3JlIiwiZmlyc3RDaGlsZCIsImhhc0F0dHJpYnV0ZSIsImNyZWF0ZUVsZW1lbnQiLCJzcmNBdHRyIiwic2V0QXR0cmlidXRlIiwidHlwZUF0dHIiLCJyZW1vdmVBdHRyaWJ1dGUiLCJzb3VyY2VFbHMiLCJlbCIsImV4dGVuc2lvbnNGb3IiLCJpbnN0YWxsRXh0ZW5zaW9uRm9yRG9jIiwiY2FjaGVVcmxTZXJ2aWNlUHJvbWlzZUZvckRvYyJdLCJtYXBwaW5ncyI6Ijs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBRUEsU0FBUUEsUUFBUjtBQUNBLFNBQVFDLGNBQVIsRUFBd0JDLGtCQUF4QjtBQUNBLFNBQ0VDLDJCQURGLEVBRUVDLGFBRkYsRUFHRUMsYUFIRjtBQUtBLFNBQVFDLE9BQVI7QUFDQSxTQUFRQyxPQUFSO0FBQ0EsU0FBUUMsSUFBUjs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU8sU0FBU0Msa0JBQVQsQ0FDTEMsT0FESyxFQUVMQyxNQUZLLEVBR0xDLFVBSEssRUFJTDtBQUFBOztBQUFBLE1BREFBLFVBQ0E7QUFEQUEsSUFBQUEsVUFDQSxHQURhQyxNQUFNLENBQUNDLGlCQUNwQjtBQUFBOztBQUNBLE1BQU9DLEdBQVAsR0FBY0osTUFBZCxDQUFPSSxHQUFQOztBQUNBO0FBQ0EsTUFBSWYsUUFBUSxDQUFDZ0IsV0FBVCxDQUFxQkQsR0FBckIsRUFBMEJFLEtBQTFCLEVBQUosRUFBdUM7QUFDckMsV0FBTyxrQkFBUDtBQUNEOztBQUNELE1BQ0UsRUFDRVAsT0FBTyxDQUFDUSxZQUFSLENBQXFCLEtBQXJCLDhCQUNBUixPQUFPLENBQUNTLGFBQVIsQ0FBc0IsYUFBdEIsQ0FEQSxhQUNBLHNCQUFzQ0QsWUFBdEMsQ0FBbUQsS0FBbkQsQ0FGRixDQURGLEVBS0U7QUFDQVYsSUFBQUEsSUFBSSxHQUFHWSxLQUFQLENBQWEsV0FBYixFQUEwQixxQ0FBMUI7QUFDQSxXQUFPLG1CQUFQO0FBQ0Q7O0FBRURwQixFQUFBQSxRQUFRLENBQUNxQixjQUFULENBQXdCVixNQUFNLENBQUNJLEdB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Q0FBckI7QUFBQSxHQUFaLENBQWI7QUFFQXhELEVBQUFBLE9BQU8sQ0FBQytDLFlBQVIsQ0FBcUJGLFFBQXJCLEVBQStCN0MsT0FBTyxDQUFDZ0QsVUFBdkM7QUFDRDs7QUFFRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTNUIsa0JBQVQsQ0FBNEJwQixPQUE1QixFQUFxQ0MsTUFBckMsRUFBNkM7QUFDM0MsU0FBT1gsUUFBUSxDQUFDbUUsYUFBVCxDQUF1QnhELE1BQU0sQ0FBQ0ksR0FBOUIsRUFDSnFELHNCQURJLENBQ21CekQsTUFEbkIsRUFDMkIsZUFEM0IsRUFFSm9CLElBRkksQ0FFQztBQUFBLFdBQU0vQixRQUFRLENBQUNxRSw0QkFBVCxDQUFzQzNELE9BQXRDLENBQU47QUFBQSxHQUZELENBQVA7QUFHRCIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IDIwMjEgVGhlIEFNUCBIVE1MIEF1dGhvcnMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUy1JU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQge1NlcnZpY2VzfSBmcm9tICcjc2VydmljZSc7XG5pbXBvcnQge2FkZFBhcmFtc1RvVXJsLCByZXNvbHZlUmVsYXRpdmVVcmx9IGZyb20gJy4uLy4uLy4uL3NyYy91cmwnO1xuaW1wb3J0IHtcbiAgY3JlYXRlRWxlbWVudFdpdGhBdHRyaWJ1dGVzLFxuICBpdGVyYXRlQ3Vyc29yLFxuICByZW1vdmVFbGVtZW50LFxufSBmcm9tICcjY29yZS9kb20nO1xuaW1wb3J0IHttYXRjaGVzfSBmcm9tICcjY29yZS9kb20vcXVlcnknO1xuaW1wb3J0IHt0b0FycmF5fSBmcm9tICcjY29yZS90eXBlcy9hcnJheSc7XG5pbXBvcnQge3VzZXJ9IGZyb20gJy4uLy4uLy4uL3NyYy9sb2cnO1xuXG4vKipcbiAqIEFkZCB0aGUgY2FjaGluZyBzb3VyY2VzIHRvIHRoZSB2aWRlbyBpZiBvcHRlZCBpbi5cbiAqIFRoZSByZXF1ZXN0IGlzIHNlbnQgdG8gdGhlIEFNUCBjYWNoZSB1cmwgd2l0aCAvbWJ2IHBhdGggcHJlZml4LFxuICogYW5kIGFwcGVuZHMgdGhlIGRvY3VtZW50IGNhbm9uaWNhbCB1cmwgYXMgdGhlIHF1ZXJ5UGFyYW0gYGFtcF92aWRlb19ob3N0X3VybGAuXG4gKlxuICogQHBhcmFtIHshRWxlbWVudH0gdmlkZW9FbFxuICogQHBhcmFtIHshQW1wRG9jfSBhbXBkb2NcbiAqIEBwYXJhbSB7bnVtYmVyPX0gbWF4Qml0cmF0ZVxuICogQHJldHVybiB7IVByb21pc2V9XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBmZXRjaENhY2hlZFNvdXJjZXMoXG4gIHZpZGVvRWwsXG4gIGFtcGRvYyxcbiAgbWF4Qml0cmF0ZSA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWVxuKSB7XG4gIGNvbnN0IHt3aW59ID0gYW1wZG9jO1xuICAvLyBLZWVwIG5vbiBjYWNoZWQgZXZlcmdyZWVuIHNvdXJjZXMgZm9yIGNyYXdsZXJzLlxuICBpZiAoU2VydmljZXMucGxhdGZvcm1Gb3Iod2luKS5pc0JvdCgpKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICB9XG4gIGlmIChcbiAgICAhKFxuICAgICAgdmlkZW9FbC5nZXRBdHRyaWJ1dGUoJ3NyYycpIHx8XG4gICAgICB2aWRlb0VsLnF1ZXJ5U2VsZWN0b3IoJ3NvdXJjZVtzcmNdJyk/LmdldEF0dHJpYnV0ZSgnc3JjJylcbiAgICApXG4gICkge1xuICAgIHVzZXIoKS5lcnJvcignQU1QLVZJREVPJywgJ1ZpZGVvIGNhY2hlIG5vdCBwcm9wZXJseSBjb25maWd1cmVkJyk7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICB9XG5cbiAgU2VydmljZXMucGVyZm9ybWFuY2VGb3IoYW1wZG9jLndpbikuYWRkRW5hYmxlZEV4cGVyaW1lbnQoJ3ZpZGVvLWNhY2hlJyk7XG5cbiAgY29uc3Qge2Nhbm9uaWNhbFVybCwgc291cmNlVXJsfSA9IFNlcnZpY2VzLmRvY3VtZW50SW5mb0ZvckRvYyh3aW4uZG9jdW1lbnQpO1xuICBtYXliZVJlcGxhY2VTcmNXaXRoU291cmNlRWxlbWVudCh2aWRlb0VsLCB3aW4pO1xuICBjb25zdCB2aWRlb1VybCA9IHJlc29sdmVSZWxhdGl2ZVVybChzZWxlY3RWaWRlb1NvdXJjZSh2aWRlb0VsKSwgc291cmNlVXJsKTtcbiAgcmV0dXJuIGdldENhY2hlVXJsU2VydmljZSh2aWRlb0VsLCBhbXBkb2MpXG4gICAgLnRoZW4oKHNlcnZpY2UpID0+IHNlcnZpY2UuY3JlYXRlQ2FjaGVVcmwodmlkZW9VcmwpKVxuICAgIC50aGVuKChjYWNoZVVybCkgPT4ge1xuICAgICAgY29uc3QgcmVxdWVzdFVybCA9IGFkZFBhcmFtc1RvVXJsKGNhY2hlVXJsLnJlcGxhY2UoL1xcL1tpY11cXC8vLCAnL21idi8nKSwge1xuICAgICAgICAnYW1wX3ZpZGVvX2hvc3RfdXJsJzpcbiAgICAgICAgICAvKiBkb2N1bWVudCB1cmwgdGhhdCBjb250YWlucyB0aGUgdmlkZW8gKi8gY2Fub25pY2FsVXJsLFxuICAgICAgfSk7XG4gICAgICByZXR1cm4gU2VydmljZXMueGhyRm9yKHdpbikuZmV0Y2gocmVxdWVzdFVybCwge3ByZXJlbmRlclNhZmU6IHRydWV9KTtcbiAgICB9KVxuICAgIC50aGVuKChyZXNwb25zZSkgPT4gcmVzcG9uc2UuanNvbigpKVxuICAgIC50aGVuKChqc29uUmVzcG9uc2UpID0+XG4gICAgICBhcHBseVNvdXJjZXNUb1ZpZGVvKHZpZGVvRWwsIGpzb25SZXNwb25zZVsnc291cmNlcyddLCBtYXhCaXRyYXRlKVxuICAgIClcbiAgICAuY2F0Y2goKCkgPT4ge1xuICAgICAgLy8gSWYgY2FjaGUgZmFpbHMsIHZpZGVvIHNob3VsZCBzdGlsbCBsb2FkIHByb3Blcmx5LlxuICAgIH0pO1xufVxuXG4vKipcbiAqIFNlbGVjdHMgYW5kIHJldHVybnMgdGhlIHByaW9yaXRpemVkIHZpZGVvIHNvdXJjZSBVUkxcbiAqIEBwYXJhbSB7IUVsZW1lbnR9IHZpZGVvRWxcbiAqIEByZXR1cm4gez9zdHJpbmd9XG4gKi9cbmZ1bmN0aW9uIHNlbGVjdFZpZGVvU291cmNlKHZpZGVvRWwpIHtcbiAgY29uc3QgcG9zc2libGVTb3VyY2VzID0gdG9BcnJheSh2aWRlb0VsLnF1ZXJ5U2VsZWN0b3JBbGwoJ3NvdXJjZVtzcmNdJykpO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc3NpYmxlU291cmNlcy5sZW5ndGg7IGkrKykge1xuICAgIGlmIChtYXRjaGVzKHBvc3NpYmxlU291cmNlc1tpXSwgJ1t0eXBlKj1cInZpZGVvL21wNFwiXScpKSB7XG4gICAgICByZXR1cm4gcG9zc2libGVTb3VyY2VzW2ldLmdldEF0dHJpYnV0ZSgnc3JjJyk7XG4gICAgfVxuICB9XG4gIHJldHVybiBwb3NzaWJsZVNvdXJjZXNbMF0/LmdldEF0dHJpYnV0ZSgnc3JjJyk7XG59XG5cbi8qKlxuICpcbiAqIEBwYXJhbSB7IUVsZW1lbnR9IHZpZGVvRWxcbiAqIEBwYXJhbSB7IUFycmF5PCFPYmplY3Q+fSBzb3VyY2VzXG4gKiBAcGFyYW0ge251bWJlcn0gbWF4Qml0cmF0ZVxuICovXG5mdW5jdGlvbiBhcHBseVNvdXJjZXNUb1ZpZGVvKHZpZGVvRWwsIHNvdXJjZXMsIG1heEJpdHJhdGUpIHtcbiAgc291cmNlc1xuICAgIC5zb3J0KChhLCBiKSA9PiBhWydiaXRyYXRlX2ticHMnXSAtIGJbJ2JpdHJhdGVfa2JwcyddKVxuICAgIC5mb3JFYWNoKChzb3VyY2UpID0+IHtcbiAgICAgIGlmIChzb3VyY2VbJ2JpdHJhdGVfa2JwcyddID4gbWF4Qml0cmF0ZSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBjb25zdCBzb3VyY2VFbCA9IGNyZWF0ZUVsZW1lbnRXaXRoQXR0cmlidXRlcyhcbiAgICAgICAgdmlkZW9FbC5vd25lckRvY3VtZW50LFxuICAgICAgICAnc291cmNlJyxcbiAgICAgICAge1xuICAgICAgICAgICdzcmMnOiBzb3VyY2VbJ3VybCddLFxuICAgICAgICAgICd0eXBlJzogc291cmNlWyd0eXBlJ10sXG4gICAgICAgICAgJ2RhdGEtYml0cmF0ZSc6IHNvdXJjZVsnYml0cmF0ZV9rYnBzJ10sXG4gICAgICAgICAgJ2ktYW1waHRtbC12aWRlby1jYWNoZWQtc291cmNlJzogJycsXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICB2aWRlb0VsLmluc2VydEJlZm9yZShzb3VyY2VFbCwgdmlkZW9FbC5maXJzdENoaWxkKTtcbiAgICB9KTtcbn1cblxuLyoqXG4gKiBJZiBwcmVzZW50LCBtb3ZlcyB0aGUgc3JjIGF0dHJpYnV0ZSB0byBhIHNvdXJjZSBlbGVtZW50IHRvIGVuYWJsZSBwbGF5aW5nXG4gKiBmcm9tIG11bHRpcGxlIHNvdXJjZXM6IHRoZSBjYWNoZWQgb25lcyBhbmQgdGhlIGZhbGxiYWNrIGluaXRpYWwgc3JjLlxuICogQHBhcmFtIHshRWxlbWVudH0gdmlkZW9FbFxuICogQHBhcmFtIHshV2luZG93fSB3aW5cbiAqL1xuZnVuY3Rpb24gbWF5YmVSZXBsYWNlU3JjV2l0aFNvdXJjZUVsZW1lbnQodmlkZW9FbCwgd2luKSB7XG4gIGlmICghdmlkZW9FbC5oYXNBdHRyaWJ1dGUoJ3NyYycpKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGNvbnN0IHNvdXJjZUVsID0gd2luLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NvdXJjZScpO1xuICBjb25zdCBzcmNBdHRyID0gdmlkZW9FbC5nZXRBdHRyaWJ1dGUoJ3NyYycpO1xuICBzb3VyY2VFbC5zZXRBdHRyaWJ1dGUoJ3NyYycsIHNyY0F0dHIpO1xuXG4gIGNvbnN0IHR5cGVBdHRyID0gdmlkZW9FbC5nZXRBdHRyaWJ1dGUoJ3R5cGUnKTtcbiAgaWYgKHR5cGVBdHRyKSB7XG4gICAgc291cmNlRWwuc2V0QXR0cmlidXRlKCd0eXBlJywgdHlwZUF0dHIpO1xuICB9XG5cbiAgLy8gUmVtb3ZlIHRoZSBzcmMgYXR0ciBzbyB0aGUgc291cmNlIGNoaWxkcmVuIGNhbiBwbGF5LlxuICB2aWRlb0VsLnJlbW92ZUF0dHJpYnV0ZSgnc3JjJyk7XG4gIHZpZGVvRWwucmVtb3ZlQXR0cmlidXRlKCd0eXBlJyk7XG5cbiAgLy8gUmVtb3ZlIGFsbCBleGlzdGluZyBzb3VyY2VzIGFzIHRoZXkgYXJlIG5ldmVyIHN1cHBvc2VkIHRvIHBsYXkgZm9yIGEgdmlkZW9cbiAgLy8gdGhhdCBoYXMgYSBzcmMsIGNmIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvI2NvbmNlcHQtbWVkaWEtbG9hZC1hbGdvcml0aG1cbiAgY29uc3Qgc291cmNlRWxzID0gdmlkZW9FbC5xdWVyeVNlbGVjdG9yQWxsKCdzb3VyY2UnKTtcbiAgaXRlcmF0ZUN1cnNvcihzb3VyY2VFbHMsIChlbCkgPT4gcmVtb3ZlRWxlbWVudChlbCkpO1xuXG4gIHZpZGVvRWwuaW5zZXJ0QmVmb3JlKHNvdXJjZUVsLCB2aWRlb0VsLmZpcnN0Q2hpbGQpO1xufVxuXG4vKipcbiAqIExhenkgbG9hZHMgdGhlIGFtcC1jYWNoZS11cmwgZXh0ZW5zaW9uIGlmIG5lZWRlZCBhbmQgcmV0cmlldmVzIGl0cyBzZXJ2aWNlLlxuICogQHBhcmFtIHshRWxlbWVudH0gdmlkZW9FbFxuICogQHBhcmFtIHshQW1wRG9jfSBhbXBkb2NcbiAqIEByZXR1cm4geyFQcm9taXNlPC4uLy4uLy4uL2FtcC1jYWNoZS11cmwvYW1wLWNhY2hlLXVybC5BbXBDYWNoZVVybFNlcnZpY2U+fVxuICovXG5mdW5jdGlvbiBnZXRDYWNoZVVybFNlcnZpY2UodmlkZW9FbCwgYW1wZG9jKSB7XG4gIHJldHVybiBTZXJ2aWNlcy5leHRlbnNpb25zRm9yKGFtcGRvYy53aW4pXG4gICAgLmluc3RhbGxFeHRlbnNpb25Gb3JEb2MoYW1wZG9jLCAnYW1wLWNhY2hlLXVybCcpXG4gICAgLnRoZW4oKCkgPT4gU2VydmljZXMuY2FjaGVVcmxTZXJ2aWNlUHJvbWlzZUZvckRvYyh2aWRlb0VsKSk7XG59XG4iXX0=
// /Users/mszylkowski/src/amphtml/extensions/amp-video/0.1/video-cache.js