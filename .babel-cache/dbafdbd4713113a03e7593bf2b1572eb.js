/**
 * Copyright 2020 The AMP HTML Authors. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS-IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { transparentPng } from "../core/dom/img";
import { getLengthNumeral } from "../core/dom/layout";
import { closestAncestorElementBySelector } from "../core/dom/query";
import { Services } from "./";

/**
 * IE can't handle auto-scaling SVG images used for intrinsic layout. Generate
 * a transparent PNG for SSR rendered sizers instead.
 * @param {!Window} win
 * @param {!../service/platform-impl.Platform=} opt_platform
 * @package
 */
export function ieIntrinsicCheckAndFix(win, opt_platform) {
  var platform = opt_platform || Services.platformFor(win);

  if (!platform.isIe()) {
    return;
  }

  var document = win.document;
  var intrinsics = document.querySelectorAll('.i-amphtml-intrinsic-sizer[src^="data:image/svg"]');

  for (var i = 0; i < intrinsics.length; i++) {
    var intrinsic = intrinsics[i];
    var element = closestAncestorElementBySelector(intrinsic, '.i-amphtml-element');

    if (!element) {
      continue;
    }

    var width = getLengthNumeral(element.getAttribute('width'));
    var height = getLengthNumeral(element.getAttribute('height'));

    if (width && height) {
      intrinsic.src = transparentPng(document, width, height);
    }
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImllLWludHJpbnNpYy1idWcuanMiXSwibmFtZXMiOlsidHJhbnNwYXJlbnRQbmciLCJnZXRMZW5ndGhOdW1lcmFsIiwiY2xvc2VzdEFuY2VzdG9yRWxlbWVudEJ5U2VsZWN0b3IiLCJTZXJ2aWNlcyIsImllSW50cmluc2ljQ2hlY2tBbmRGaXgiLCJ3aW4iLCJvcHRfcGxhdGZvcm0iLCJwbGF0Zm9ybSIsInBsYXRmb3JtRm9yIiwiaXNJZSIsImRvY3VtZW50IiwiaW50cmluc2ljcyIsInF1ZXJ5U2VsZWN0b3JBbGwiLCJpIiwibGVuZ3RoIiwiaW50cmluc2ljIiwiZWxlbWVudCIsIndpZHRoIiwiZ2V0QXR0cmlidXRlIiwiaGVpZ2h0Iiwic3JjIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFFQSxTQUFRQSxjQUFSO0FBQ0EsU0FBUUMsZ0JBQVI7QUFDQSxTQUFRQyxnQ0FBUjtBQUVBLFNBQVFDLFFBQVI7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPLFNBQVNDLHNCQUFULENBQWdDQyxHQUFoQyxFQUFxQ0MsWUFBckMsRUFBbUQ7QUFDeEQsTUFBTUMsUUFBUSxHQUFHRCxZQUFZLElBQUlILFFBQVEsQ0FBQ0ssV0FBVCxDQUFxQkgsR0FBckIsQ0FBakM7O0FBQ0EsTUFBSSxDQUFDRSxRQUFRLENBQUNFLElBQVQsRUFBTCxFQUFzQjtBQUNwQjtBQUNEOztBQUVELE1BQU9DLFFBQVAsR0FBbUJMLEdBQW5CLENBQU9LLFFBQVA7QUFDQSxNQUFNQyxVQUFVLEdBQUdELFFBQVEsQ0FBQ0UsZ0JBQVQsQ0FDakIsbURBRGlCLENBQW5COztBQUdBLE9BQUssSUFBSUMsQ0FBQyxHQUFHLENBQWIsRUFBZ0JBLENBQUMsR0FBR0YsVUFBVSxDQUFDRyxNQUEvQixFQUF1Q0QsQ0FBQyxFQUF4QyxFQUE0QztBQUMxQyxRQUFNRSxTQUFTLEdBQUdKLFVBQVUsQ0FBQ0UsQ0FBRCxDQUE1QjtBQUNBLFFBQU1HLE9BQU8sR0FBR2QsZ0NBQWdDLENBQzlDYSxTQUQ4QyxFQUU5QyxvQkFGOEMsQ0FBaEQ7O0FBSUEsUUFBSSxDQUFDQyxPQUFMLEVBQWM7QUFDWjtBQUNEOztBQUNELFFBQU1DLEtBQUssR0FBR2hCLGdCQUFnQixDQUFDZSxPQUFPLENBQUNFLFlBQVIsQ0FBcUIsT0FBckIsQ0FBRCxDQUE5QjtBQUNBLFFBQU1DLE1BQU0sR0FBR2xCLGdCQUFnQixDQUFDZSxPQUFPLENBQUNFLFlBQVIsQ0FBcUIsUUFBckIsQ0FBRCxDQUEvQjs7QUFDQSxRQUFJRCxLQUFLLElBQUlFLE1BQWIsRUFBcUI7QUFDbkJKLE1BQUFBLFNBQVMsQ0FBQ0ssR0FBVixHQUFnQnBCLGNBQWMsQ0FBQ1UsUUFBRCxFQUFXTyxLQUFYLEVBQWtCRSxNQUFsQixDQUE5QjtBQUNEO0FBQ0Y7QUFDRiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IDIwMjAgVGhlIEFNUCBIVE1MIEF1dGhvcnMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUy1JU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQge3RyYW5zcGFyZW50UG5nfSBmcm9tICcjY29yZS9kb20vaW1nJztcbmltcG9ydCB7Z2V0TGVuZ3RoTnVtZXJhbH0gZnJvbSAnI2NvcmUvZG9tL2xheW91dCc7XG5pbXBvcnQge2Nsb3Nlc3RBbmNlc3RvckVsZW1lbnRCeVNlbGVjdG9yfSBmcm9tICcjY29yZS9kb20vcXVlcnknO1xuXG5pbXBvcnQge1NlcnZpY2VzfSBmcm9tICcjc2VydmljZSc7XG5cbi8qKlxuICogSUUgY2FuJ3QgaGFuZGxlIGF1dG8tc2NhbGluZyBTVkcgaW1hZ2VzIHVzZWQgZm9yIGludHJpbnNpYyBsYXlvdXQuIEdlbmVyYXRlXG4gKiBhIHRyYW5zcGFyZW50IFBORyBmb3IgU1NSIHJlbmRlcmVkIHNpemVycyBpbnN0ZWFkLlxuICogQHBhcmFtIHshV2luZG93fSB3aW5cbiAqIEBwYXJhbSB7IS4uL3NlcnZpY2UvcGxhdGZvcm0taW1wbC5QbGF0Zm9ybT19IG9wdF9wbGF0Zm9ybVxuICogQHBhY2thZ2VcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGllSW50cmluc2ljQ2hlY2tBbmRGaXgod2luLCBvcHRfcGxhdGZvcm0pIHtcbiAgY29uc3QgcGxhdGZvcm0gPSBvcHRfcGxhdGZvcm0gfHwgU2VydmljZXMucGxhdGZvcm1Gb3Iod2luKTtcbiAgaWYgKCFwbGF0Zm9ybS5pc0llKCkpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCB7ZG9jdW1lbnR9ID0gd2luO1xuICBjb25zdCBpbnRyaW5zaWNzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcbiAgICAnLmktYW1waHRtbC1pbnRyaW5zaWMtc2l6ZXJbc3JjXj1cImRhdGE6aW1hZ2Uvc3ZnXCJdJ1xuICApO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGludHJpbnNpY3MubGVuZ3RoOyBpKyspIHtcbiAgICBjb25zdCBpbnRyaW5zaWMgPSBpbnRyaW5zaWNzW2ldO1xuICAgIGNvbnN0IGVsZW1lbnQgPSBjbG9zZXN0QW5jZXN0b3JFbGVtZW50QnlTZWxlY3RvcihcbiAgICAgIGludHJpbnNpYyxcbiAgICAgICcuaS1hbXBodG1sLWVsZW1lbnQnXG4gICAgKTtcbiAgICBpZiAoIWVsZW1lbnQpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cbiAgICBjb25zdCB3aWR0aCA9IGdldExlbmd0aE51bWVyYWwoZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3dpZHRoJykpO1xuICAgIGNvbnN0IGhlaWdodCA9IGdldExlbmd0aE51bWVyYWwoZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2hlaWdodCcpKTtcbiAgICBpZiAod2lkdGggJiYgaGVpZ2h0KSB7XG4gICAgICBpbnRyaW5zaWMuc3JjID0gdHJhbnNwYXJlbnRQbmcoZG9jdW1lbnQsIHdpZHRoLCBoZWlnaHQpO1xuICAgIH1cbiAgfVxufVxuIl19
// /Users/mszylkowski/src/amphtml/src/service/ie-intrinsic-bug.js