/**
 * Copyright 2020 The AMP HTML Authors. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS-IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Deferred } from "../../data-structures/promise";
import { dict } from "../../types/object";
import { toWin } from "../../window";
import { LayoutRectDef, layoutRectFromDomRect } from "./rect";
import { createViewportObserver } from "./viewport-observer";

/** @type {!WeakMap<!Element, !Deferred<!IntersectionObserverEntry>>|undefined} */
var intersectionDeferreds;

/** @type {!WeakMap<!Window, !IntersectionObserver>|undefined} */
var intersectionObservers;

/**
 * @param {!Window} win
 * @return {!IntersectionObserver}
 */
function getInOb(win) {
  if (!intersectionDeferreds) {
    intersectionDeferreds = new WeakMap();
    intersectionObservers = new WeakMap();
  }

  var observer = intersectionObservers.get(win);

  if (!observer) {
    observer = createViewportObserver(function (entries) {
      var seen = new Set();

      for (var i = entries.length - 1; i >= 0; i--) {
        var target = entries[i].target;

        if (seen.has(target)) {
          continue;
        }

        seen.add(target);
        observer.unobserve(target);
        intersectionDeferreds.get(target).resolve(entries[i]);
        intersectionDeferreds.delete(target);
      }
    }, win, {
      needsRootBounds: true
    });
    intersectionObservers.set(win, observer);
  }

  return observer;
}

/**
 * Returns a promise that resolves with the intersection entry for the given element.
 *
 * If multiple measures for the same element occur very quickly, they will
 * dedupe to the same promise.
 *
 * @param {!Element} el
 * @return {!Promise<!IntersectionObserverEntry>}
 */
export function measureIntersection(el) {
  if (intersectionDeferreds && intersectionDeferreds.has(el)) {
    return intersectionDeferreds.get(el).promise;
  }

  var inOb = getInOb(toWin(el.ownerDocument.defaultView));
  inOb.observe(el);
  var deferred = new Deferred();
  intersectionDeferreds.set(el, deferred);
  return deferred.promise;
}

/**
 * Convert an IntersectionObserverEntry to a regular object to make it serializable.
 *
 * @param {!IntersectionObserverEntry} entry
 * @return {!JsonObject}
 */
export function intersectionEntryToJson(entry) {
  return dict({
    'time': entry.time,
    'rootBounds': safeLayoutRectFromDomRect(entry.rootBounds),
    'boundingClientRect': safeLayoutRectFromDomRect(entry.boundingClientRect),
    'intersectionRect': safeLayoutRectFromDomRect(entry.intersectionRect),
    'intersectionRatio': entry.intersectionRatio
  });
}

/**
 * @param {?} rect
 * @return {?LayoutRectDef}
 */
function safeLayoutRectFromDomRect(rect) {
  if (rect === null) {
    return null;
  }

  return layoutRectFromDomRect(
  /** @type {!ClientRect} */
  rect);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImludGVyc2VjdGlvbi5qcyJdLCJuYW1lcyI6WyJEZWZlcnJlZCIsImRpY3QiLCJ0b1dpbiIsIkxheW91dFJlY3REZWYiLCJsYXlvdXRSZWN0RnJvbURvbVJlY3QiLCJjcmVhdGVWaWV3cG9ydE9ic2VydmVyIiwiaW50ZXJzZWN0aW9uRGVmZXJyZWRzIiwiaW50ZXJzZWN0aW9uT2JzZXJ2ZXJzIiwiZ2V0SW5PYiIsIndpbiIsIldlYWtNYXAiLCJvYnNlcnZlciIsImdldCIsImVudHJpZXMiLCJzZWVuIiwiU2V0IiwiaSIsImxlbmd0aCIsInRhcmdldCIsImhhcyIsImFkZCIsInVub2JzZXJ2ZSIsInJlc29sdmUiLCJkZWxldGUiLCJuZWVkc1Jvb3RCb3VuZHMiLCJzZXQiLCJtZWFzdXJlSW50ZXJzZWN0aW9uIiwiZWwiLCJwcm9taXNlIiwiaW5PYiIsIm93bmVyRG9jdW1lbnQiLCJkZWZhdWx0VmlldyIsIm9ic2VydmUiLCJkZWZlcnJlZCIsImludGVyc2VjdGlvbkVudHJ5VG9Kc29uIiwiZW50cnkiLCJ0aW1lIiwic2FmZUxheW91dFJlY3RGcm9tRG9tUmVjdCIsInJvb3RCb3VuZHMiLCJib3VuZGluZ0NsaWVudFJlY3QiLCJpbnRlcnNlY3Rpb25SZWN0IiwiaW50ZXJzZWN0aW9uUmF0aW8iLCJyZWN0Il0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFRQSxRQUFSO0FBQ0EsU0FBUUMsSUFBUjtBQUNBLFNBQVFDLEtBQVI7QUFFQSxTQUFRQyxhQUFSLEVBQXVCQyxxQkFBdkI7QUFDQSxTQUFRQyxzQkFBUjs7QUFFQTtBQUNBLElBQUlDLHFCQUFKOztBQUVBO0FBQ0EsSUFBSUMscUJBQUo7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTQyxPQUFULENBQWlCQyxHQUFqQixFQUFzQjtBQUNwQixNQUFJLENBQUNILHFCQUFMLEVBQTRCO0FBQzFCQSxJQUFBQSxxQkFBcUIsR0FBRyxJQUFJSSxPQUFKLEVBQXhCO0FBQ0FILElBQUFBLHFCQUFxQixHQUFHLElBQUlHLE9BQUosRUFBeEI7QUFDRDs7QUFFRCxNQUFJQyxRQUFRLEdBQUdKLHFCQUFxQixDQUFDSyxHQUF0QixDQUEwQkgsR0FBMUIsQ0FBZjs7QUFDQSxNQUFJLENBQUNFLFFBQUwsRUFBZTtBQUNiQSxJQUFBQSxRQUFRLEdBQUdOLHNCQUFzQixDQUMvQixVQUFDUSxPQUFELEVBQWE7QUFDWCxVQUFNQyxJQUFJLEdBQUcsSUFBSUMsR0FBSixFQUFiOztBQUNBLFdBQUssSUFBSUMsQ0FBQyxHQUFHSCxPQUFPLENBQUNJLE1BQVIsR0FBaUIsQ0FBOUIsRUFBaUNELENBQUMsSUFBSSxDQUF0QyxFQUF5Q0EsQ0FBQyxFQUExQyxFQUE4QztBQUM1QyxZQUFPRSxNQUFQLEdBQWlCTCxPQUFPLENBQUNHLENBQUQsQ0FBeEIsQ0FBT0UsTUFBUDs7QUFDQSxZQUFJSixJQUFJLENBQUNLLEdBQUwsQ0FBU0QsTUFBVCxDQUFKLEVBQXNCO0FBQ3BCO0FBQ0Q7O0FBQ0RKLFFBQUFBLElBQUksQ0FBQ00sR0FBTCxDQUFTRixNQUFUO0FBRUFQLFFBQUFBLFFBQVEsQ0FBQ1UsU0FBVCxDQUFtQkgsTUFBbkI7QUFDQVosUUFBQUEscUJBQXFCLENBQUNNLEdBQXRCLENBQTBCTSxNQUExQixFQUFrQ0ksT0FBbEMsQ0FBMENULE9BQU8sQ0FBQ0csQ0FBRCxDQUFqRDtBQUNBVixRQUFBQSxxQkFBcUIsQ0FBQ2lCLE1BQXRCLENBQTZCTCxNQUE3QjtBQUNEO0FBQ0YsS0FkOEIsRUFlL0JULEdBZitCLEVBZ0IvQjtBQUFDZSxNQUFBQSxlQUFlLEVBQUU7QUFBbEIsS0FoQitCLENBQWpDO0FBa0JBakIsSUFBQUEscUJBQXFCLENBQUNrQixHQUF0QixDQUEwQmhCLEdBQTFCLEVBQStCRSxRQUEvQjtBQUNEOztBQUNELFNBQU9BLFFBQVA7QUFDRDs7QUFFRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPLFNBQVNlLG1CQUFULENBQTZCQyxFQUE3QixFQUFpQztBQUN0QyxNQUFJckIscUJBQXFCLElBQUlBLHFCQUFxQixDQUFDYSxHQUF0QixDQUEwQlEsRUFBMUIsQ0FBN0IsRUFBNEQ7QUFDMUQsV0FBT3JCLHFCQUFxQixDQUFDTSxHQUF0QixDQUEwQmUsRUFBMUIsRUFBOEJDLE9BQXJDO0FBQ0Q7O0FBRUQsTUFBTUMsSUFBSSxHQUFHckIsT0FBTyxDQUFDTixLQUFLLENBQUN5QixFQUFFLENBQUNHLGFBQUgsQ0FBaUJDLFdBQWxCLENBQU4sQ0FBcEI7QUFDQUYsRUFBQUEsSUFBSSxDQUFDRyxPQUFMLENBQWFMLEVBQWI7QUFFQSxNQUFNTSxRQUFRLEdBQUcsSUFBSWpDLFFBQUosRUFBakI7QUFDQU0sRUFBQUEscUJBQXFCLENBQUNtQixHQUF0QixDQUEwQkUsRUFBMUIsRUFBOEJNLFFBQTlCO0FBQ0EsU0FBT0EsUUFBUSxDQUFDTCxPQUFoQjtBQUNEOztBQUVEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU8sU0FBU00sdUJBQVQsQ0FBaUNDLEtBQWpDLEVBQXdDO0FBQzdDLFNBQU9sQyxJQUFJLENBQUM7QUFDVixZQUFRa0MsS0FBSyxDQUFDQyxJQURKO0FBRVYsa0JBQWNDLHlCQUF5QixDQUFDRixLQUFLLENBQUNHLFVBQVAsQ0FGN0I7QUFHViwwQkFBc0JELHlCQUF5QixDQUFDRixLQUFLLENBQUNJLGtCQUFQLENBSHJDO0FBSVYsd0JBQW9CRix5QkFBeUIsQ0FBQ0YsS0FBSyxDQUFDSyxnQkFBUCxDQUpuQztBQUtWLHlCQUFxQkwsS0FBSyxDQUFDTTtBQUxqQixHQUFELENBQVg7QUFPRDs7QUFFRDtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVNKLHlCQUFULENBQW1DSyxJQUFuQyxFQUF5QztBQUN2QyxNQUFJQSxJQUFJLEtBQUssSUFBYixFQUFtQjtBQUNqQixXQUFPLElBQVA7QUFDRDs7QUFDRCxTQUFPdEMscUJBQXFCO0FBQUM7QUFBNEJzQyxFQUFBQSxJQUE3QixDQUE1QjtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgMjAyMCBUaGUgQU1QIEhUTUwgQXV0aG9ycy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTLUlTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5pbXBvcnQge0RlZmVycmVkfSBmcm9tICcjY29yZS9kYXRhLXN0cnVjdHVyZXMvcHJvbWlzZSc7XG5pbXBvcnQge2RpY3R9IGZyb20gJyNjb3JlL3R5cGVzL29iamVjdCc7XG5pbXBvcnQge3RvV2lufSBmcm9tICcjY29yZS93aW5kb3cnO1xuXG5pbXBvcnQge0xheW91dFJlY3REZWYsIGxheW91dFJlY3RGcm9tRG9tUmVjdH0gZnJvbSAnLi9yZWN0JztcbmltcG9ydCB7Y3JlYXRlVmlld3BvcnRPYnNlcnZlcn0gZnJvbSAnLi92aWV3cG9ydC1vYnNlcnZlcic7XG5cbi8qKiBAdHlwZSB7IVdlYWtNYXA8IUVsZW1lbnQsICFEZWZlcnJlZDwhSW50ZXJzZWN0aW9uT2JzZXJ2ZXJFbnRyeT4+fHVuZGVmaW5lZH0gKi9cbmxldCBpbnRlcnNlY3Rpb25EZWZlcnJlZHM7XG5cbi8qKiBAdHlwZSB7IVdlYWtNYXA8IVdpbmRvdywgIUludGVyc2VjdGlvbk9ic2VydmVyPnx1bmRlZmluZWR9ICovXG5sZXQgaW50ZXJzZWN0aW9uT2JzZXJ2ZXJzO1xuXG4vKipcbiAqIEBwYXJhbSB7IVdpbmRvd30gd2luXG4gKiBAcmV0dXJuIHshSW50ZXJzZWN0aW9uT2JzZXJ2ZXJ9XG4gKi9cbmZ1bmN0aW9uIGdldEluT2Iod2luKSB7XG4gIGlmICghaW50ZXJzZWN0aW9uRGVmZXJyZWRzKSB7XG4gICAgaW50ZXJzZWN0aW9uRGVmZXJyZWRzID0gbmV3IFdlYWtNYXAoKTtcbiAgICBpbnRlcnNlY3Rpb25PYnNlcnZlcnMgPSBuZXcgV2Vha01hcCgpO1xuICB9XG5cbiAgbGV0IG9ic2VydmVyID0gaW50ZXJzZWN0aW9uT2JzZXJ2ZXJzLmdldCh3aW4pO1xuICBpZiAoIW9ic2VydmVyKSB7XG4gICAgb2JzZXJ2ZXIgPSBjcmVhdGVWaWV3cG9ydE9ic2VydmVyKFxuICAgICAgKGVudHJpZXMpID0+IHtcbiAgICAgICAgY29uc3Qgc2VlbiA9IG5ldyBTZXQoKTtcbiAgICAgICAgZm9yIChsZXQgaSA9IGVudHJpZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgICBjb25zdCB7dGFyZ2V0fSA9IGVudHJpZXNbaV07XG4gICAgICAgICAgaWYgKHNlZW4uaGFzKHRhcmdldCkpIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBzZWVuLmFkZCh0YXJnZXQpO1xuXG4gICAgICAgICAgb2JzZXJ2ZXIudW5vYnNlcnZlKHRhcmdldCk7XG4gICAgICAgICAgaW50ZXJzZWN0aW9uRGVmZXJyZWRzLmdldCh0YXJnZXQpLnJlc29sdmUoZW50cmllc1tpXSk7XG4gICAgICAgICAgaW50ZXJzZWN0aW9uRGVmZXJyZWRzLmRlbGV0ZSh0YXJnZXQpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgd2luLFxuICAgICAge25lZWRzUm9vdEJvdW5kczogdHJ1ZX1cbiAgICApO1xuICAgIGludGVyc2VjdGlvbk9ic2VydmVycy5zZXQod2luLCBvYnNlcnZlcik7XG4gIH1cbiAgcmV0dXJuIG9ic2VydmVyO1xufVxuXG4vKipcbiAqIFJldHVybnMgYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgd2l0aCB0aGUgaW50ZXJzZWN0aW9uIGVudHJ5IGZvciB0aGUgZ2l2ZW4gZWxlbWVudC5cbiAqXG4gKiBJZiBtdWx0aXBsZSBtZWFzdXJlcyBmb3IgdGhlIHNhbWUgZWxlbWVudCBvY2N1ciB2ZXJ5IHF1aWNrbHksIHRoZXkgd2lsbFxuICogZGVkdXBlIHRvIHRoZSBzYW1lIHByb21pc2UuXG4gKlxuICogQHBhcmFtIHshRWxlbWVudH0gZWxcbiAqIEByZXR1cm4geyFQcm9taXNlPCFJbnRlcnNlY3Rpb25PYnNlcnZlckVudHJ5Pn1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG1lYXN1cmVJbnRlcnNlY3Rpb24oZWwpIHtcbiAgaWYgKGludGVyc2VjdGlvbkRlZmVycmVkcyAmJiBpbnRlcnNlY3Rpb25EZWZlcnJlZHMuaGFzKGVsKSkge1xuICAgIHJldHVybiBpbnRlcnNlY3Rpb25EZWZlcnJlZHMuZ2V0KGVsKS5wcm9taXNlO1xuICB9XG5cbiAgY29uc3QgaW5PYiA9IGdldEluT2IodG9XaW4oZWwub3duZXJEb2N1bWVudC5kZWZhdWx0VmlldykpO1xuICBpbk9iLm9ic2VydmUoZWwpO1xuXG4gIGNvbnN0IGRlZmVycmVkID0gbmV3IERlZmVycmVkKCk7XG4gIGludGVyc2VjdGlvbkRlZmVycmVkcy5zZXQoZWwsIGRlZmVycmVkKTtcbiAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG59XG5cbi8qKlxuICogQ29udmVydCBhbiBJbnRlcnNlY3Rpb25PYnNlcnZlckVudHJ5IHRvIGEgcmVndWxhciBvYmplY3QgdG8gbWFrZSBpdCBzZXJpYWxpemFibGUuXG4gKlxuICogQHBhcmFtIHshSW50ZXJzZWN0aW9uT2JzZXJ2ZXJFbnRyeX0gZW50cnlcbiAqIEByZXR1cm4geyFKc29uT2JqZWN0fVxuICovXG5leHBvcnQgZnVuY3Rpb24gaW50ZXJzZWN0aW9uRW50cnlUb0pzb24oZW50cnkpIHtcbiAgcmV0dXJuIGRpY3Qoe1xuICAgICd0aW1lJzogZW50cnkudGltZSxcbiAgICAncm9vdEJvdW5kcyc6IHNhZmVMYXlvdXRSZWN0RnJvbURvbVJlY3QoZW50cnkucm9vdEJvdW5kcyksXG4gICAgJ2JvdW5kaW5nQ2xpZW50UmVjdCc6IHNhZmVMYXlvdXRSZWN0RnJvbURvbVJlY3QoZW50cnkuYm91bmRpbmdDbGllbnRSZWN0KSxcbiAgICAnaW50ZXJzZWN0aW9uUmVjdCc6IHNhZmVMYXlvdXRSZWN0RnJvbURvbVJlY3QoZW50cnkuaW50ZXJzZWN0aW9uUmVjdCksXG4gICAgJ2ludGVyc2VjdGlvblJhdGlvJzogZW50cnkuaW50ZXJzZWN0aW9uUmF0aW8sXG4gIH0pO1xufVxuXG4vKipcbiAqIEBwYXJhbSB7P30gcmVjdFxuICogQHJldHVybiB7P0xheW91dFJlY3REZWZ9XG4gKi9cbmZ1bmN0aW9uIHNhZmVMYXlvdXRSZWN0RnJvbURvbVJlY3QocmVjdCkge1xuICBpZiAocmVjdCA9PT0gbnVsbCkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG4gIHJldHVybiBsYXlvdXRSZWN0RnJvbURvbVJlY3QoLyoqIEB0eXBlIHshQ2xpZW50UmVjdH0gKi8gKHJlY3QpKTtcbn1cbiJdfQ==
// /Users/mszylkowski/src/amphtml/src/core/dom/layout/intersection.js