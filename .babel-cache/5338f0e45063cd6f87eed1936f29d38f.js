/**
 * Copyright 2019 The AMP HTML Authors. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS-IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { VisibilityState } from "./constants/visibility-state";
import { getVendorJsPropertyName } from "./dom/style";

/**
 * @param {!Document} doc
 * @return {!VisibilityState}
 */
export function getDocumentVisibilityState(doc) {
  // New API: `document.visibilityState` property.
  var visibilityStateProp = getVendorJsPropertyName(doc, 'visibilityState', true);

  if (doc[visibilityStateProp]) {
    return doc[visibilityStateProp];
  }

  // Old API: `document.hidden` property.
  var hiddenProp = getVendorJsPropertyName(doc, 'hidden', true);

  if (doc[hiddenProp]) {
    return doc[hiddenProp] ? VisibilityState.HIDDEN : VisibilityState.VISIBLE;
  }

  return VisibilityState.VISIBLE;
}

/**
 * Returns the value of "document.hidden" property. The reasons why it may
 * not be visible include document in a non-active tab or when the document
 * is being pre-rendered via link with rel="prerender".
 * @param {!Document} doc
 * @return {boolean}
 */
export function isDocumentHidden(doc) {
  return getDocumentVisibilityState(doc) != VisibilityState.VISIBLE;
}

/**
 * @param {!Document} doc
 * @param {function()} handler
 */
export function addDocumentVisibilityChangeListener(doc, handler) {
  if (!doc.addEventListener) {
    return;
  }

  var visibilityChangeEvent = getVisibilityChangeEvent(doc);

  if (visibilityChangeEvent) {
    doc.addEventListener(visibilityChangeEvent, handler);
  }
}

/**
 * @param {!Document} doc
 * @param {function()} handler
 */
export function removeDocumentVisibilityChangeListener(doc, handler) {
  if (!doc.removeEventListener) {
    return;
  }

  var visibilityChangeEvent = getVisibilityChangeEvent(doc);

  if (visibilityChangeEvent) {
    doc.removeEventListener(visibilityChangeEvent, handler);
  }
}

/**
 * @param {!Document} doc
 * @return {?string}
 */
function getVisibilityChangeEvent(doc) {
  var hiddenProp = getVendorJsPropertyName(doc, 'hidden', true);
  var vendorStop = hiddenProp.indexOf('Hidden');
  return vendorStop != -1 ? hiddenProp.substring(0, vendorStop) + 'Visibilitychange' : 'visibilitychange';
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRvY3VtZW50LXZpc2liaWxpdHkuanMiXSwibmFtZXMiOlsiVmlzaWJpbGl0eVN0YXRlIiwiZ2V0VmVuZG9ySnNQcm9wZXJ0eU5hbWUiLCJnZXREb2N1bWVudFZpc2liaWxpdHlTdGF0ZSIsImRvYyIsInZpc2liaWxpdHlTdGF0ZVByb3AiLCJoaWRkZW5Qcm9wIiwiSElEREVOIiwiVklTSUJMRSIsImlzRG9jdW1lbnRIaWRkZW4iLCJhZGREb2N1bWVudFZpc2liaWxpdHlDaGFuZ2VMaXN0ZW5lciIsImhhbmRsZXIiLCJhZGRFdmVudExpc3RlbmVyIiwidmlzaWJpbGl0eUNoYW5nZUV2ZW50IiwiZ2V0VmlzaWJpbGl0eUNoYW5nZUV2ZW50IiwicmVtb3ZlRG9jdW1lbnRWaXNpYmlsaXR5Q2hhbmdlTGlzdGVuZXIiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwidmVuZG9yU3RvcCIsImluZGV4T2YiLCJzdWJzdHJpbmciXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUVBLFNBQVFBLGVBQVI7QUFDQSxTQUFRQyx1QkFBUjs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU8sU0FBU0MsMEJBQVQsQ0FBb0NDLEdBQXBDLEVBQXlDO0FBQzlDO0FBQ0EsTUFBTUMsbUJBQW1CLEdBQUdILHVCQUF1QixDQUNqREUsR0FEaUQsRUFFakQsaUJBRmlELEVBR2pELElBSGlELENBQW5EOztBQUtBLE1BQUlBLEdBQUcsQ0FBQ0MsbUJBQUQsQ0FBUCxFQUE4QjtBQUM1QixXQUFPRCxHQUFHLENBQUNDLG1CQUFELENBQVY7QUFDRDs7QUFFRDtBQUNBLE1BQU1DLFVBQVUsR0FBR0osdUJBQXVCLENBQUNFLEdBQUQsRUFBTSxRQUFOLEVBQWdCLElBQWhCLENBQTFDOztBQUNBLE1BQUlBLEdBQUcsQ0FBQ0UsVUFBRCxDQUFQLEVBQXFCO0FBQ25CLFdBQU9GLEdBQUcsQ0FBQ0UsVUFBRCxDQUFILEdBQWtCTCxlQUFlLENBQUNNLE1BQWxDLEdBQTJDTixlQUFlLENBQUNPLE9BQWxFO0FBQ0Q7O0FBRUQsU0FBT1AsZUFBZSxDQUFDTyxPQUF2QjtBQUNEOztBQUVEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTyxTQUFTQyxnQkFBVCxDQUEwQkwsR0FBMUIsRUFBK0I7QUFDcEMsU0FBT0QsMEJBQTBCLENBQUNDLEdBQUQsQ0FBMUIsSUFBbUNILGVBQWUsQ0FBQ08sT0FBMUQ7QUFDRDs7QUFFRDtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU8sU0FBU0UsbUNBQVQsQ0FBNkNOLEdBQTdDLEVBQWtETyxPQUFsRCxFQUEyRDtBQUNoRSxNQUFJLENBQUNQLEdBQUcsQ0FBQ1EsZ0JBQVQsRUFBMkI7QUFDekI7QUFDRDs7QUFDRCxNQUFNQyxxQkFBcUIsR0FBR0Msd0JBQXdCLENBQUNWLEdBQUQsQ0FBdEQ7O0FBQ0EsTUFBSVMscUJBQUosRUFBMkI7QUFDekJULElBQUFBLEdBQUcsQ0FBQ1EsZ0JBQUosQ0FBcUJDLHFCQUFyQixFQUE0Q0YsT0FBNUM7QUFDRDtBQUNGOztBQUVEO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTyxTQUFTSSxzQ0FBVCxDQUFnRFgsR0FBaEQsRUFBcURPLE9BQXJELEVBQThEO0FBQ25FLE1BQUksQ0FBQ1AsR0FBRyxDQUFDWSxtQkFBVCxFQUE4QjtBQUM1QjtBQUNEOztBQUNELE1BQU1ILHFCQUFxQixHQUFHQyx3QkFBd0IsQ0FBQ1YsR0FBRCxDQUF0RDs7QUFDQSxNQUFJUyxxQkFBSixFQUEyQjtBQUN6QlQsSUFBQUEsR0FBRyxDQUFDWSxtQkFBSixDQUF3QkgscUJBQXhCLEVBQStDRixPQUEvQztBQUNEO0FBQ0Y7O0FBRUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTRyx3QkFBVCxDQUFrQ1YsR0FBbEMsRUFBdUM7QUFDckMsTUFBTUUsVUFBVSxHQUFHSix1QkFBdUIsQ0FBQ0UsR0FBRCxFQUFNLFFBQU4sRUFBZ0IsSUFBaEIsQ0FBMUM7QUFDQSxNQUFNYSxVQUFVLEdBQUdYLFVBQVUsQ0FBQ1ksT0FBWCxDQUFtQixRQUFuQixDQUFuQjtBQUNBLFNBQU9ELFVBQVUsSUFBSSxDQUFDLENBQWYsR0FDSFgsVUFBVSxDQUFDYSxTQUFYLENBQXFCLENBQXJCLEVBQXdCRixVQUF4QixJQUFzQyxrQkFEbkMsR0FFSCxrQkFGSjtBQUdEIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgMjAxOSBUaGUgQU1QIEhUTUwgQXV0aG9ycy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTLUlTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7VmlzaWJpbGl0eVN0YXRlfSBmcm9tICcuL2NvbnN0YW50cy92aXNpYmlsaXR5LXN0YXRlJztcbmltcG9ydCB7Z2V0VmVuZG9ySnNQcm9wZXJ0eU5hbWV9IGZyb20gJy4vZG9tL3N0eWxlJztcblxuLyoqXG4gKiBAcGFyYW0geyFEb2N1bWVudH0gZG9jXG4gKiBAcmV0dXJuIHshVmlzaWJpbGl0eVN0YXRlfVxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0RG9jdW1lbnRWaXNpYmlsaXR5U3RhdGUoZG9jKSB7XG4gIC8vIE5ldyBBUEk6IGBkb2N1bWVudC52aXNpYmlsaXR5U3RhdGVgIHByb3BlcnR5LlxuICBjb25zdCB2aXNpYmlsaXR5U3RhdGVQcm9wID0gZ2V0VmVuZG9ySnNQcm9wZXJ0eU5hbWUoXG4gICAgZG9jLFxuICAgICd2aXNpYmlsaXR5U3RhdGUnLFxuICAgIHRydWVcbiAgKTtcbiAgaWYgKGRvY1t2aXNpYmlsaXR5U3RhdGVQcm9wXSkge1xuICAgIHJldHVybiBkb2NbdmlzaWJpbGl0eVN0YXRlUHJvcF07XG4gIH1cblxuICAvLyBPbGQgQVBJOiBgZG9jdW1lbnQuaGlkZGVuYCBwcm9wZXJ0eS5cbiAgY29uc3QgaGlkZGVuUHJvcCA9IGdldFZlbmRvckpzUHJvcGVydHlOYW1lKGRvYywgJ2hpZGRlbicsIHRydWUpO1xuICBpZiAoZG9jW2hpZGRlblByb3BdKSB7XG4gICAgcmV0dXJuIGRvY1toaWRkZW5Qcm9wXSA/IFZpc2liaWxpdHlTdGF0ZS5ISURERU4gOiBWaXNpYmlsaXR5U3RhdGUuVklTSUJMRTtcbiAgfVxuXG4gIHJldHVybiBWaXNpYmlsaXR5U3RhdGUuVklTSUJMRTtcbn1cblxuLyoqXG4gKiBSZXR1cm5zIHRoZSB2YWx1ZSBvZiBcImRvY3VtZW50LmhpZGRlblwiIHByb3BlcnR5LiBUaGUgcmVhc29ucyB3aHkgaXQgbWF5XG4gKiBub3QgYmUgdmlzaWJsZSBpbmNsdWRlIGRvY3VtZW50IGluIGEgbm9uLWFjdGl2ZSB0YWIgb3Igd2hlbiB0aGUgZG9jdW1lbnRcbiAqIGlzIGJlaW5nIHByZS1yZW5kZXJlZCB2aWEgbGluayB3aXRoIHJlbD1cInByZXJlbmRlclwiLlxuICogQHBhcmFtIHshRG9jdW1lbnR9IGRvY1xuICogQHJldHVybiB7Ym9vbGVhbn1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGlzRG9jdW1lbnRIaWRkZW4oZG9jKSB7XG4gIHJldHVybiBnZXREb2N1bWVudFZpc2liaWxpdHlTdGF0ZShkb2MpICE9IFZpc2liaWxpdHlTdGF0ZS5WSVNJQkxFO1xufVxuXG4vKipcbiAqIEBwYXJhbSB7IURvY3VtZW50fSBkb2NcbiAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gaGFuZGxlclxuICovXG5leHBvcnQgZnVuY3Rpb24gYWRkRG9jdW1lbnRWaXNpYmlsaXR5Q2hhbmdlTGlzdGVuZXIoZG9jLCBoYW5kbGVyKSB7XG4gIGlmICghZG9jLmFkZEV2ZW50TGlzdGVuZXIpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgY29uc3QgdmlzaWJpbGl0eUNoYW5nZUV2ZW50ID0gZ2V0VmlzaWJpbGl0eUNoYW5nZUV2ZW50KGRvYyk7XG4gIGlmICh2aXNpYmlsaXR5Q2hhbmdlRXZlbnQpIHtcbiAgICBkb2MuYWRkRXZlbnRMaXN0ZW5lcih2aXNpYmlsaXR5Q2hhbmdlRXZlbnQsIGhhbmRsZXIpO1xuICB9XG59XG5cbi8qKlxuICogQHBhcmFtIHshRG9jdW1lbnR9IGRvY1xuICogQHBhcmFtIHtmdW5jdGlvbigpfSBoYW5kbGVyXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZW1vdmVEb2N1bWVudFZpc2liaWxpdHlDaGFuZ2VMaXN0ZW5lcihkb2MsIGhhbmRsZXIpIHtcbiAgaWYgKCFkb2MucmVtb3ZlRXZlbnRMaXN0ZW5lcikge1xuICAgIHJldHVybjtcbiAgfVxuICBjb25zdCB2aXNpYmlsaXR5Q2hhbmdlRXZlbnQgPSBnZXRWaXNpYmlsaXR5Q2hhbmdlRXZlbnQoZG9jKTtcbiAgaWYgKHZpc2liaWxpdHlDaGFuZ2VFdmVudCkge1xuICAgIGRvYy5yZW1vdmVFdmVudExpc3RlbmVyKHZpc2liaWxpdHlDaGFuZ2VFdmVudCwgaGFuZGxlcik7XG4gIH1cbn1cblxuLyoqXG4gKiBAcGFyYW0geyFEb2N1bWVudH0gZG9jXG4gKiBAcmV0dXJuIHs/c3RyaW5nfVxuICovXG5mdW5jdGlvbiBnZXRWaXNpYmlsaXR5Q2hhbmdlRXZlbnQoZG9jKSB7XG4gIGNvbnN0IGhpZGRlblByb3AgPSBnZXRWZW5kb3JKc1Byb3BlcnR5TmFtZShkb2MsICdoaWRkZW4nLCB0cnVlKTtcbiAgY29uc3QgdmVuZG9yU3RvcCA9IGhpZGRlblByb3AuaW5kZXhPZignSGlkZGVuJyk7XG4gIHJldHVybiB2ZW5kb3JTdG9wICE9IC0xXG4gICAgPyBoaWRkZW5Qcm9wLnN1YnN0cmluZygwLCB2ZW5kb3JTdG9wKSArICdWaXNpYmlsaXR5Y2hhbmdlJ1xuICAgIDogJ3Zpc2liaWxpdHljaGFuZ2UnO1xufVxuIl19
// /Users/mszylkowski/src/amphtml/src/core/document-visibility.js