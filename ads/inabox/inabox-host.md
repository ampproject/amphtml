<!---
Copyright 2016 The AMP HTML Authors. All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS-IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

# SDK integration for AMPHTML ad
One goal of AMPHTML ad is for advertisers to create once and use every where.
This guide provides details about how an ad network can join us to serve and render
AMPHTML ad in various environment, for example regular web & native 
mobile apps.

## Terminologies

###### AMPHTML ad
Ad creatives that are written following the
 [AMPHTML ad spec](https://amp.dev/documentation/guides-and-tutorials/learn/a4a_spec).
 
###### inabox
This term describes the situation that an AMPHTML ad is being served
on an non-AMP page inside an iframe embed or in a WebView for native
mobile apps. This is very different from how AMPHTML ad gets rendered
on an AMP page, as in which case, more sources sharing between the 

###### host
The host is the web page or native mobile app that the ad is being 
served on.

###### friendly iframe
An iframe on the host page that has the same origin, so that it has
full access to the host page content.

###### foreign iframe
An iframe on the host page that has different origin, so it can only
communicate to the host page via postMessage API.

## Web SDK (ads tag) integration
In this case, AMPHTML ad is rendered inside an iframe. It can be either
a friendly iframe, or a foreign iframe. 

##### Friendly iframe
This is the simple way for ads tag integration. It requires zero to 
little work. Because AMPHTML is trustful & secure, it 
can be put inside a friendly iframe without worrying it hijacking the page
and ruining the end user experience. Meantime, friendly iframe rendering
in general requires less browser resources than foreign iframe rendering,
which not only brings performance increase but also revenue gain. One 
thing to keep in mind though is that the ad network should have their own 
mechanism to prevent pub
modifying the ad content or faking clicks. This is how Google Ad Manager 
is integrated.

Main work flow:
1. The ads tag makes an ad request.
1. The response contains a flag indicating it is an AMPHTML ad.
1. The ads tag creates a friendly iframe, and set the response content 
to the iframe using `srcdoc`.

In the 2nd step, if the ad is generated by a 3rd party, it's a good 
 idea to run it through an AMP validator to make sure it is valid AMP.

##### Foreign iframe
If the ad has to be put into a foreign iframe, the ads tag is
responsible to set a communication channel for the ad to complete various
tasks such as ad expansion or viewability tracking. A so called
host script provided by AMP is to be loaded in that case to fulfill the
requirements.

Main work flow:
1. The ads tags sets up a postMessage listener on host window.
1. The ads tag creates an iframe with `src` set to the ad request URL.
1. If the response is an AMPHTML ad, it will postMessage to the host 
window. The AMP runtime version number is included in the message.
1. The ads tag received the message then starts to load the 
corresponding host script: 
`https://cdn.ampproject.org/rtv/{version}/amp4ads-host-v0.js`
1. Before host script is loaded, ads tag is still responsible to queue 
up all coming AMP messages into a global array.
1. Once host script is fully loaded, ads tag can then hand over the job to
it to process the queued messages and listen for future messages.

A sample implementation of the above process can be found [here](../../../../examples/inabox-tag-integration.js).

## Mobile SDK integration
(Working in progress, stay tuned)
