version: 2.1

orbs:
  browser-tools: circleci/browser-tools@1.1.1
  win: circleci/windows@2.4.0

push_and_pr_builds: &push_and_pr_builds
  filters:
    branches:
      only:
        - master
        - /^amp-release-.*$/
        - /^pull\/.*$/

push_builds_only: &push_builds_only
  filters:
    branches:
      only:
        - master
        - /^amp-release-.*$/

executors:
  linux-large:
    machine:
      image: ubuntu-2004:202010-01
    resource_class: large
  linux-xlarge:
    machine:
      image: ubuntu-2004:202010-01
    resource_class: xlarge
  macos-large:
    macos:
      xcode: 12.3.0
    resource_class: large

commands:
  checkout_repo:
    steps:
      - checkout
      - run:
          name: 'Fetch Merge Commit'
          command: ./.circleci/fetch_merge_commit.sh
  linux_setup:
    steps:
      - browser-tools/install-chrome:
          replace-existing: true
      - run:
          name: 'Install Google Cloud SDK'
          command: |
            cd ~/
            curl -Ss --retry 5 https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-323.0.0-linux-x86_64.tar.gz | tar xz
            echo 'source ~/google-cloud-sdk/path.bash.inc' >> $BASH_ENV
      - run:
          name: 'Setup Storage'
          command: ./.circleci/setup-storage.sh
      - run:
          name: 'Configure Hosts'
          command: cat ./build-system/test-configs/hosts | sudo tee -a /etc/hosts
      - run:
          name: 'Install NVM'
          command: curl https://raw.githubusercontent.com/creationix/nvm/master/install.sh | bash
      - run:
          name: 'Install Node LTS'
          command: |
            nvm install 'lts/*'
            echo "export PATH=`which node`:$PATH" >> $BASH_ENV
  install_dependencies:
    steps:
      - run:
          name: 'Install Dependencies'
          command: |
            npm install --global gulp-cli
            npm ci
  install_firefox:
    steps:
      - browser-tools/install-firefox:
          version: latest

jobs:
  'Checks':
    executor:
      name: linux-large
    steps:
      - checkout_repo
      - linux_setup
      - install_dependencies
      - run:
          name: 'Checks'
          command: node build-system/pr-check/checks.js
  'Unminified Build':
    executor:
      name: linux-xlarge
    steps:
      - checkout_repo
      - linux_setup
      - install_dependencies
      - run:
          name: 'Unminified Build'
          command: node build-system/pr-check/unminified-build.js
  'Nomodule Build':
    executor:
      name: linux-xlarge
    steps:
      - checkout_repo
      - linux_setup
      - install_dependencies
      - run:
          name: 'Nomodule Build'
          command: node build-system/pr-check/nomodule-build.js
  'Module Build':
    executor:
      name: linux-xlarge
    steps:
      - checkout_repo
      - linux_setup
      - install_dependencies
      - run:
          name: 'Module Build'
          command: node build-system/pr-check/module-build.js
  'Bundle Size':
    executor:
      name: linux-large
    steps:
      - checkout_repo
      - linux_setup
      - install_dependencies
      - run:
          name: 'Bundle Size'
          command: node build-system/pr-check/bundle-size.js
  'Validator Tests':
    executor:
      name: linux-large
    steps:
      - checkout_repo
      - linux_setup
      - install_dependencies
      - run:
          name: 'Install Protobuf'
          command: pip3 install --user protobuf
      - run:
          name: 'Validator Tests'
          command: node build-system/pr-check/validator-tests.js
  'Visual Diff Tests':
    executor:
      name: linux-large
    steps:
      - checkout_repo
      - linux_setup
      - install_dependencies
      - run:
          name: 'Visual Diff Tests'
          command: node build-system/pr-check/visual-diff-tests.js
  'Unit Tests':
    executor:
      name: linux-large
    steps:
      - checkout_repo
      - linux_setup
      - install_dependencies
      - run:
          name: 'Unit Tests'
          command: node build-system/pr-check/unit-tests.js
  'Unminified Tests':
    executor:
      name: linux-large
    steps:
      - checkout_repo
      - linux_setup
      - install_dependencies
      - run:
          name: 'Unminified Tests'
          command: node build-system/pr-check/unminified-tests.js
  'Nomodule Tests':
    executor:
      name: linux-large
    steps:
      - checkout_repo
      - linux_setup
      - install_dependencies
      - run:
          name: 'Nomodule Tests'
          command: node build-system/pr-check/nomodule-tests.js
  'Module Tests':
    executor:
      name: linux-large
    steps:
      - checkout_repo
      - linux_setup
      - install_dependencies
      - run:
          name: 'Module Tests'
          command: node build-system/pr-check/module-tests.js
  'End-to-End Tests':
    executor:
      name: linux-large
    steps:
      - checkout_repo
      - linux_setup
      - install_dependencies
      - run:
          name: 'End-to-End Tests'
          command: node build-system/pr-check/e2e-tests.js
  'Firefox Tests':
    executor:
      name: linux-large
    steps:
      - checkout_repo
      - linux_setup
      - install_dependencies
      - install_firefox
      - run:
          name: 'Firefox Tests'
          command: node build-system/pr-check/cross-browser-tests.js
  'Safari Tests':
    executor:
      name: macos-large
    steps:
      - checkout_repo
      - install_dependencies
      - run:
          name: 'Safari Tests'
          command: node build-system/pr-check/cross-browser-tests.js
  'Edge and IE Tests':
    executor:
      name: win/default
      size: large
    steps:
      - checkout_repo
      - install_dependencies
      - run:
          name: 'Edge and IE Tests'
          command: node build-system/pr-check/cross-browser-tests.js
  'Performance Tests':
    executor:
      name: linux-xlarge
    steps:
      - checkout_repo
      - linux_setup
      - install_dependencies
      - run:
          name: 'Performance Tests'
          command: node build-system/pr-check/performance-tests.js
  'Experiment A Tests':
    executor:
      name: linux-xlarge
    steps:
      - checkout_repo
      - linux_setup
      - install_dependencies
      - run:
          name: 'Experiment A Tests'
          command: node build-system/pr-check/experiment-tests.js --experiment=experimentA
  'Experiment B Tests':
    executor:
      name: linux-xlarge
    steps:
      - checkout_repo
      - linux_setup
      - install_dependencies
      - run:
          name: 'Experiment B Tests'
          command: node build-system/pr-check/experiment-tests.js --experiment=experimentB
  'Experiment C Tests':
    executor:
      name: linux-xlarge
    steps:
      - checkout_repo
      - linux_setup
      - install_dependencies
      - run:
          name: 'Experiment C Tests'
          command: node build-system/pr-check/experiment-tests.js --experiment=experimentC

workflows:
  'CircleCI PR Check':
    jobs:
      - 'Checks':
          <<: *push_and_pr_builds
      - 'Unminified Build':
          <<: *push_and_pr_builds
      - 'Nomodule Build':
          <<: *push_and_pr_builds
      - 'Module Build':
          <<: *push_and_pr_builds
      - 'Bundle Size':
          <<: *push_and_pr_builds
          requires:
            - 'Nomodule Build'
            - 'Module Build'
      - 'Validator Tests':
          <<: *push_and_pr_builds
      - 'Visual Diff Tests':
          <<: *push_and_pr_builds
          requires:
            - 'Nomodule Build'
      - 'Unit Tests':
          <<: *push_and_pr_builds
      - 'Unminified Tests':
          <<: *push_and_pr_builds
          requires:
            - 'Unminified Build'
      - 'Nomodule Tests':
          <<: *push_and_pr_builds
          requires:
            - 'Nomodule Build'
      - 'Module Tests':
          <<: *push_and_pr_builds
          requires:
            - 'Nomodule Build'
            - 'Module Build'
      - 'End-to-End Tests':
          <<: *push_and_pr_builds
          requires:
            - 'Nomodule Build'
      - 'Firefox Tests':
          <<: *push_and_pr_builds
          requires:
            - 'Nomodule Build'
      - 'Safari Tests':
          <<: *push_and_pr_builds
      - 'Edge and IE Tests':
          <<: *push_and_pr_builds
      # TODO(wg-performance, #12128): This takes 30 mins and fails regularly.
      # - 'Performance Tests':
      #     <<: *push_builds_only
      #     requires:
      #       - 'Nomodule Build'
      - 'Experiment A Tests':
          <<: *push_builds_only
      - 'Experiment B Tests':
          <<: *push_builds_only
      - 'Experiment C Tests':
          <<: *push_builds_only
