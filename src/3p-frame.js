/**
 * Copyright 2015 The AMP HTML Authors. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS-IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/**
 * Cat ipsum dolor sit amet, knock dish off table head butt cant eat out of my own dish and sniff other cat's butt and hang jaw half open thereafter, or decide to want nothing to do with my owner today peer out window, chatter at birds, lure them to mouth. Munch, munch, chomp, chomp meowing non stop for food playing with balls of wool catty ipsum. Purr. Lounge in doorway all of a sudden cat goes crazy. Swipe at owner's legs. Sleep everywhere, but not in my bed caticus cuteicus yet purr scratch the postman wake up lick paw wake up owner meow meow. Scratch at fleas, meow until belly rubs, hide behind curtain when vacuum cleaner is on scratch strangers and poo on owners food fall asleep on the washing machine meow meow mama munch, munch, chomp, chomp scratch at the door then walk away and kitty power jump up to edge of bath, fall in then scramble in a mad panic to get out. Sleep on my human's head. Hell is other people missing until dinner time blow up sofa in 3 seconds bathe private parts with tongue then lick owner's face and lick butt and make a weird face attempt to leap between furniture but woefully miscalibrate and bellyflop onto the floor; what's your problem? i meant to do that now i shall wash myself intently. Stretch bite plants fight own tail chase imaginary bugs. Suddenly go on wild-eyed crazy rampage slap owner's face at 5am until human fills food dish. Hide when guests come over.

Rub against owner because nose is wet sleep everywhere, but not in my bed. As lick i the shoes leave dead animals as gifts, scratch at door to be let outside, get let out then scratch at door immmediately after to be let back in. Pee on walls it smells like breakfast ask to go outside and ask to come inside and ask to go outside and ask to come inside, yet good morning sunshine. Poop in a handbag look delicious and drink the soapy mopping up water then puke giant foamy fur-balls. If human is on laptop sit on the keyboard always hungry so eat prawns daintily with a claw then lick paws clean wash down prawns with a lap of carnation milk then retire to the warmest spot on the couch to claw at the fabric before taking a catnap rub face on owner and pooping rainbow while flying in a toasted bread costume in space. Meow roll over and sun my belly. Vommit food and eat it again see owner, run in terror but human is in bath tub, emergency! drowning! meooowww! making sure that fluff gets into the owner's eyes. Find empty spot in cupboard and sleep all day. Gnaw the corn cob meow to be let in. Knock over christmas tree i see a bird i stare at it i meow at it i do a wiggle come here birdy, russian blue yet jump on fridge, eat too much then proceed to regurgitate all over living room carpet while humans eat dinner, for just going to dip my paw in your coffee and do a taste test - oh never mind i forgot i don't like coffee - you can have that back now. Crusty butthole purr when give birth roll on the floor purring your whiskers off and eat a rug and furry furry hairs everywhere oh no human coming lie on counter don't get off counter, yet take a big fluffing crap üí©. Intrigued by the shower bite the neighbor's bratty kid. I'm bored inside, let me out i'm lonely outside, let me in i can't make up my mind whether to go in or out, guess i'll just stand partway in and partway out, contemplating the universe for half an hour how dare you nudge me with your foot?!?! leap into the air in greatest offense! bathe private parts with tongue then lick owner's face yet crash against wall but walk away like nothing happened. Scratch at the door then walk away stare at guinea pigs but human is washing you why halp oh the horror flee scratch hiss bite i will be pet i will be pet and then i will hiss for make meme, make cute face. Meow meow demand to have some of whatever the human is cooking, then sniff the offering and walk away and ùïÑùîºùïÜùïé i like big cats and i can not lie or chill on the couch table but i do no work yet get food, shelter, and lots of stuff just like man who lives with us and destroy the blinds. When in doubt, wash sniff other cat's butt and hang jaw half open thereafter yet furrier and even more furrier hairball for white cat sleeps on a black shirt pee in human's bed until he cleans the litter box. My left donut is missing, as is my right. This cat happen now, it was too purr-fect!!! steal mom's crouton while she is in the bathroom stare at wall turn and meow stare at wall some more meow again continue staring or ooooh feather moving feather!, lounge in doorway this human feeds me, i should be a god. Sweet beast need to chase tail. Ask to go outside and ask to come inside and ask to go outside and ask to come inside hiss and stare at nothing then run suddenly away but lick butt, and eat too much then proceed to regurgitate all over living room carpet while humans eat dinner so kitty kitty pussy cat doll, refuse to leave cardboard box but eat plants, meow, and throw up because i ate plants. Please stop looking at your phone and pet me walk on a keyboard. Cereal boxes make for five star accommodation somehow manage to catch a bird but have no idea what to do next, so play with it until it dies of shock for being gorgeous with belly side up but friends are not food. Howl uncontrollably for no reason catch mouse and gave it as a present i vomit in the bed in the middle of the night but cry louder at reflection kitty pounce, trip, faceplant you didn't see that no you didn't definitely didn't lick, lick, lick, and preen away the embarrassment wake up human for food at 4am, yet i see a bird i stare at it i meow at it i do a wiggle come here birdy. Groom yourself 4 hours - checked, have your beauty sleep 18 hours - checked, be fabulous for the rest of the day - checked cat milk copy park pee walk owner escape bored tired cage droppings sick vet vomit and what the heck just happened, something feels fishy, and steal the warm chair right after you get up yet be superior or to pet a cat, rub its belly, endure blood and agony, quietly weep, keep rubbing belly. Meow meow sleeping in the box so put toy mouse in food bowl run out of litter box at full speed .

Wake up wander around the house making large amounts of noise jump on top of your human's bed and fall asleep again lick the curtain just to be annoying so attack dog, run away and pretend to be victim relentlessly pursues moth kitty loves pigs annoy owner until he gives you food say meow repeatedly until belly rubs, feels good so cats are fats i like to pets them they like to meow back. Give me some of your food give me some of your food give me some of your food meh, i don't want it headbutt owner's knee leave dead animals as gifts. Fooled again thinking the dog likes me. Vommit food and eat it again ptracy need to check on human, have not seen in an hour might be dead oh look, human is alive, hiss at human, feed me hiss at vacuum cleaner but make muffins. Stinky cat time to go zooooom. Sleep on keyboard get poop stuck in paws jumping out of litter box and run around the house scream meowing and smearing hot cat mud all over, so all of a sudden cat goes crazy, yet damn that dog . Toy mouse squeak roll over meow and walk away twitch tail in permanent irritation hide head under blanket so no one can see but love to play with owner's hair tie fooled again thinking the dog likes me. Cat cat moo moo lick ears lick paws stand in front of the computer screen cat mojo leave buried treasure in the sandbox for the toddlers poop on couch. Pee in human's bed until he cleans the litter box sweet beast look at dog hiiiiiisssss rub face on owner.
 */

import {assertHttpsUrl, parseUrlDeprecated} from './url';
import {dev, devAssert, user, userAssert} from './log';
import {dict} from './utils/object';
import {getContextMetadata} from '../src/iframe-attributes';
import {getMode} from './mode';
import {internalRuntimeVersion} from './internal-version';
import {setStyle} from './style';
import {tryParseJson} from './json';
import {urls} from './config';

/** @type {!Object<string,number>} Number of 3p frames on the for that type. */
let count = {};

/** @type {string} */
let overrideBootstrapBaseUrl;

/** @const {string} */
const TAG = '3p-frame';

/**
 * Produces the attributes for the ad template.
 * @param {!Window} parentWindow
 * @param {!AmpElement} element
 * @param {string=} opt_type
 * @param {Object=} opt_context
 * @return {!JsonObject} Contains
 *     - type, width, height, src attributes of <amp-ad> tag. These have
 *       precedence over the data- attributes.
 *     - data-* attributes of the <amp-ad> tag with the "data-" removed.
 *     - A _context object for internal use.
 */
function getFrameAttributes(parentWindow, element, opt_type, opt_context) {
  const type = opt_type || element.getAttribute('type');
  userAssert(type, 'Attribute type required for <amp-ad>: %s', element);
  const sentinel = generateSentinel(parentWindow);
  let attributes = dict();
  // Do these first, as the other attributes have precedence.
  addDataAndJsonAttributes_(element, attributes);
  attributes = getContextMetadata(parentWindow, element, sentinel, attributes);
  attributes['type'] = type;
  Object.assign(attributes['_context'], opt_context);
  return attributes;
}

/**
 * Creates the iframe for the embed. Applies correct size and passes the embed
 * attributes to the frame via JSON inside the fragment.
 * @param {!Window} parentWindow
 * @param {!AmpElement} parentElement
 * @param {string=} opt_type
 * @param {Object=} opt_context
 * @param {{
 *   disallowCustom: (boolean|undefined),
 *   allowFullscreen: (boolean|undefined),
 *   initialIntersection: (IntersectionObserverEntry|undefined),
 * }=} options Options for the created iframe.
 * @return {!HTMLIFrameElement} The iframe.
 */
export function getIframe(
  parentWindow,
  parentElement,
  opt_type,
  opt_context,
  options = {}
) {
  const {
    disallowCustom = false,
    allowFullscreen = false,
    initialIntersection,
  } = options;
  // Check that the parentElement is already in DOM. This code uses a new and
  // fast `isConnected` API and thus only used when it's available.
  devAssert(
    parentElement['isConnected'] === undefined ||
      parentElement['isConnected'] === true,
    'Parent element must be in DOM'
  );
  const attributes = getFrameAttributes(
    parentWindow,
    parentElement,
    opt_type,
    opt_context
  );
  if (initialIntersection) {
    attributes['_context']['initialIntersection'] = initialIntersection;
  }

  const iframe = /** @type {!HTMLIFrameElement} */ (parentWindow.document.createElement(
    'iframe'
  ));

  if (!count[attributes['type']]) {
    count[attributes['type']] = 0;
  }
  count[attributes['type']] += 1;

  const ampdoc = parentElement.getAmpDoc();
  const baseUrl = getBootstrapBaseUrl(
    parentWindow,
    ampdoc,
    undefined,
    disallowCustom
  );
  const host = parseUrlDeprecated(baseUrl).hostname;
  // This name attribute may be overwritten if this frame is chosen to
  // be the master frame. That is ok, as we will read the name off
  // for our uses before that would occur.
  // @see https://github.com/ampproject/amphtml/blob/master/3p/integration.js
  const name = JSON.stringify(
    dict({
      'host': host,
      'type': attributes['type'],
      // https://github.com/ampproject/amphtml/pull/2955
      'count': count[attributes['type']],
      'attributes': attributes,
    })
  );

  iframe.src = baseUrl;
  iframe.ampLocation = parseUrlDeprecated(baseUrl);
  iframe.name = name;
  // Add the check before assigning to prevent IE throw Invalid argument error
  if (attributes['width']) {
    iframe.width = attributes['width'];
  }
  if (attributes['height']) {
    iframe.height = attributes['height'];
  }
  if (attributes['title']) {
    iframe.title = attributes['title'];
  }
  if (allowFullscreen) {
    iframe.setAttribute('allowfullscreen', 'true');
  }
  iframe.setAttribute('scrolling', 'no');
  setStyle(iframe, 'border', 'none');
  /** @this {!Element} */
  iframe.onload = function () {
    // Chrome does not reflect the iframe readystate.
    this.readyState = 'complete';
  };
  // Block synchronous XHR in ad. These are very rare, but super bad for UX
  // as they block the UI thread for the arbitrary amount of time until the
  // request completes.
  iframe.setAttribute('allow', "sync-xhr 'none';");
  const excludeFromSandbox = ['facebook'];
  if (!excludeFromSandbox.includes(opt_type)) {
    applySandbox(iframe);
  }
  iframe.setAttribute(
    'data-amp-3p-sentinel',
    attributes['_context']['sentinel']
  );
  return iframe;
}

/**
 * Copies data- attributes from the element into the attributes object.
 * Removes the data- from the name and capitalizes after -. If there
 * is an attribute called json, parses the JSON and adds it to the
 * attributes.
 * @param {!Element} element
 * @param {!JsonObject} attributes The destination.
 * visibleForTesting
 */
export function addDataAndJsonAttributes_(element, attributes) {
  const {dataset} = element;
  for (const name in dataset) {
    // data-vars- is reserved for amp-analytics
    // see https://github.com/ampproject/amphtml/blob/master/extensions/amp-analytics/analytics-vars.md#variables-as-data-attribute
    if (!name.startsWith('vars')) {
      attributes[name] = dataset[name];
    }
  }
  const json = element.getAttribute('json');
  if (json) {
    const obj = tryParseJson(json);
    if (obj === undefined) {
      throw user().createError(
        'Error parsing JSON in json attribute in element %s',
        element
      );
    }
    for (const key in obj) {
      attributes[key] = obj[key];
    }
  }
}

/**
 * Preloads URLs related to the bootstrap iframe.
 * @param {!Window} win
 * @param {!./service/ampdoc-impl.AmpDoc} ampdoc
 * @param {!./preconnect.PreconnectService} preconnect
 * @param {boolean=} opt_disallowCustom whether 3p url should not use meta tag.
 */
export function preloadBootstrap(win, ampdoc, preconnect, opt_disallowCustom) {
  const url = getBootstrapBaseUrl(win, ampdoc, undefined, opt_disallowCustom);
  preconnect.preload(ampdoc, url, 'document');

  // While the URL may point to a custom domain, this URL will always be
  // fetched by it.
  const scriptUrl = getMode().localDev
    ? getAdsLocalhost(win) + '/dist.3p/current/integration.js'
    : `${urls.thirdParty}/${internalRuntimeVersion()}/f.js`;
  preconnect.preload(ampdoc, scriptUrl, 'script');
}

/**
 * Returns the base URL for 3p bootstrap iframes.
 * @param {!Window} parentWindow
 * @param {!./service/ampdoc-impl.AmpDoc} ampdoc
 * @param {boolean=} opt_strictForUnitTest
 * @param {boolean=} opt_disallowCustom whether 3p url should not use meta tag.
 * @return {string}
 * @visibleForTesting
 */
export function getBootstrapBaseUrl(
  parentWindow,
  ampdoc,
  opt_strictForUnitTest,
  opt_disallowCustom
) {
  const customBootstrapBaseUrl = opt_disallowCustom
    ? null
    : getCustomBootstrapBaseUrl(parentWindow, ampdoc, opt_strictForUnitTest);
  return customBootstrapBaseUrl || getDefaultBootstrapBaseUrl(parentWindow);
}

/**
 * @param {string} url
 */
export function setDefaultBootstrapBaseUrlForTesting(url) {
  overrideBootstrapBaseUrl = url;
}

/**
 * @param {*} win
 */
export function resetBootstrapBaseUrlForTesting(win) {
  win.__AMP_DEFAULT_BOOTSTRAP_SUBDOMAIN = undefined;
}

/**
 * Returns the default base URL for 3p bootstrap iframes.
 * @param {!Window} parentWindow
 * @param {string=} opt_srcFileBasename
 * @return {string}
 */
export function getDefaultBootstrapBaseUrl(parentWindow, opt_srcFileBasename) {
  const srcFileBasename = opt_srcFileBasename || 'frame';
  if (getMode().localDev || getMode().test) {
    return getDevelopmentBootstrapBaseUrl(parentWindow, srcFileBasename);
  }
  // Ensure same sub-domain is used despite potentially different file.
  parentWindow.__AMP_DEFAULT_BOOTSTRAP_SUBDOMAIN =
    parentWindow.__AMP_DEFAULT_BOOTSTRAP_SUBDOMAIN ||
    getSubDomain(parentWindow);
  return (
    'https://' +
    parentWindow.__AMP_DEFAULT_BOOTSTRAP_SUBDOMAIN +
    `.${urls.thirdPartyFrameHost}/${internalRuntimeVersion()}/` +
    `${srcFileBasename}.html`
  );
}

/**
 * Function to return the development boostrap base URL
 * @param {!Window} parentWindow
 * @param {string} srcFileBasename
 * @return {string}
 */
export function getDevelopmentBootstrapBaseUrl(parentWindow, srcFileBasename) {
  return (
    overrideBootstrapBaseUrl ||
    getAdsLocalhost(parentWindow) +
      '/dist.3p/' +
      (getMode().minified
        ? `${internalRuntimeVersion()}/${srcFileBasename}`
        : `current/${srcFileBasename}.max`) +
      '.html'
  );
}

/**
 * @param {!Window} win
 * @return {string}
 */
function getAdsLocalhost(win) {
  let adsUrl = urls.thirdParty; // local dev with a non-localhost server
  if (adsUrl == 'https://3p.ampproject.net') {
    adsUrl = 'http://ads.localhost'; // local dev with a localhost server
  }
  return adsUrl + ':' + (win.location.port || win.parent.location.port);
}

/**
 * Sub domain on which the 3p iframe will be hosted.
 * Because we only calculate the URL once per page, this function is only
 * called once and hence all frames on a page use the same URL.
 * @param {!Window} win
 * @return {string}
 * @visibleForTesting
 */
export function getSubDomain(win) {
  return 'd-' + getRandom(win);
}

/**
 * Generates a random non-negative integer.
 * @param {!Window} win
 * @return {string}
 */
export function getRandom(win) {
  let rand;
  if (win.crypto && win.crypto.getRandomValues) {
    // By default use 2 32 bit integers.
    const uint32array = new Uint32Array(2);
    win.crypto.getRandomValues(uint32array);
    rand = String(uint32array[0]) + uint32array[1];
  } else {
    // Fall back to Math.random.
    rand = String(win.Math.random()).substr(2) + '0';
  }
  return rand;
}

/**
 * Returns the custom base URL for 3p bootstrap iframes if it exists.
 * Otherwise null.
 * @param {!Window} parentWindow
 * @param {!./service/ampdoc-impl.AmpDoc} ampdoc
 * @param {boolean=} opt_strictForUnitTest
 * @return {?string}
 */
function getCustomBootstrapBaseUrl(
  parentWindow,
  ampdoc,
  opt_strictForUnitTest
) {
  const meta = ampdoc.getMetaByName('amp-3p-iframe-src');
  if (!meta) {
    return null;
  }
  const url = assertHttpsUrl(meta, 'meta[name="amp-3p-iframe-src"]');
  userAssert(
    url.indexOf('?') == -1,
    '3p iframe url must not include query string %s in element %s.',
    url,
    meta
  );
  // This is not a security primitive, we just don't want this to happen in
  // practice. People could still redirect to the same origin, but they cannot
  // redirect to the proxy origin which is the important one.
  const parsed = parseUrlDeprecated(url);
  userAssert(
    (parsed.hostname == 'localhost' && !opt_strictForUnitTest) ||
      parsed.origin != parseUrlDeprecated(parentWindow.location.href).origin,
    '3p iframe url must not be on the same origin as the current document ' +
      '%s (%s) in element %s. See https://github.com/ampproject/amphtml' +
      '/blob/master/spec/amp-iframe-origin-policy.md for details.',
    url,
    parsed.origin,
    meta
  );
  return `${url}?${internalRuntimeVersion()}`;
}

/**
 * Applies a sandbox to the iframe, if the required flags can be allowed.
 * @param {!Element} iframe
 * @visibleForTesting
 */
export function applySandbox(iframe) {
  if (!iframe.sandbox || !iframe.sandbox.supports) {
    return; // Can't feature detect support
  }
  // If these flags are not supported by the UA we don't apply any
  // sandbox.
  const requiredFlags = [
    // This only allows navigation when user interacts and thus prevents
    // ads from auto navigating the user.
    'allow-top-navigation-by-user-activation',
    // Crucial because otherwise even target=_blank opened links are
    // still sandboxed which they may not expect.
    'allow-popups-to-escape-sandbox',
  ];
  // These flags are not feature detected. Put stuff here where either
  // they have always been supported or support is not crucial.
  const otherFlags = [
    'allow-forms',
    // We should consider turning this off! But since the top navigation
    // issue is the big one, we'll leave this allowed for now.
    'allow-modals',
    // Give access to raw mouse movements.
    'allow-pointer-lock',
    // This remains subject to popup blocking, it just makes it supported
    // at all.
    'allow-popups',
    // This applies inside the iframe and is crucial to not break the web.
    'allow-same-origin',
    'allow-scripts',
  ];
  // Not allowed
  // - allow-top-navigation
  // - allow-orientation-lock
  // - allow-pointer-lock
  // - allow-presentation
  for (let i = 0; i < requiredFlags.length; i++) {
    const flag = requiredFlags[i];
    if (!iframe.sandbox.supports(flag)) {
      dev().info(TAG, "Iframe doesn't support %s", flag);
      return;
    }
  }
  iframe.sandbox = requiredFlags.join(' ') + ' ' + otherFlags.join(' ');
}

/**
 * Returns a randomized sentinel value for 3p iframes.
 * The format is "%d-%d" with the first value being the depth of current
 * window in the window hierarchy and the second a random integer.
 * @param {!Window} parentWindow
 * @return {string}
 * @visibleForTesting
 */
export function generateSentinel(parentWindow) {
  let windowDepth = 0;
  for (let win = parentWindow; win && win != win.parent; win = win.parent) {
    windowDepth++;
  }
  return String(windowDepth) + '-' + getRandom(parentWindow);
}

/**
 * Resets the count of each 3p frame type
 * @visibleForTesting
 */
export function resetCountForTesting() {
  count = {};
}
