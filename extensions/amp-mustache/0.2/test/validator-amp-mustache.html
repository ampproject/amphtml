<!--
  Copyright 2015 The AMP HTML Authors. All Rights Reserved.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS-IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the license.
-->
<!--
  Test Description:
  This tests the logic for <template> tags and mustache variable replacements.
-->
<!doctype html>
<html âš¡>
<head>
  <meta charset="utf-8">
  <link rel="canonical" href="./regular-html-version.html">
  <meta name="viewport" content="width=device-width,minimum-scale=1">
  <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
  <script async src="https://cdn.ampproject.org/v0.js"></script>
</head>
<body>

<template type="amp-mustache">
  <{{not-actually-parsed-as-an-html-tag-so-allowed}}>
  <p title="{{allowed}}">{{allowed}}</p>
  <p {{notallowed}}></p>
  <p {{notallowed}}=0></p>
  <p [{{notallowed}}]=0></p>
  <p data-{notallowed}=0></p>
  <p data-{{notallowed}}=0></p>
  <p data-[{{notallowed}}]=0></p>
  <p data-{{{notallowed}}}=0></p>
  <p data-{{&notallowed}}=0></p>
  <p data-{{#notallowed}}=0></p>
  <p data-{{/notallowed}}=0></p>
  <p data-{{^notallowed}}=0></p>
  <p data-{{>notallowed}}=0></p>
  <p {{#notallowed}}class=foo{{/notallowed}}>
  <p {{#notallowed}}class{{/notallowed}}>
  <p title="{{{notallowed}}}"></p>
  <p title="{{&notallowed}}"></p>
  <p title="{{>notallowed}}"></p>
  <p data-title="{{{notallowed}}}"></p>
  <p data-title="{{&notallowed}}"></p>
  <p data-title="{{>notallowed}}"></p>

  <!-- now with some whitespace inside the mustache tags -->
  <{{ not-actually-parsed-as-an-html-tag-so-allowed }}>
  <p title="{{ allowed }}">{{ allowed }}</p>
  <p {{ notallowed }}></p>
  <p {{ notallowed }}=0></p>
  <p data-{{ notallowed }}=0></p>
  <p data-{{{ notallowed }}}=0></p>
  <p data-{{ &notallowed }}=0></p>
  <p data-{{ #notallowed }}=0></p>
  <p data-{{ /notallowed }}=0></p>
  <p data-{{ ^notallowed }}=0></p>
  <p data-{{ >notallowed }}=0></p>
  <p {{ #notallowed }}class=foo{{ /notallowed }}>
  <p {{ #notallowed }}class{{ /notallowed }}>
  <p title="{{{ notallowed }}}"></p>
  <p title="{{ &notallowed }}"></p>
  <p title="{{ >notallowed }}"></p>
  <p title="{{& notallowed }}"></p>
  <p title="{{> notallowed }}"></p>
  <p title="{{ & notallowed }}"></p>
  <p title="{{ > notallowed }}"></p>

  <!-- Note, this is allowed by the validator, but it is critical that it
       be sanitized by the runtime. If the runtime allowed this, then after
       rendering (assuming #off was null) we would have:
      <a href="javascript:alert('foo')"></a>
   -->
  <a href="{{#off}}"></a>
    {{/off}}javascript:alert('foo'){{#off}}
  <a href="{{/off}"></a>

  <!-- Allowed by the validator, but could lead to script execution
       depending on the value. -->
  <a href="{{foo}}"></a>
  <a href="java{{foo}}script:alert('foo')"></a>

  <!-- Really tricky example that the validator allows, but the runtime
       must handle. Essentially if {{foo}} is an empty string, this becomes
       a <script> tag, otherwise, it's just a harmless comment -->
  <!-- comment --{{foo}}><script><!-- -->

</template>

<template type="amp-mustache">
  <div>
    <template type="amp-mustache">
      Nested Template tags are not allowed.
    </template>
  </div>
</template>

<template type="amp-mustache">
  <div>
    <script type="text/plain" template="amp-mustache">
      Nested Template script tags are not allowed.
    </script>
  </div>
</template>

<!-- Inside a template, attribute value restrictions are relaxed. -->
<amp-audio src="https://example.com/audio" layout="fixed" autoplay="{{invalid}}">
<template type="amp-mustache">
<amp-audio src="https://example.com/audio" layout="fixed" autoplay="{{valid}}">
</template>

<!-- Since layout calculations follow a different code path, test that layouts
     validate. -->
<!-- See https://github.com/ampproject/amphtml/issues/2670 -->
<template type="amp-mustache">
<amp-img src="{{image.url}}" width={{image.width}} height={{image.height}}></amp-img>
</template>

<!-- Template with allowed custom delimiters -->
<template type="amp-mustache" custom-delimiters="#-,-#">
  Hello #-name-#
</template>

<!-- Template with unsupported custom delimiters -->
<template type="amp-mustache" custom-delimiters="<%,%>">
    Hello #-name-#
</template>

<!--
  Script template.
  Note that no errors are emmited for malformed mustache in script templates as the contents of
  script elements is interpreted as text as opposed to nodes which is not handled by the validaor.
-->
<script type="text/plain" template="amp-mustache">
  <{{not-actually-parsed-as-an-html-tag-so-allowed}}>
  <p title="{{allowed}}">{{allowed}}</p>
  <p {{notallowed}}></p>
  <p {{notallowed}}=0></p>
  <p [{{notallowed}}]=0></p>
  <p data-{notallowed}=0></p>
  <p data-{{notallowed}}=0></p>
  <p data-[{{notallowed}}]=0></p>
  <p data-{{{notallowed}}}=0></p>
  <p data-{{&notallowed}}=0></p>
  <p data-{{#notallowed}}=0></p>
  <p data-{{/notallowed}}=0></p>
  <p data-{{^notallowed}}=0></p>
  <p data-{{>notallowed}}=0></p>
  <p {{#notallowed}}class=foo{{/notallowed}}>
  <p {{#notallowed}}class{{/notallowed}}>
  <p title="{{{notallowed}}}"></p>
  <p title="{{&notallowed}}"></p>
  <p title="{{>notallowed}}"></p>
  <p data-title="{{{notallowed}}}"></p>
  <p data-title="{{&notallowed}}"></p>
  <p data-title="{{>notallowed}}"></p>

  <!-- now with some whitespace inside the mustache tags -->
  <{{ not-actually-parsed-as-an-html-tag-so-allowed }}>
  <p title="{{ allowed }}">{{ allowed }}</p>
  <p {{ notallowed }}></p>
  <p {{ notallowed }}=0></p>
  <p data-{{ notallowed }}=0></p>
  <p data-{{{ notallowed }}}=0></p>
  <p data-{{ &notallowed }}=0></p>
  <p data-{{ #notallowed }}=0></p>
  <p data-{{ /notallowed }}=0></p>
  <p data-{{ ^notallowed }}=0></p>
  <p data-{{ >notallowed }}=0></p>
  <p {{ #notallowed }}class=foo{{ /notallowed }}>
  <p {{ #notallowed }}class{{ /notallowed }}>
  <p title="{{{ notallowed }}}"></p>
  <p title="{{ &notallowed }}"></p>
  <p title="{{ >notallowed }}"></p>
  <p title="{{& notallowed }}"></p>
  <p title="{{> notallowed }}"></p>
  <p title="{{ & notallowed }}"></p>
  <p title="{{ > notallowed }}"></p>

  <!-- Note, this is allowed by the validator, but it is critical that it
       be sanitized by the runtime. If the runtime allowed this, then after
       rendering (assuming #off was null) we would have:
      <a href="javascript:alert('foo')"></a>
   -->
  <a href="{{#off}}"></a>
    {{/off}}javascript:alert('foo'){{#off}}
  <a href="{{/off}"></a>

  <!-- Allowed by the validator, but could lead to script execution
       depending on the value. -->
  <a href="{{foo}}"></a>
  <a href="java{{foo}}script:alert('foo')"></a>

  <!-- Really tricky example that the validator allows, but the runtime
       must handle. Essentially if {{foo}} is an empty string, this becomes
       a <script> tag, otherwise, it's just a harmless comment -->
  <!-- comment --{{foo}}><script><!-- -->

</script>

<!-- Inside a script template, attribute value restrictions are relaxed. -->
<amp-audio src="https://example.com/audio" layout="fixed" autoplay="{{invalid}}">
<script type="text/plain" template="amp-mustache">
<amp-audio src="https://example.com/audio" layout="fixed" autoplay="{{valid}}">
</script>

<!-- Script template with allowed custom delimiters -->
<script type="text/plain" template="amp-mustache" custom-delimiters="#-,-#">
  Hello #-name-#
</script>

<!-- Script template with unsupported custom delimiters -->
<script type="text/plain" template="amp-mustache" custom-delimiters="(&,&)">
  Hello #-name-#
</script>

<!-- Since layout calculations follow a different code path, test that layouts
     validate. -->
<!-- See https://github.com/ampproject/amphtml/issues/2670 -->
<script type="text/plain" template="amp-mustache">
<amp-img src="{{image.url}}" width={{image.width}} height={{image.height}}></amp-img>
</script>

<!-- Not descendant from a template, so mustache attribute values are OK -->
<p title="{{{allowed }}}"></p>
<p title="{{&allowed }}"></p>
<p title="{{>allowed }}"></p>

</body>
</html>
