language: node_js
sudo: false
dist: trusty
node_js:
  - "lts/*"
python:
  - "2.7"
notifications:
  email:
    recipients:
      - amp-build-cop@grotations.appspotmail.com
    on_success: change
    on_failure: change
  webhooks:
    - http://savage.nonblocking.io:8080/savage/travis
before_install:
  #- export CHROME_BIN=google-chrome-stable
  #- export DISPLAY=:99.0
  #- unset _JAVA_OPTIONS  # JVM heap sizes break closure compiler. #11203.
  #- sh -e /etc/init.d/xvfb start
  - curl -o- -L https://yarnpkg.com/install.sh | bash
  - export PATH="$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH"
  - pip install urllib3[secure]
  - pip install gsutil --user
branches:
  only:
    - master
    - release
    - canary
    - /^amp-release-.*$/
    - /^revert-.*$/
stages:
  - build
  - test
jobs:
  fast_finish: true
  allowed_failures:
    - stage: test
      name: "Remote (Sauce Labs) Tests"
      script:
        - node build-system/pr-check/remote-test.js
      after_script:
        - build-system/sauce_connect/stop_sauce_connect.sh
  include:
    - stage: build
      name: "Build"
      script:
        - node build-system/pr-check/build.js
    - stage: build
      name: "Checks" 
      script:        
        - node build-system/pr-check/checks.js
    - stage: build
      name: "Validator"        
      before_script:
        - pip install --user protobuf #required by validator
      script:        
        - node build-system/pr-check/validator.js
      addons:
        apt:
          packages:
            - protobuf-compiler
            - python-protobuf
    - stage: test
      name: "Dist, Bundle Size, Single Pass Tests"
      script:
        - node build-system/pr-check/dist-test.js
    - stage: test
      name: "Visual Diff Tests"
      script:
        - node build-system/pr-check/visual-diff-test.js
    - stage: test
      name: "Local Tests"
      before_install: 
        - export CHROME_BIN=google-chrome-stable
        - export DISPLAY=:99.0
        # Explicitly add yarn and gsutil install because this section overrides before_install parent section
        - curl -o- -L https://yarnpkg.com/install.sh | bash
        - export PATH="$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH"
        - pip install urllib3[secure]
        - pip install gsutil --user
      addons:
        chrome: stable
        hosts:
          - ads.localhost
          - iframe.localhost
          # Requested by some tests because they need a valid font host,
          # but should not resolve in tests.
          - fonts.googleapis.com
      script:
        - node build-system/pr-check/local-test.js
    - stage: test
      name: "Remote (Sauce Labs) Tests"
      script:
        - node build-system/pr-check/remote-test.js
      after_script:
        - build-system/sauce_connect/stop_sauce_connect.sh
cache:
  yarn: true
  directories:
    - build-system/tasks/visual-diff/node_modules
    - node_modules
    - validator/node_modules
    - validator/nodejs/node_modules
    - validator/webui/node_modules
    - sauce_connect
  pip: true
  bundler: true
